import{D as b}from"./DataFetcher-db08cad0-CbtmavCl.js";import"./ISave-da565824-B7iITgxx.js";import{a as C,O as R,D as h,k as E,U as f,m as y,P as M,S as T,N as A,h as U,K as O,A as P}from"./index-C7RI_ets.js";import{D as _}from"./index-b40568ff-7Mtm7E1e.js";import{C as w,P as L}from"./dataunit-fetcher-1b78797a-BxTYGdUG.js";import"./filter-item-type.enum-d45e026f-B41QHsvD.js";import"./form-config-fetcher-e623539b-pWgD_k-d.js";import"./constants-7b422de0-BRz2gykn.js";import{g as k}from"./GetSelectedRecordsIDsInfo-9fa41508-DTk189hP.js";import{I}from"./IFetchDataExporterParams-d73bed3d-DNdoYuuf.js";class F{constructor(e){this.lastAppliedFilters=[],this.FILTER_COLUMN_TERM="FILTRO_COLUNA_",this.onDataUnitAction=t=>{var i,r;if(t.type===C.DATA_SAVED||t.type===C.RECORDS_REMOVED){this.originalRecords=this.dataUnit.records;return}if(t.type!==C.DATA_LOADED)return;const s=this.getAppliedFilterNames((r=(i=t.payload)===null||i===void 0?void 0:i.filters)!==null&&r!==void 0?r:[]);this.originalRecords&&R.equals(s,this.lastAppliedFilters)||(this.originalRecords=t.payload.records,this.lastAppliedFilters=s)},this.dataUnit=e,this.dataUnit.records.length>0&&(this.originalRecords=this.dataUnit.records),this.dataUnit.subscribe(this.onDataUnitAction)}getAppliedFilterNames(e){return e.map(i=>i.name).filter(i=>!i.includes(this.FILTER_COLUMN_TERM))}getStaticOptions(e){return Promise.resolve(w.compileDistinctFromArray(e,this.dataUnit,this.originalRecords))}fetchData(e,t){return new Promise(i=>{const s=this.originalRecords.filter(n=>this.includesSearchTerm(n,t,e)).map(n=>this.buildFieldOption(n,t));i(this.removeDuplicatedOptions(s))})}sortItems(e,t){return F.defaultSorterMultSelectionOption(this.dataUnit,e,t)}buildFieldOption(e,t){return{value:this.buildValue(e,t),label:this.formatLabel(t,e[t]),check:!0}}buildValue(e,t){var i;let r=e[t];return((i=this.dataUnit.getField(t))===null||i===void 0?void 0:i.dataType)===h.OBJECT&&(r=r.value),r==null?void 0:r.toString()}removeDuplicatedOptions(e){const t=[];return e.forEach(i=>{t.find(({label:r})=>r===i.label)||t.push(i)}),t}includesSearchTerm(e,t,i){return this.buildLabel(t,e[t]).toLowerCase().includes(i.toLowerCase())}buildLabel(e,t){var i;const{dataType:r}=this.dataUnit.getField(e);return r===h.NUMBER?t==null?void 0:t.toString().replace(".",","):r===h.DATE?typeof t=="object"?(i=E.formatDate(this.dataUnit.valueFromString(e,t)))===null||i===void 0?void 0:i.toString():t==null?void 0:t.toString():r===h.OBJECT?`${t==null?void 0:t.value} - ${t==null?void 0:t.label}`:t==null?void 0:t.toString()}formatLabel(e,t){var i,r;const{userInterface:s,dataType:n}=this.dataUnit.getField(e);return n===h.DATE?typeof t=="object"?E.formatDate(this.dataUnit.valueFromString(e,t)):t==null?void 0:t.toString():n===h.NUMBER&&s!==f.DECIMALNUMBER?(i=parseInt(this.dataUnit.getFormattedValue(e,t)))===null||i===void 0?void 0:i.toString():(r=this.dataUnit.getFormattedValue(e,t))===null||r===void 0?void 0:r.toString()}static defaultSorterMultSelectionOption(e,t,i){const r=e.getField(t);return r==null?y.sortAlphabetically(i):i.sort((s,n)=>M.compareValues(r,s.value,n.value))}}class J{static assertDefaultSorting(e,t){e&&t&&(t.defaultSorting=e.columns.filter(i=>i.ascending!=null).sort((i,r)=>i.orderIndex-r.orderIndex).map(({name:i,ascending:r})=>{const{dataType:s}=t.getField(i);return{field:i,dataType:s,mode:r?O.ASC:O.DESC}}))}static parseCrudResults(e,t){Array.isArray(e)||(e=[e]);const i=[];for(const r of e){let s={fields:new Map};for(let n in r){let o=r[n];if(o.hasOwnProperty("$")&&s.fields.set(n,o.$),t)break}i.push(s)}return i.length>1?i:i[0]}static find(e,t,i,r=!0,s,n){const o="mge@crud.find";let d=[],u=[],m={},D=P.getContextValue("__SNK__APPLICATION__");if(t){if(!Array.isArray(t))throw new Error(D.messagesBuilder.getMessage("crudUtils.errorArray",null));t.forEach(a=>{d.push({name:a})})}if(i)for(const a in i)i.hasOwnProperty(a)&&u.push({nome:a,valor:i[a]});s&&(m={expression:{$:s}});let l={requestBody:{entity:{name:e,criterio:u,fields:{field:d},literalCriteria:m,orderby:n}}};return new Promise(a=>{b.get().callServiceBroker(o,JSON.stringify(l)).then(v=>{var p;let S=(p=v.entidades)===null||p===void 0?void 0:p.entidade;S||a(null);const c=this.parseCrudResults(S,r);a(c)})})}}class z{setDataUnit(e){this._dataUnit=e}setApplication(e){this._application=e}formatLabel(e,t){const{userInterface:i}=this._dataUnit.getField(e);return i===f.DATETIME?E.formatDate(this._dataUnit.valueFromString(e,t)):String(this._dataUnit.getFormattedValue(e,t))}async getStaticOptions(e,t){return e==null?Promise.resolve(void 0):Promise.resolve(await L.getDistinct(this._dataUnit,e,t==null?void 0:t.onlyLabel))}fetchData(e,t){return new Promise(i=>{this._application.executeSelectDistinct(this._dataUnit,t,e).then(r=>{i(r.map(s=>this._dataUnit.getField(t).userInterface===f.SEARCH?Object.assign(Object.assign({},JSON.parse(s)),{check:!0}):{value:s,label:this.formatLabel(t,s),check:!0}))})})}sortItems(e,t){return F.defaultSorterMultSelectionOption(this._dataUnit,e,t)}}class Y{setGrid(e){this._grid||(this._grid=e,this.refreshSelectedRows())}setDataState(e){this._dataState&&R.equals(e==null?void 0:e.metadataByRow,this._dataState.metadataByRow)||(this._dataState=e,this.refreshSelectedRows())}format(e,t,i){var r;if(T.isEmpty(e))return e;const s=(r=this._dataState)===null||r===void 0?void 0:r.metadataByRow.get(i),n=s==null?void 0:s.getProp("rm_precision",t.name);if(n||n===0)return A.format(e,n,n);if(t==null?void 0:t.props){const d=t==null?void 0:t.props.get("precision"),u=t==null?void 0:t.props.get("prettyPrecision");if(d!==void 0&&u!==void 0)return A.format(e,d,u)}return e}refreshSelectedRows(){var e;(e=this._grid)===null||e===void 0||e.refreshSelectedRows()}}class N{constructor(e,t){this.MAX_WIDTH_COD=60,this.MIN_WIDTH_COD=10,this.DEFAULT_FONT_SIZE=13,this.dataUnit=e,this.grid=t}async getColumnsMetadata(){var e;return this.columnsState=await((e=this.grid)===null||e===void 0?void 0:e.getColumnsState())||[],await this.buildColumnsMetadata(this.columnsState)}getColumnsState(){return this.columnsState}async buildColumnsMetadata(e){var t,i,r;const s=[];for(const n of e){if(n.hidden&&n.name!=="RECDESP")continue;const o=(t=this.dataUnit)===null||t===void 0?void 0:t.getField(n.name),d=await this.grid.getCustomValueFormatter(n.name),u=(o==null?void 0:o.userInterface)===f.SEARCH,m=60,D=u?"Cód. ":n.label;let l,a={id:n.name,label:D,width:u?D.length*this.DEFAULT_FONT_SIZE:n.width,type:o==null?void 0:o.dataType,userInterface:o==null?void 0:o.userInterface,customFormatter:d};if(u&&((i=o==null?void 0:o.properties)===null||i===void 0?void 0:i.DESCRIPTIONFIELD)!=null){const v=(r=o==null?void 0:o.properties)===null||r===void 0?void 0:r.DESCRIPTIONENTITY,p=o.properties.mergedFrom,S=`${o.properties.ENTITYNAME}.${o.properties.DESCRIPTIONFIELD}`;l={id:`${p?p+".":""}${S}`,label:v,width:u&&v?v.length*this.DEFAULT_FONT_SIZE-m:n.width,type:h.TEXT,userInterface:f.LONGTEXT,descriptionFrom:o.name};const c=this.getWidthByMetaData(n==null?void 0:n.width,a==null?void 0:a.width,l==null?void 0:l.width);a=Object.assign(Object.assign({},a),{width:c==null?void 0:c.codWidth}),l=Object.assign(Object.assign({},l),{width:c==null?void 0:c.descWidth,label:(l==null?void 0:l.label)||(n==null?void 0:n.label)})}s.push(a),l&&s.push(l)}return s||[]}getWidthByMetaData(e,t,i){const r=t+i,s=t/r,n=i/r;let o=Math.round(e*s),d=Math.round(e*n);return o>this.MAX_WIDTH_COD?(o=this.MAX_WIDTH_COD,d=e-this.MAX_WIDTH_COD):o<this.MIN_WIDTH_COD&&(o=this.MIN_WIDTH_COD,d=e-this.MIN_WIDTH_COD),{codWidth:o,descWidth:d}}}class Z{constructor(e,t,i){this.snkApplication=e,this.keyConfigEnableContinuousInsert=`${t}enableContinuousInsert${i||""}`}handleSaveConfig(e){return this.snkApplication.saveConfig(this.keyConfigEnableContinuousInsert,e)}getConfig(){return this.snkApplication.getConfig(this.keyConfigEnableContinuousInsert).then(e=>e?e=="true":!1).catch(()=>!1)}actionContinuousInsert(e,t){return{value:T.generateUUID(),label:e?"Desativar inclusão contínua":"Ativar inclusão contínua",enabled:!0,itemBuilder:()=>U("div",{class:"ez-dropdown__item-wrapper",onClick:t},U("span",{class:"ez-dropdown__item-label"},e?"Desativar inclusão contínua":"Ativar inclusão contínua"))}}}class K extends N{getSelectedNumber(){return this.dataUnit.getSelectionInfo().length}getTotalRecords(){var e,t,i;const{total:r}=((e=this.dataUnit)===null||e===void 0?void 0:e.getPaginationInfo())||{};return r??((i=(t=this.dataUnit)===null||t===void 0?void 0:t.records)===null||i===void 0?void 0:i.length)}getSelectedIDs(){return k(this.dataUnit)}getRecordID(){var e,t,i;return(i=(t=(e=this.dataUnit)===null||e===void 0?void 0:e.records)===null||t===void 0?void 0:t[0])===null||i===void 0?void 0:i.__record__id__}async getRecords(e){if(this.dataUnit.records.length===0)return[];switch(e){case I.ALL:return this.dataUnit.getSelectionInfo().getAllRecords();case I.SELECTION:return this.resolveRecordsFromSelection();case I.PAGE:return this.dataUnit.records;default:return this.resolveRecordsFromSelection()}}resolveRecordsFromSelection(){const e=this.dataUnit.getSelectionInfo(),t=e.isEmpty()||e.isAllRecords()?e.getAllRecords():e.records;return t.length?t:this.dataUnit.records}getHiddenOptions(){return[_.EXPORT_BY_EMAIL,_.EXPORT_PDF_TO_EMAIL,_.EXPORT_XLS_TO_EMAIL,_.EXPORT_PAGE_TO_PDF,_.EXPORT_PAGE_TO_XLS]}formatValue(e,t){const{id:i,descriptionFrom:r}=t,s=e[r||i];if(s==null)return"";if(r!=null)return s.label;if(this.dataUnit.getField(i).userInterface===f.SEARCH)return s.value;if(t.customFormatter){const o=this.getColumnsState().find(u=>t.id===u.name);return t.customFormatter.format(s,o,e.__record__id__)}return this.dataUnit.getFormattedValue(i,s)}}export{J as C,Y as R,z as S,K as a,Z as b,N as c};
//# sourceMappingURL=ClientSideExporterProvider-09dee1a3-DZ6Nj-fq.js.map

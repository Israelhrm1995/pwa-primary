import{D as u,e as P,U as _}from"./dataUnitInMemoryLoader-BjgoPaoq.js";import{A as $}from"./ApplicationContext-B_qAnYBt.js";import{d as R,D as h}from"./DataFetcher-db08cad0-B7lG84WQ.js";function z(t){const e=q(t.fieldsMetadata),i=t.descriptionField;return{label:t.entityDescription,name:i,fields:e}}function q(t){return!t||!t.length?[]:t.map(e=>({name:e.fieldName,label:e.description,dataType:M(e.type),userInterface:U(e),properties:F(e)}))}function F(t){const e={};return e.options=G(t),e.mask=A(t),e}function A(t){const e=t.uiType;return e?String(e).toLowerCase():void 0}function G(t){const e=t.options;if(!e)return;const i=[];return Object.keys(e).forEach(n=>{i.push({label:n,value:e[n]})}),i}function U(t){const e=t.options;if(e&&Object.keys(e).length>0)return _.OPTIONSELECTOR;if(t.type==="D")return _.DATE;if(t.type==="H")return _.DATETIME;if(t.type==="T")return _.TIME;if(t.type==="I")return _.INTEGERNUMBER}function M(t){switch(t){case"F":return u.NUMBER;case"D":case"H":return u.DATE;case"B":return u.OBJECT;case"I":return u.NUMBER;default:return u.TEXT}}function k(t){var e,i;return((i=(e=t.arvore)===null||e===void 0?void 0:e.no)!==null&&i!==void 0?i:[]).map(I)}function I(t){return Object.assign({id:t.codigo,label:`${t.caminho} - ${t.descricao}`,bold:t.analitico==="N",props:{analitico:t.analitico==="S"}},t.no&&{children:t.no.map(I)})}function J(t){var e,i;const n=[],o=(i=(e=t==null?void 0:t.gridConfig)===null||e===void 0?void 0:e.field)!==null&&i!==void 0?i:{};if(Object.keys(o).forEach(a=>n.push(o[a])),!!n.length)return{columns:n}}var L;(function(t){t[t.GRID=0]="GRID",t[t.CARDS=1]="CARDS",t[t.TREE=2]="TREE"})(L||(L={}));class b{constructor(){this._defaultPageSize=100,this._templateByQuery=new Map,this._searchListenersByDataUnit=new Map,this.buldTemplates()}buldTemplates(){this._templateByQuery.set("search",R.gql`query($entityName: String! $argument: String $criteria: InputSearchCriteria $options: InputSearchOptions) {
                $queryAlias$: search(entityName: $entityName argument: $argument criteria: $criteria options: $options){
                    value
                    label
                }
            }`)}loadSearchOptions(e,i,n,o){var a;const s=(i==null?void 0:i.toString().trim())||void 0;i=isNaN(Number(s))&&s?`%${s}`:s,n==null||n.params.forEach(d=>{d.dataType===u.OBJECT&&(d.value=JSON.stringify(d.value))});const r=this.applySearchListener(N.beforeSearch,e,i,n,o),l={argument:(r==null?void 0:r.argument)||i,entityName:e,criteria:(r==null?void 0:r.criteria)||n,options:(r==null?void 0:r.searchOptions)||o};return l.options&&((a=l.options)===null||a===void 0||delete a.dataUnitId),new Promise((d,f)=>{h.get().callGraphQL({values:l,query:this._templateByQuery.get("search")}).then(c=>{d(c)}).catch(c=>{f(c)})})}buildDescriptionCacheKey(e,i){return`${e}__${i}`}async loadByCode(e,i,n,o){const a=this.buildDescriptionCacheKey(e,i),s=b.DESCRIPTIONS_BY_CODE[a];if(s)return Promise.resolve(s);const r=await this.loadAdvancedSearch(e,void 0,n,o,i);return b.DESCRIPTIONS_BY_CODE[a]=r,r}loadAdvancedSearch(e,i,n,o,a){var s,r,l,d,f;const c=this.applySearchListener(N.beforeSearch,e,i,n,o),v={argument:(c==null?void 0:c.argument)||i,criteria:(c==null?void 0:c.criteria)||n,searchOptions:Object.assign(Object.assign({},o),c==null?void 0:c.searchOptions)},m="PesquisaSP.getSuggestion",C={query:{$:(s=v.criteria)===null||s===void 0?void 0:s.expression}};((l=(r=v.criteria)===null||r===void 0?void 0:r.params)===null||l===void 0?void 0:l.length)>0&&(C.params={param:v.criteria.params.map(g=>{let p=g.value;if(typeof p=="string"){const E=/CTX\{([^}]+)\}/.exec(p);E&&(p=$.getContextValue(`__SNK__APPLICATION__FILTER__CONTEXT(${E[1]})__`))}if(g.dataType===u.NUMBER&&p===void 0)throw new P("Falha detectada",`O campo ${g.name} deve ser informado.`);let y=g.dataType;return y===u.OBJECT?(p=p.value,y="S"):y=O(g.dataType),{$:p,type:y}})});const S=o!=null?Object.assign(Object.assign({},v==null?void 0:v.searchOptions),{pkFieldName:o.codeFieldName,label:o.descriptionFieldName,fieldName:o.codeFieldName,useDescriptionOptions:!1,enableRowsCounter:!0}):void 0,T={serviceName:m,requestBody:{criteria:Object.assign({entityName:e,compacted:!1,ignoreEntityCriteria:(d=S==null?void 0:S.ignoreEntityCriteria)!==null&&d!==void 0?d:!1,limit:this._defaultPageSize,orderByDesc:!1,externalCriteria:C,localEntityName:(f=v.searchOptions)===null||f===void 0?void 0:f.rootEntity},{options:S}),clientEventList:{clientEvent:[]}}};a==null?T.requestBody.criteria.query={$:i}:T.requestBody.criteria.pk={$:a};const D={urlParams:{quietMode:!0}};return new Promise((g,p)=>{h.get().callServiceBroker("PesquisaSP.getSuggestion",JSON.stringify(T),D).then(y=>g(y)).catch(y=>p(y))})}addSearchListener(e,i,n){var o;const a=this._searchListenersByDataUnit.get(i)||[],s=a.find(r=>r.entity===e);if(!s)this._searchListenersByDataUnit.set(i,[...a,{entity:e,listener:n}]);else for(const r of Object.keys(n))if(r in s.listener){if(((o=s.listener[r])===null||o===void 0?void 0:o.toString())===n[r].toString())continue;s.listener[r]=n[r]}return()=>{const r=a.filter(l=>l.entity!==e);if(!r.length){this._searchListenersByDataUnit.delete(i);return}this._searchListenersByDataUnit.set(i,r)}}applySearchListener(e,i,n,o,a){var s;const r=a==null?void 0:a.dataUnitId;if(!r)return;const l=(s=this._searchListenersByDataUnit.get(r))===null||s===void 0?void 0:s.find(({entity:f})=>f===i);if(!l)return;const{listener:d}=l;if(e in d)return d[e]({argument:n,criteria:o,searchOptions:a})}async loadPresentationConfig(e){var i,n;let o=w(e);const a=await h.get().callServiceBroker("SystemUtilsSP.getConf",JSON.stringify(o));return(n=(i=a==null?void 0:a.config)===null||i===void 0?void 0:i.lastUsedMode)!==null&&n!==void 0?n:"list"}async savePresentationConfig(e,i){let n=K(e,i);await h.get().callServiceBroker("SystemUtilsSP.saveConf",JSON.stringify(n))}async loadPesquisaGridConfig(e){const i=j(e),n=await h.get().callServiceBroker("GridConfig.getGridConfigFromJson",JSON.stringify(i));return J(n)}async savePesquisaGridConfig(e,i){const n=x(e,i);await h.get().callServiceBroker("GridConfig.saveGridConfigFromJSON",JSON.stringify(n))}async loadTree(e,i,n,o){const a=this.buildLoadTreeRequestBody(e,i,n,o),s=await h.get().callServiceBroker("Pesquisa.getStructuredData",JSON.stringify(a));return k(s)}buildLoadTreeRequestBody(e,i,n,o){var a,s;const r=this.applySearchListener(N.beforeSearch,e,i,n,o),l=(a=r==null?void 0:r.searchOptions)!==null&&a!==void 0?a:o,d=l==null?void 0:l.rootEntity,f=l==null?void 0:l.codeFieldName,c=(s=r==null?void 0:r.criteria)===null||s===void 0?void 0:s.expression,v=this.buildParams(r),m={nome:e,nomeInstanciaLocal:d,codeFieldName:f};return c&&(m.criterioLiteral={expressao:{$:c},parametro:v}),{instancia:m}}buildParams(e){var i,n;let o=(n=(i=e==null?void 0:e.criteria)===null||i===void 0?void 0:i.params)!==null&&n!==void 0?n:[];return o=o.map(a=>Object.assign(Object.assign({},a),{tipo:O(a.dataType),$:a.value})),o}}b.DESCRIPTIONS_BY_CODE={};function j(t){return{gridConfig:{configName:`GrdCfgHtml5:grdcfg.dynaform.pesquisa.${t}`}}}function x(t,e){const i={};return e==null||e.forEach((n,o)=>i[`field${o}`]=n),{gridConfig:{compactMode:!0,configName:`GrdCfgHtml5:grdcfg.dynaform.pesquisa.${t}`,field:i}}}function w(t){return{config:{chave:`PesquisaContent:${t}`,tipo:"T"}}}function K(t,e){return{config:{lastUsedMode:e,chave:`PesquisaContent:${t}`,tipo:"T"}}}function O(t){switch(t){case u.NUMBER:return"I";case u.DATE:return"D";default:return"S"}}var N;(function(t){t.beforeSearch="beforeSearch"})(N||(N={}));var B;(function(t){t.LINK_AND_FILE_AT_THE_SAME_TIME="LINK_AND_FILE_AT_THE_SAME_TIME",t.ANY_LINK_OR_FILE_FILLED="ANY_LINK_OR_FILE_FILLED",t.UNKNOWN="UNKNOWN",t.DESCRIPTION_CANNOT_BE_CHANGED="DESCRIPTION_CANNOT_BE_CHANGED"})(B||(B={}));export{b as P,B as S,L as a,z as b};

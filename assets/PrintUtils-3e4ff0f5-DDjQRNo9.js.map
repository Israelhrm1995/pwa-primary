{"version":3,"file":"PrintUtils-3e4ff0f5-DDjQRNo9.js","sources":["../../node_modules/@sankhyalabs/sankhyablocks/dist/esm/PrintUtils-3e4ff0f5.js"],"sourcesContent":["import { ApplicationContext, StringUtils } from '@sankhyalabs/core';\n\nclass PrintUtils {\n  constructor() {\n    this.appletImpressao = new AppletImpressao();\n    const application = ApplicationContext.getContextValue(\"__SNK__APPLICATION__\");\n    application.getDataFetcher().then(result => this.DataFetcher = result);\n  }\n  static getInstance() {\n    if (!PrintUtils.instance) {\n      PrintUtils.instance = new PrintUtils();\n    }\n    return PrintUtils.instance;\n  }\n  async processPendingPrinting(transactionId) {\n    await this.findPendingPrints(transactionId);\n  }\n  async findPendingPrints(transactionId) {\n    const requestBody = {\n      transactionIds: [\n        {\n          transactionId: {\n            $: transactionId\n          }\n        }\n      ]\n    };\n    Promise.resolve(this.DataFetcher).then(async (res) => {\n      res = await Promise.resolve(this.DataFetcher);\n      while (!res || !res.application) {\n        res = await Promise.resolve(this.DataFetcher);\n      }\n      const response = await res.application.callServiceBroker(PrintUtils.SERVICE_FIND_PENDING_PRINTS, JSON.stringify(requestBody));\n      const printJobData = this.parsePrintData(response);\n      const pendingPrints = await this.processDirectPrint(printJobData);\n      if (!pendingPrints.length)\n        return;\n      this.openSnkPrintSelector(Object.assign(Object.assign({}, printJobData), { pendingPrinters: pendingPrints }));\n    });\n  }\n  getLocalPrinters() {\n    const localPrinters = this.appletImpressao.findLocalPrinters();\n    const printers = [];\n    for (const printerName of localPrinters) {\n      printers.push({\n        nome: printerName,\n        printerUri: PrintUtils.LOCAL_SERVER_URI + printerName,\n        isLocal: true\n      });\n    }\n    return printers;\n  }\n  parsePrintData(payload) {\n    const pendingPrintJobData = payload.pendindPrintJobData;\n    if (!pendingPrintJobData)\n      return undefined;\n    let { printServers: { printServer }, pendingPrinters: { pendingPrinter } } = pendingPrintJobData;\n    printServer = printServer ? (Array.isArray(printServer) ? printServer : [printServer]) : [];\n    pendingPrinter = pendingPrinter ? (Array.isArray(pendingPrinter) ? pendingPrinter : [pendingPrinter]) : [];\n    const normalizedPrintServer = printServer.map(item => {\n      const printerList = Array.isArray(item.printerLocation) ? item.printerLocation : [item.printerLocation];\n      return {\n        printServerUri: item.printServerUri,\n        printerList: printerList.map(this.normalize)\n      };\n    });\n    const normalizedPendingPrinter = pendingPrinter.map(this.normalize);\n    return {\n      transactionId: pendingPrintJobData.transactionId.$,\n      printServers: normalizedPrintServer,\n      pendingPrinters: normalizedPendingPrinter,\n      printServerActive: pendingPrintJobData.printServers.printServerActive === 'true'\n    };\n  }\n  normalize(object) {\n    const normalizedObject = {};\n    Object.keys(object).forEach((key) => {\n      normalizedObject[key] = PrintUtils.ENCODED_PROPERTIES.includes(key) ? window.atob(object[key].$) : object[key].$;\n    });\n    return normalizedObject;\n  }\n  processLocalPrinting(localPrintings) {\n    const transactionIds = localPrintings.map((item) => item.transactionId);\n    this.appletImpressao.doLocalPrinting(transactionIds.join());\n  }\n  async openSnkPrintSelector(printJobData) {\n    let printSelector = document.querySelector('snk-print-selector');\n    if (!printSelector) {\n      printSelector = document.createElement('snk-print-selector');\n      printSelector.setAttribute('id', StringUtils.generateUUID());\n      window.document.body.appendChild(printSelector);\n    }\n    const { selectedPrinter, saveSubstitute } = await printSelector.openPrintSelector(printJobData);\n    if (!selectedPrinter)\n      return;\n    const params = {\n      transactionId: printJobData.transactionId,\n      pendingPrinters: printJobData.pendingPrinters,\n      printerUri: selectedPrinter.printerUri,\n      saveSubstitutePrinters: saveSubstitute\n    };\n    await this.saveSubstitutePrinter(params);\n  }\n  async saveSubstitutePrinter(params) {\n    const { transactionId, pendingPrinters, printerUri, saveSubstitutePrinters = false } = params;\n    const parsedPendingPrinters = pendingPrinters.map((item) => ({\n      printerUri: {\n        $: item.printerUri || printerUri\n      },\n      originalPrinterName: {\n        $: item.originalPrinterName\n      },\n      printJobCount: {\n        $: item.printJobCount\n      },\n      docType: {\n        $: item.docType\n      },\n      docTypeDescription: {\n        $: item.docTypeDescription\n      }\n    }));\n    const requestBody = {\n      substitutePrintersRequest: {\n        substitutePrinters: {\n          pendingPrinter: parsedPendingPrinters\n        },\n        saveSubstitutePrinters: {\n          $: saveSubstitutePrinters.toString()\n        },\n        transactionId: {\n          $: transactionId\n        }\n      }\n    };\n    Promise.resolve(this.DataFetcher).then(async (res) => {\n      await res.application.callServiceBroker(PrintUtils.SERVICE_SAVE_SUBSTITUTE_PRINTER, JSON.stringify(requestBody));\n    });\n  }\n  async processDirectPrint(printJobData) {\n    const isWCRunning = this.appletImpressao.checkWebConnection();\n    if (!isWCRunning) {\n      return [];\n    }\n    const localPrinters = this.getLocalPrinters();\n    if (!localPrinters.length)\n      return [];\n    const directPendingPrints = [];\n    const pendingPrints = printJobData.pendingPrinters.filter(item => {\n      const defaultPrinterName = this.getDefaultPrinterName(item.originalPrinterName);\n      const isDirectPrint = !!localPrinters.find(localPrinter => localPrinter.nome === defaultPrinterName) || this.isPrinterNameAFile(defaultPrinterName);\n      if (isDirectPrint) {\n        directPendingPrints.push(Object.assign(Object.assign({}, item), { printerUri: PrintUtils.LOCAL_SERVER_URI + defaultPrinterName }));\n        return false;\n      }\n      return true;\n    });\n    if (!directPendingPrints.length)\n      return pendingPrints;\n    const params = {\n      transactionId: printJobData.transactionId,\n      pendingPrinters: directPendingPrints\n    };\n    await this.saveSubstitutePrinter(params);\n    return pendingPrints;\n  }\n  getDefaultPrinterName(printerName) {\n    const defaultPrinterName = this.appletImpressao.getDefaultPrinter();\n    const isDefaultPrinterName = /padr[a√£]o/ig.test(printerName);\n    return (defaultPrinterName && isDefaultPrinterName) ? defaultPrinterName : printerName;\n  }\n  isPrinterNameAFile(printerName) {\n    const regExp = new RegExp(\"^(\\w:)?[/\\\\\\w\\s]+?\\.\\w{3}$\", \"mis\");\n    return regExp.test(printerName);\n  }\n}\nPrintUtils.SERVICE_FIND_PENDING_PRINTS = 'mge@PrintServiceSP.findPendingPrinters';\nPrintUtils.SERVICE_SAVE_SUBSTITUTE_PRINTER = 'mge@PrintServiceSP.saveSubstitutePrinter';\nPrintUtils.LOCAL_SERVER_URI = 'LOCAL:0/';\nPrintUtils.ENCODED_PROPERTIES = ['printerName', 'printerUri'];\nclass AppletImpressao {\n  constructor() {\n    this.appletImpressao = document.getElementById('centralNotaAppletImpressao');\n  }\n  checkWebConnection() {\n    if (!this.appletImpressao)\n      return false;\n    if (!this.appletImpressao.testRunningWC)\n      return false;\n    const isRunning = this.appletImpressao.testRunningWC();\n    return !!isRunning;\n  }\n  findLocalPrinters() {\n    if (!this.appletImpressao)\n      return [];\n    const localPrinters = this.appletImpressao.getLocalPrinters();\n    if (!localPrinters)\n      return [];\n    return localPrinters.split(\",\");\n  }\n  doLocalPrinting(transactionIds) {\n    if (!this.appletImpressao)\n      return;\n    this.appletImpressao.doLocalPrinting(transactionIds);\n  }\n  getDefaultPrinter() {\n    if (!this.appletImpressao)\n      return '';\n    return this.appletImpressao.getPrintDefault();\n  }\n}\n\nexport { PrintUtils as P };\n"],"names":["PrintUtils","AppletImpressao","ApplicationContext","result","transactionId","requestBody","res","response","printJobData","pendingPrints","localPrinters","printers","printerName","payload","pendingPrintJobData","printServer","pendingPrinter","normalizedPrintServer","item","printerList","normalizedPendingPrinter","object","normalizedObject","key","localPrintings","transactionIds","printSelector","StringUtils","selectedPrinter","saveSubstitute","params","pendingPrinters","printerUri","saveSubstitutePrinters","directPendingPrints","defaultPrinterName","localPrinter","isDefaultPrinterName"],"mappings":"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","x_google_ignoreList":[0]}
import{S as P}from"./dataUnitInMemoryLoader-CwDmnNwL.js";import{A as l}from"./ApplicationContext-B_qAnYBt.js";class i{constructor(){this.appletImpressao=new u,l.getContextValue("__SNK__APPLICATION__").getDataFetcher().then(r=>this.DataFetcher=r)}static getInstance(){return i.instance||(i.instance=new i),i.instance}async processPendingPrinting(t){await this.findPendingPrints(t)}async findPendingPrints(t){const r={transactionIds:[{transactionId:{$:t}}]};Promise.resolve(this.DataFetcher).then(async e=>{for(e=await Promise.resolve(this.DataFetcher);!e||!e.application;)e=await Promise.resolve(this.DataFetcher);const n=await e.application.callServiceBroker(i.SERVICE_FIND_PENDING_PRINTS,JSON.stringify(r)),a=this.parsePrintData(n),p=await this.processDirectPrint(a);p.length&&this.openSnkPrintSelector(Object.assign(Object.assign({},a),{pendingPrinters:p}))})}getLocalPrinters(){const t=this.appletImpressao.findLocalPrinters(),r=[];for(const e of t)r.push({nome:e,printerUri:i.LOCAL_SERVER_URI+e,isLocal:!0});return r}parsePrintData(t){const r=t.pendindPrintJobData;if(!r)return;let{printServers:{printServer:e},pendingPrinters:{pendingPrinter:n}}=r;e=e?Array.isArray(e)?e:[e]:[],n=n?Array.isArray(n)?n:[n]:[];const a=e.map(o=>{const s=Array.isArray(o.printerLocation)?o.printerLocation:[o.printerLocation];return{printServerUri:o.printServerUri,printerList:s.map(this.normalize)}}),p=n.map(this.normalize);return{transactionId:r.transactionId.$,printServers:a,pendingPrinters:p,printServerActive:r.printServers.printServerActive==="true"}}normalize(t){const r={};return Object.keys(t).forEach(e=>{r[e]=i.ENCODED_PROPERTIES.includes(e)?window.atob(t[e].$):t[e].$}),r}processLocalPrinting(t){const r=t.map(e=>e.transactionId);this.appletImpressao.doLocalPrinting(r.join())}async openSnkPrintSelector(t){let r=document.querySelector("snk-print-selector");r||(r=document.createElement("snk-print-selector"),r.setAttribute("id",P.generateUUID()),window.document.body.appendChild(r));const{selectedPrinter:e,saveSubstitute:n}=await r.openPrintSelector(t);if(!e)return;const a={transactionId:t.transactionId,pendingPrinters:t.pendingPrinters,printerUri:e.printerUri,saveSubstitutePrinters:n};await this.saveSubstitutePrinter(a)}async saveSubstitutePrinter(t){const{transactionId:r,pendingPrinters:e,printerUri:n,saveSubstitutePrinters:a=!1}=t,o={substitutePrintersRequest:{substitutePrinters:{pendingPrinter:e.map(s=>({printerUri:{$:s.printerUri||n},originalPrinterName:{$:s.originalPrinterName},printJobCount:{$:s.printJobCount},docType:{$:s.docType},docTypeDescription:{$:s.docTypeDescription}}))},saveSubstitutePrinters:{$:a.toString()},transactionId:{$:r}}};Promise.resolve(this.DataFetcher).then(async s=>{await s.application.callServiceBroker(i.SERVICE_SAVE_SUBSTITUTE_PRINTER,JSON.stringify(o))})}async processDirectPrint(t){if(!this.appletImpressao.checkWebConnection())return[];const e=this.getLocalPrinters();if(!e.length)return[];const n=[],a=t.pendingPrinters.filter(o=>{const s=this.getDefaultPrinterName(o.originalPrinterName);return!!e.find(c=>c.nome===s)||this.isPrinterNameAFile(s)?(n.push(Object.assign(Object.assign({},o),{printerUri:i.LOCAL_SERVER_URI+s})),!1):!0});if(!n.length)return a;const p={transactionId:t.transactionId,pendingPrinters:n};return await this.saveSubstitutePrinter(p),a}getDefaultPrinterName(t){const r=this.appletImpressao.getDefaultPrinter(),e=/padr[a√£]o/ig.test(t);return r&&e?r:t}isPrinterNameAFile(t){return new RegExp("^(w:)?[/\\ws]+?.w{3}$","mis").test(t)}}i.SERVICE_FIND_PENDING_PRINTS="mge@PrintServiceSP.findPendingPrinters";i.SERVICE_SAVE_SUBSTITUTE_PRINTER="mge@PrintServiceSP.saveSubstitutePrinter";i.LOCAL_SERVER_URI="LOCAL:0/";i.ENCODED_PROPERTIES=["printerName","printerUri"];class u{constructor(){this.appletImpressao=document.getElementById("centralNotaAppletImpressao")}checkWebConnection(){return!this.appletImpressao||!this.appletImpressao.testRunningWC?!1:!!this.appletImpressao.testRunningWC()}findLocalPrinters(){if(!this.appletImpressao)return[];const t=this.appletImpressao.getLocalPrinters();return t?t.split(","):[]}doLocalPrinting(t){this.appletImpressao&&this.appletImpressao.doLocalPrinting(t)}getDefaultPrinter(){return this.appletImpressao?this.appletImpressao.getPrintDefault():""}}export{i as P};
//# sourceMappingURL=PrintUtils-3e4ff0f5-Dyc0ptsy.js.map

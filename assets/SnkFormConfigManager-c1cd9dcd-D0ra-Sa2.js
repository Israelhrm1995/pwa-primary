import{C as d}from"./ConfigStorage-cf578768-BCbBaPvX.js";import{O as b,S as _}from"./dataUnitInMemoryLoader-CwDmnNwL.js";import{F as C}from"./form-config-fetcher-e623539b-ClsRvgut.js";import{T as v}from"./constants-7b422de0-BRz2gykn.js";class L{constructor(e,t,i,s){this._resourceID=t,this._configName=e,this._onConfigChange=i,this._dataUnit=s}addFormLegacyConfig(e){this._configName&&d.addFormLegacyConfig(this._configName,e)}async loadConfig(){return new Promise(e=>{d.loadFormConfig(this._configName,this._resourceID).then(t=>{t=this.buildFormMetadataUITabs(t),this.setConfig(t),e(t)}).catch(t=>{console.warn(t)})})}getEmptyConfig(){return this.buildFormMetadataUITabs({fields:[],emptyConfig:!0},!0)}saveConfig(e){const t=b.copy(e);return new Promise(i=>{d.saveFormConfig(e,this._configName,this._resourceID).then(s=>{this.setConfig(Object.assign(Object.assign({},t),s)),i(Object.assign(Object.assign({},t),s))})})}saveCardState(e,t,i){return new Promise(s=>{var f;const r=((f=this._config)===null||f===void 0?void 0:f.cardsState)||new Map,a=r.get(e);r.set(e,i==="fixed"?this.updateFixSequence(Object.assign(Object.assign({},a),{fixed:t.fixed}),r):Object.assign(Object.assign({},a),{[i]:t[i]})),d.saveCardState(r,this._configName,this._resourceID).then(n=>{this._config=Object.assign(Object.assign({},this._config),{cardsState:r}),s(n)})})}updateFixSequence(e,t){let i=-1;return Array.from(t.values()).forEach(s=>{s.fixed||delete e.fixSequence,s.fixSequence!=null&&(i=Math.max(i,s.fixSequence))}),e.fixed?e.fixSequence=i+1:delete e.fixSequence,e}hasConfig(e){var t;const i=e??this._config;return!!(i&&(!((t=i.fields)===null||t===void 0)&&t.length))}getFieldsList(e,t=!1){var i;const s=(i=this._config)===null||i===void 0?void 0:i.fields;return this.hasConfig()&&!t?s.map(({label:a,name:n,readOnly:c,visible:o,required:u,tab:h,group:m})=>{var g;if(a==null){const l=(g=this._dataUnit)===null||g===void 0?void 0:g.getField(n);return l?Object.assign(Object.assign({},l),{name:n??l.name,readOnly:c??l.readOnly,visible:o??l.visible,required:u??l.required,tab:h,group:m}):void 0}return{name:n,label:a,readOnly:c,visible:o,required:u,tab:h,group:m}}).filter(a=>this.isFieldVisible(a,e)):this._dataUnit?this._dataUnit.metadata.fields.filter(a=>this.isFieldVisible(a,e)).map(({label:a,name:n,readOnly:c,visible:o,required:u,properties:h})=>({label:a,name:n,readOnly:c,visible:o,required:u,tab:h==null?void 0:h.UITabName})):[]}isFieldVisible(e,t){if(e===void 0||e.visible===!1)return!1;if(t==null)return!0;const i=_.replaceAccentuatedCharsLower((e.label||e.name).toLocaleLowerCase()),s=_.replaceAccentuatedCharsLower(t.toLocaleLowerCase());return i.includes(s)}getFormConfig(e,t,i=!1){let s=this.getFieldsList(void 0,i);return t&&(s=s.filter(f=>{if(e){const r=e.getField(f.name);if(r&&r.readOnly)return!1}return!f.readOnly})),Object.assign(Object.assign({},this._config),{fields:s})}setConfig(e){this.isLoaded=!0;const{cardsState:t,summary:i,defaultVars:s}=this._config||{};this._config=Object.assign({},e),t&&(this._config.cardsState=t),i&&(this._config.summary=i),s&&(this._config.defaultVars=s),this._onConfigChange&&this._onConfigChange(Object.assign({},this._config))}getConfig(e,t){return this.getFormConfig(e,t??!0)}getFormConfigFetcher(){return this._formConfigFetcher==null&&(this._formConfigFetcher=new C),this._formConfigFetcher}async fetchUserAvailableConfigs(){return this._configName!=null?Promise.resolve(void 0):this.getFormConfigFetcher().fetchUserAvailableConfigs(this._configName,this._resourceID)}async fetchLegacyConfig(){return this.getFormConfigFetcher().fetchLegacyConfig(this._configName,this._resourceID)}async fetchDefaultConfig(){return this.getFormConfigFetcher().fetchDefaultConfig(this._configName,this._resourceID)}parseObjectList(e){return e?Array.isArray(e)?e:[e]:[]}buildFormMetadataUITabs(e,t=!1){var i;const s=this.hasConfig(e);if(!t&&(!this._dataUnit||s))return e;e=this.getFormConfig(this._dataUnit,!1,!0),e.tabs=this.parseObjectList(e.tabs),e.emptyConfig=!1,e.defaultConfiguration=!0;const f=this._dataUnit.metadata.fields;for(const r of f){const a=e.fields.find(o=>o.name===r.name),n=(i=r.properties)===null||i===void 0?void 0:i.UITabName;if(!n||n===v.main)continue;e.tabs.some(o=>o.label===n)||e.tabs.push({label:n,name:n,order:0,visible:!0}),a&&(a.tab=n)}return e}}export{L as S};

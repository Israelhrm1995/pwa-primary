import{Q as L,a0 as N,n as S,a1 as F,D as w,a2 as T,Z as B,U as A,A as M,S as x,a3 as Q,O as U}from"./index-CxFxc26b.js";import{d as E,D as R}from"./DataFetcher-db08cad0-DvO7h7yr.js";import{R as G}from"./ResourceIDUtils-a114189a-DvfZuq5X.js";const z="FILTRO_COLUNA_";class I{static getColumnFilters(e,t){return L.getColumnFilters(e,t)}static getFilterFunction(e,t){return L.getFilterFunction(e,t)}static compileDistinct(e,t){return L.compileDistinct(e,t)}static compileDistinctFromArray(e,t,n){return L.compileDistinctFromArray(e,t,n)}}class V{constructor(e){this._list=[],this._listCopy=[],this._listLastUpdate=0,this._listCopyLastUpdate=0,this._equalsFunction=e}async load(e,t,n,r){let s=[].concat(this._list);e!=null&&(s=this._list.filter(o=>e(o))),t!=null&&(s=s.sort(t));const i=s.length;if(r!=null){const o=n||0,a=r?o+r:s.length;s=s.slice(o,a)}return Promise.resolve({result:s,count:i})}async distict(e){const t=[];let n=!1;for(const r of this._list){const s=e(r);if(s!=null){if(s.value==null){n=!0;continue}t.push(s)}}return n&&t.push({key:"",value:null}),Promise.resolve(new Map(t.map(r=>[r.key,r.value])))}async push(e){this.updateList([...this._list,...e])}async clear(){this.updateList([])}async delete(e){const t=this._list.filter(n=>{for(const r of e)if(this._equalsFunction(n,r))return!1;return!0});this.updateList(t)}async update(e){const t=this._list.map(n=>{const r=e.find(s=>this._equalsFunction(n,s));return r??n});this.updateList(t)}async insert(e,t){const n=this._list.indexOf(e);if(n==-1){this.push(t);return}const r=this._list.slice(0,n).concat(t).concat(this._list.slice(n));this.updateList(r)}isOperating(){return!0}async isEmpty(){return Promise.resolve(this._list.length===0)}async count(){return Promise.resolve(this._list.length)}getFromCache(){return this._listLastUpdate>this._listCopyLastUpdate&&(this._listCopyLastUpdate=this._listLastUpdate,this._listCopy=U.copy(this._list)),this._listCopy}updateList(e){this._list=e,this._listLastUpdate=Date.now()}}class l{static setLoadingStatus(e,t){this._loadingStatus.set(e.name,t)}static isCacheEnabled(e){return!0}static cacheRecords(e,t,n,r){l.setLoadingStatus(e,r),l.isCacheEnabled(e)?this.getRepository(e).push(t):n&&this._repositories.delete(e.name)}static getSortingFunction(e,t){return Q.getSortingFunction(e,t)}static async getDistinct(e,t,n=!1){if(!l.isCacheEnabled(e))return Promise.resolve(I.compileDistinct(t,e));let r;const s=e.getLastLoadRequest();if(s!=null){const i=I.getColumnFilters(s.filters,t);r=I.getFilterFunction(e,Array.from(i.values()))}return new Promise((i,o)=>{l.getRepository(e).distict(a=>{if(r!=null&&!r(a))return;const d=a[t];if(d==null)return{key:null,value:null};let u=d.value!=null?d.value:d;return d!=null&&d.label&&n?{key:d==null?void 0:d.label,value:e.getFormattedValue(t,u)}:{key:e.getFormattedValue(t,d),value:u}}).then(a=>{if(a==null){i(void 0);return}i(Array.from(a.entries()).map(([d,u])=>({label:d,value:u,check:!0})))}).catch(a=>o(a))})}static async loadData(e,t,n){try{if(l.isCacheEnabled(e)){if(["EZ_GRID_LOADING_SOURCE",S.CHANGING_PAGE_LOADING_SOURCE,S.ALL_RECORDS_SELECTION_SOURCE].includes(t.source)&&!await l.getRepository(e).isEmpty())return l.loadFromCache(e,t);l.getRepository(e).clear().catch(()=>{})}return n(e,t)}catch(r){return console.error(r),Promise.reject(r)}}static insertRecords(e,t,n){l.isCacheEnabled(e)&&l.getRepository(e).insert(t,n)}static updateRecords(e,t){l.isCacheEnabled(e)&&l.getRepository(e).update(t)}static removeRecords(e,t){l.isCacheEnabled(e)&&l.getRepository(e).delete(t)}static async countRecords(e){return l.isCacheEnabled(e)?l.getRepository(e).count():Promise.resolve(0)}static getRepository(e){const t=e.name;return l._repositories.has(t)||l._repositories.set(t,new V((n,r)=>n.__record__id__===r.__record__id__)),l._repositories.get(t)}static async loadFromCache(e,t){return new Promise((n,r)=>{const s=I.getColumnFilters(t.filters,""),{limit:i,offset:o,sort:a}=t;l.getRepository(e).load(I.getFilterFunction(e,Array.from(s.values())),l.getSortingFunction(e,a),o,i).then(d=>{const u=l._loadingStatus.get(e.name),{count:m,result:h}=d,g=m==0?0:o+1,f=o+Math.min(h.length,i),_=o/i,y={count:m,currentPage:_,firstRecord:g,lastRecord:f,hasMore:u||f<m,total:u?void 0:m};n({records:h,paginationInfo:y})}).catch(d=>r(d))})}static getCachedRecords(e){return l.getRepository(e).getFromCache()}}l._repositories=new Map;l._loadingStatus=new Map;class q{constructor(e,t,n){this._dataUnitInMemoryLoader=new N(e,t,n)}get dataUnit(){return this._dataUnitInMemoryLoader.dataUnit}get records(){return this._dataUnitInMemoryLoader.records}set records(e){this._dataUnitInMemoryLoader.records=e}get metadata(){return this._dataUnitInMemoryLoader.metadata}set metadata(e){this._dataUnitInMemoryLoader.metadata=e}removeLoader(e,t){return this._dataUnitInMemoryLoader.removeLoader(e,t)}static getConvertedValue(e,t,n){return N.getConvertedValue(e,t,n)}}q.IN_MEMORY_DATA_UNIT_NAME=N.IN_MEMORY_DATA_UNIT_NAME;function j(c,e){var t,n;return((t=c[e])===null||t===void 0?void 0:t.value)!==void 0?(n=c[e])===null||n===void 0?void 0:n.value:c[e]}class H{canSlice(){return!1}processSortingSide(e,t,n){var r;const s=[],i=[];if(e.sort!=null){if(n.length===0)return{localSorting:e.sort,serverSorting:[]};for(const o of e.sort){const a=t.getField(o.field);((r=a==null?void 0:a.properties)===null||r===void 0?void 0:r.calculated)==="true"||(a==null?void 0:a.userInterface)===A.LONGTEXT?s.push(o):i.push(o)}}return{localSorting:s,serverSorting:i}}async load(e,t,n){var r,s;if(e.metadata==null)return Promise.resolve({records:[],loadingInfo:n});try{const i=(s=(r=t.filters)===null||r===void 0?void 0:r.filter(k=>!k.name.startsWith("FILTRO_COLUNA_")))!==null&&s!==void 0?s:[],{localSorting:o,serverSorting:a}=this.processSortingSide(t,e,i),d=this.getFieldsList(e),u="DatasetSP.loadRecords",m=this.buildRequestBody(u,d,e,t,n,a,i),h=n.quiet?{urlParams:{quietMode:"true"}}:void 0,{result:g,pagerID:f,askRowsLimit:_}=await R.get().callServiceBroker(u,m,h),y=this.processRecords(e,d,g),b=f!=null,v=n.count+y.length,P=e.hasNewRecord(),O=o.length>0,D=!b&&O;return D&&P&&e.setWaitingToReload(!0),Promise.resolve({records:y,loadingInfo:Object.assign(Object.assign({},n),{pagerId:f,loadingInProgress:b,total:b?void 0:v,count:v,needReload:D&&!P,askRowsLimit:_,hasLocalSorting:O})})}catch(i){return console.error(i),Promise.reject(i)}}async loadRowMetadata(e,t,n,r={}){try{const s="DatasetSP.loadRowMetadata",i=await this.buildRequestBodyLoadRowMetadata({snkDataUnit:e,fieldName:t,metadataName:n,serviceName:s,updatedFields:r});return await R.get().callServiceBroker(s,i)}catch(s){return console.error(s),Promise.reject(s)}}async buildRequestBodyLoadRowMetadata({snkDataUnit:e,serviceName:t,fieldName:n,metadataName:r,updatedFields:s}){const i=e.dataUnit,o=$.parseDataUnitName(i.name).entityName,d=(await e.getSelectedRecordsIDsInfo()).reduce((f,_)=>(f[_.name]=_.value,f),{}),u=i.getSelectedRecord(),m=i.metadata.fields.filter(({standAlone:f,name:_})=>!f&&!_.includes(".")).map(({name:f})=>f),h=m.reduce((f,_,y)=>{const b=j(u,_),v=j(s,_);return f[y]=v!==void 0?v:b,f},{}),g={serviceName:t,requestBody:{dataSetID:i.dataUnitId,entityName:o,standAlone:!1,metadataName:r,fieldName:n,fields:m,record:{pk:d,oldPk:d,values:h}}};return JSON.stringify(g)}getFieldsList(e){let t=["__record__id__","__record__label__"];return e.metadata.fields.forEach(n=>{n.standAlone||(t=t.concat(this.getFieldNames(n)))}),t}getStandAloneFieldsList(e){let t={};return e.metadata.fields.forEach(n=>{n.standAlone&&(t=Object.assign(Object.assign({},t),{[n.name]:{fieldType:n.dataType,userType:n.userInterface}}))}),t}getFieldNames(e){const t=this.getSearchDescriptionField(e);return t==null?e.name:[e.name,t]}buildRequestBody(e,t,n,r,s,i,o){const a=n.dataUnitId,d=n.name,u=$.parseDataUnitName(d).entityName,m=!!(r.limit||r.offset),h={serviceName:e,requestBody:{dataSetID:a,fields:t,entityName:u,pageNumber:s.pageNumber,totalRecordsCount:s.count,pagerID:s.pagerId,standAlone:!1,standAloneFieldsMD:Object.assign({__record__id__:{fieldType:"S",userType:"P"},__record__label__:{fieldType:"S",userType:"P"}},this.getStandAloneFieldsList(n)),tryJoinedFields:!0,parallelLoader:m,crudListener:`br.com.sankhya.bff.${this.getModuleName()}.BFFDataUnitDatasetAdapter`,txProperties:this.getTxProperties(n,r,i,o),useDefaultRowsLimit:!1}};return JSON.stringify(h)}getModuleName(){return M.getContextValue("__SNK__APPLICATION__").getModuleName().replace("-bff","")}getTxProperties(e,t,n,r){const s={"__DATA_UNIT_ADAPTER__[dataUnitName]":e.name};r.length!==0&&(s["__DATA_UNIT_ADAPTER__[criteria]"]=JSON.stringify(r)),n!=null&&n.length!==0&&(s["__DATA_UNIT_ADAPTER__[sorting]"]=JSON.stringify(n)),t.parentRecordId!=null&&(s["__DATA_UNIT_ADAPTER__[parentRecordId]"]=t.parentRecordId);const i=e.getGlobalLoaderProps();return i==null||i.size===0||Array.from(i.entries()).forEach(([o,a])=>{s[o]=a}),s}processRecords(e,t,n){return n.map(r=>{const s=r[r.length-1],i={__record__id__:r[0],__record__label__:r[1],__record__metadata__:s._rmd};return e.metadata.fields.forEach(o=>{i[o.name]=this.buildFieldValue(o,t,r)}),i})}buildFieldValue(e,t,n){const r=t.indexOf(e.name);if(r<0)return null;const s=n[r];if(x.isEmpty(s))return null;const i=this.getSearchDescriptionField(e);if(i!=null){const o=t.indexOf(i);if(o>=0)return{value:s,label:n[o]}}return e.userInterface===A.SEARCH?isNaN(Number(s))?s:Number(s):q.getConvertedValue(e,s)}getSearchDescriptionField(e){if(![A.SEARCH,A.SEARCHPLUS].includes(e.userInterface)||!e.properties)return;const{ENTITYNAME:t,mergedFrom:n,DESCRIPTIONFIELD:r}=e.properties;if(!x.isEmpty(r))return n!=null?`${n}.${t}.${r}`:`${t}.${r}`}}async function J(){return new Promise(c=>{const{checkboxContainer:e,checkbox:t}=X(),n=ne(c,t),r=Z();r.appendChild(K()),r.appendChild(e);const s=Y();s.appendChild(te(n,t,c)),s.appendChild(ee(n,c)),r.appendChild(s),n.appendChild(r),document.body.appendChild(n)})}function X(){const c=document.createElement("div");c.style.marginBottom="14px",c.style.display="flex",c.style.alignItems="center";const{checkbox:e,checkboxLabel:t}=W();return c.appendChild(e),c.appendChild(t),{checkboxContainer:c,checkbox:e}}function W(){const c=document.createElement("input");c.type="checkbox",c.id="loadAll";const e=document.createElement("label");return e.htmlFor="loadAll",e.textContent="Carregar tudo",e.style.marginLeft="5px",{checkbox:c,checkboxLabel:e}}function Y(){const c=document.createElement("div");return c.style.display="flex",c.style.flexDirection="row",c.style.justifyContent="end",c.style.gap="5px",c}function Z(){const c=document.createElement("div");return c.style.display="flex",c.style.flexDirection="column",c.style.fontFamily="var(--font-pattern, Roboto)",c.style.fontSize="var(--text--medium)",c}function K(){const c=document.createElement("div"),e=document.createElement("p"),t=document.createElement("p"),n=document.createElement("p");return n.style.fontWeight="var(--text-weight--large, 600)",e.textContent="Uma quantidade de registros muito grande está sendo carregada.",t.textContent="Recomendamos que a paginação seja cancelada e que seja criado um filtro para os registros.",n.textContent="Deseja cancelar o carregamento?",c.appendChild(e),c.appendChild(t),c.appendChild(n),c}function ee(c,e){const t=document.createElement("ez-button");return t.label="Cancelar paginação",t.size="medium",t.classList.add("ez-button--primary"),t.onclick=()=>{document.body.removeChild(c),e(C.CANCEL)},t}function te(c,e,t){const n=document.createElement("ez-button");return n.label="Continuar",n.size="medium",n.onclick=()=>{document.body.removeChild(c),t(e.checked?C.LOAD_ALL:C.CONTINUE)},n}function ne(c,e){const t=document.createElement("ez-popup");return t.opened=!0,t.size="x-small",t.ezTitle="Aviso",t.heightMode="auto",t.addEventListener("ezClosePopup",()=>{document.body.removeChild(t),c(e.checked?C.LOAD_ALL:C.CONTINUE)},{once:!0}),t.addEventListener("ezPopupAction",()=>{document.body.removeChild(t),c(C.CANCEL)},{once:!0}),t}var C;(function(c){c.CANCEL="CANCEL",c.CONTINUE="CONTINUE",c.LOAD_ALL="LOAD_ALL"})(C||(C={}));class p{constructor(){}static async debounce(e,t){const n=e.name;p._debouncingTimeouts[n]&&(clearTimeout(p._debouncingTimeouts[n]),delete p._debouncingTimeouts[n]),p._debouncingTimeouts[n]=setTimeout(()=>{delete p._debouncingTimeouts[n],t()},100)}static async loadData(e,t){return new Promise((n,r)=>{p.debounce(e,()=>{l.loadData(e,t,this.loadFromServer).then(s=>n(s)).catch(s=>r(s))})})}static getCachedRecords(e){return l.getCachedRecords(e)}static async loadFromServer(e,t,n){try{n=p.registryLoading(e,n);const r=await p.callLoader(e,t,n);if(r==null)return;const s=r.records,i=p.buildPaginationInfo(s.length,t,r.loadingInfo),o=i==null?s:s.slice(0,i.lastRecord);return Promise.resolve({records:o,paginationInfo:i})}catch(r){return console.error(r),Promise.reject(r)}}static async callLoader(e,t,n,r){r==null&&(r=new H);const s=await r.load(e,t,n),i=s.loadingInfo;if(p.isOldRequest(e,i))return Promise.resolve(void 0);if(this.handleCache(r,i,e,s.records),e.cancelPagination)return this.handlePaginationCanceled(e,s);if(this.canFinishPagination(e,i))return Promise.resolve(s);const o=Object.assign(Object.assign({},t),{offset:i.count});let a=this.buildNewLoadingInfo(i);if(this.canProceedPagination(i))return this.recallLoader(e,o,a,r,s);const d=await J();return d===C.CANCEL?this.handlePaginationCanceled(e,s):(d===C.LOAD_ALL&&(a=Object.assign(Object.assign({},a),{loadAllRecords:!0})),a=Object.assign(Object.assign({},a),{lastRowLimitAsked:a.count}),this.recallLoader(e,o,a,r,s))}static buildNewLoadingInfo(e){return Object.assign(Object.assign({},e),{pageNumber:(e.pageNumber||0)+1,quiet:!0})}static handleCache(e,t,n,r){const s=!e.canSlice()||t.count===0;l.cacheRecords(n,r,s,t.loadingInProgress)}static recallLoader(e,t,n,r,s){return this.callLoader(e,t,n,r).then(i=>p.afterLoadingPage(e,i.loadingInfo)).catch(i=>console.error(i)),Promise.resolve(s)}static canFinishPagination(e,t){return!l.isCacheEnabled(e)||!t.loadingInProgress}static canProceedPagination(e){const{count:t,askRowsLimit:n,loadAllRecords:r,lastRowLimitAsked:s}=e;if(r||!t||!n)return!0;const i=Number(n);if(t<i)return!0;const o=i+(s||0);return t<o}static handlePaginationCanceled(e,t){e.cancelPagination=!1;let n=t.loadingInfo;n=Object.assign(Object.assign({},n),{total:n.count,loadingInProgress:!1,pagerId:void 0,needReload:n.hasLocalSorting});const r={records:t.records,loadingInfo:n};return Promise.resolve(r)}static afterLoadingPage(e,t){l.setLoadingStatus(e,t.loadingInProgress);const n=e.getPaginationInfo();if(n==null)return;const r=t.count;if(t.loadingInProgress){e.updatePagination(Object.assign(Object.assign({},n),{count:r,loadingInProgress:!0}));return}if(t.needReload){e.gotoPage(0);return}e.updatePagination(Object.assign(Object.assign({},n),{total:r,count:r,loadingInProgress:!1}))}static registryLoading(e,t){return t==null&&(t={requestTime:new Date().getTime(),count:0}),p._requestTimeByDataUnit.set(e.name,t.requestTime),t}static isOldRequest(e,t){return p._requestTimeByDataUnit.get(e.name)>t.requestTime}static buildPaginationInfo(e,t,n){let{limit:r,offset:s}=t;if(!r)return;n.pageNumber===1&&(s=0);const{total:i,count:o,loadingInProgress:a,askRowsLimit:d}=n,u=o===0||e===0?0:s+1,m=s+Math.min(e,r);return{total:i,count:o,lastRecord:m,firstRecord:u,currentPage:s/r,hasMore:m<o||a,askRowsLimit:d}}}p._requestTimeByDataUnit=new Map;p._debouncingTimeouts={};var re=function(c,e){var t={};for(var n in c)Object.prototype.hasOwnProperty.call(c,n)&&e.indexOf(n)<0&&(t[n]=c[n]);if(c!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,n=Object.getOwnPropertySymbols(c);r<n.length;r++)e.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(c,n[r])&&(t[n[r]]=c[n[r]]);return t};const se=/dd:\/\/([^/]+)\/([^/?]+)/;class ${constructor(){this.templateByQuery=new Map,this.buldTemplates()}buldTemplates(){this.templateByQuery.set("fetchDataUnit",E.gql`query($name: String!) {
              $queryAlias$: fetchDataUnit(name: $name){
                name
                fields{
                  name
                  defaultValue
                  label
                  visible
                  standAlone
                  readOnly
                  required
                  dataType
                  userInterface
                  calculated
                  group
                  order
                  properties{
                    name
                    value
                  }
                  dependencies{
                    masterFields
                    type
                    expression
                  }
                }
                children{
                  name
                  label
                  links{
                    source
                    target
                  }
                }
              }
            }`),this.templateByQuery.set("saveData",E.gql`mutation($changes: [InputBatchChange!]!) {
            $queryAlias$: batchOperationDataUnit(changes: $changes){
              oldId
              id
              label
              ownerDataUnitName
              fields {
                name
                value
              }
            }
          }`),this.templateByQuery.set("fetchDataRecord",E.gql`query($dataunit: String! $recordID: [String!]) {
            $queryAlias$: fetchDataUnit(name: $dataunit){
              record(id: $recordID){
                id
                label
                fields {
                  name
                  value
                }
              }
            }
          }`),this.templateByQuery.set("fetchDistinctColumn",E.gql`query($dataUnit: String!, $fieldName: String!, $argument: String, $filters: [InputFilter], $parentRecordId: String) {
          $queryAlias$: selectDistinct(dataUnit: $dataUnit, fieldName: $fieldName, argument: $argument, filters: $filters, parentRecordId: $parentRecordId)
      }`)}static parseDataUnitName(e){if(e==null)return;const t=se.exec(e);if(t)return{entityName:t[1],resourceID:t[2]}}getDataUnit(e,t,n,r){l.applicationResourceID==null&&G.getResourceID().then(o=>l.applicationResourceID=o);const s=`dd://${e}/${t}${r?"/"+r:""}`,i=n!=null?n.getChildDataunit(s):new S(s);return i.metadataLoader=o=>this.loadMetadata(o),i.dataLoader=(o,a)=>p.loadData(o,a),i.saveLoader=(o,a)=>this.saveData(i,a),i.removeLoader=(o,a)=>this.removeRecords(o,a),i.recordLoader=(o,a)=>this.loadRecord(o,a),i.allRecordsLoader=o=>p.getCachedRecords(o),i}loadMetadata(e){return new Promise((t,n)=>{R.get().callGraphQL({values:{name:e.name},query:this.templateByQuery.get("fetchDataUnit")}).then(r=>{var s;const i={name:r.name,label:r.name,children:[...r.children],fields:[]};(s=r.fields)===null||s===void 0||s.forEach(o=>{let a;Array.isArray(o.properties)&&(a={},o.calculated&&(a.gridHeaderTooltip="Campos calculados não podem ser ordenados"),o.properties.forEach(d=>a[d.name]=d.value)),i.fields.push(Object.assign(Object.assign({},o),{properties:a}))}),i.fields.sort((o,a)=>o.order-a.order),t(i)}).catch(r=>{n(r)})})}loadSelectDistinct(e,t,n){const{parentRecordId:r,filters:s}=e.getLastLoadRequest()||{},i=s.filter(a=>a.name!==`${z}${t}`),o={dataUnit:e.name,argument:n,fieldName:t,parentRecordId:r,filters:i};return new Promise((a,d)=>{R.get().callGraphQL({values:o,query:this.templateByQuery.get("fetchDistinctColumn")}).then(u=>{a(u)}).catch(u=>{d(u)})})}addTransientProperties(e,t){const n=e.getGlobalLoaderProps();return n==null||n.size===0||(t==null&&(t={}),Array.from(n.entries()).forEach(([r,s])=>{t[`transient.${r}`]=s})),t}getUpdatingFields(e,t){if(t==null)return;const n=Object.assign({},t);return Object.keys(n).forEach(r=>{const s=e.getField(r);s!=null&&s.standAlone&&delete n[r]}),this.addTransientProperties(e,n)}saveData(e,t){const n=[],r=[],s=t.map(i=>{const{dataUnit:o,record:a,operation:d}=i,u=F.get(o),m=this.getUpdatingFields(u,i.updatingFields);let h;m!=null&&(h=Object.entries(m).map(([f,_])=>{const y=u.getField(f),b=y?y.dataType:w.TEXT;return{fieldName:f,dataType:b,value:u.valueToString(f,_)}})),o===e.name&&(d===T.INSERT||d===T.COPY?r.push(a.__record__id__):n.push(a.__record__id__));const g={dataUnit:o,fields:h,operation:d,recordId:a.__record__id__};return i.sourceId&&(g.sourceId=i.sourceId),a.__parent__record__id__&&(g.parentRecordId=a.__parent__record__id__),g});return new Promise((i,o)=>{const a=s.map(d=>{var u=re(d,[]);return u});R.get().callGraphQL({values:{changes:a},query:this.templateByQuery.get("saveData")}).then(d=>{const u=[];d==null||d.forEach(m=>{const h={__record__id__:m.id,__record__label__:m.label,__owner__dataunit__name__:m.ownerDataUnitName},g=F.get(h.__owner__dataunit__name__)||e;m.oldId&&(h.__old__id__=m.oldId),m.fields.forEach(({name:f,value:_})=>{var y;const b=(y=g==null?void 0:g.valueFromString)===null||y===void 0?void 0:y.call(g,f,_);h[f]=b!==void 0?b:_}),u.push(h)}),this.updateCache(e,u,n,r),i(u)}).catch(d=>{o(d)})})}updateCache(e,t,n,r){const s=new Map(t.map(a=>[a.__old__id__||a.__record__id__,a])),i=r.map(a=>{const d=Object.assign({},s.get(a));return delete d.__old__id__,d});if(i.length>0){const a=e.records[0];l.insertRecords(e,a,i)}const o=n.map(a=>Object.assign({},s.get(a)));l.updateRecords(e,o)}getTransientInfo(e,t){const{records:n}=e.getSelectionInfo();return Object.entries(n.filter(r=>r.__record__id__==t)[0]).filter(([r])=>r.startsWith(B.DATA_UNIT_TRANSIENT_PREFIX_NAME)).map(([r,s])=>({fieldName:r,value:s,dataType:w.TEXT}))}removeRecords(e,t){const n=t.map(r=>({dataUnit:e.name,operation:T.DELETE,recordId:r,fields:this.getTransientInfo(e,r)}));return new Promise((r,s)=>{R.get().callGraphQL({values:{changes:n},query:this.templateByQuery.get("saveData")}).then(i=>{l.removeRecords(e,e.records.filter(o=>t.includes(o.__record__id__))),r(t)}).catch(i=>{s(i)})})}loadRecord(e,t){return new Promise((n,r)=>{R.get().callGraphQL({values:{recordID:t,dataunit:e.name},query:this.templateByQuery.get("fetchDataRecord")}).then(s=>{const i=[];s.record.forEach(o=>{const a={__record__id__:o.id,__record__label__:o.label};o.fields.forEach(({name:d,value:u})=>{a[d]=e.valueFromString(d,u)}),i.push(a)}),n(i)}).catch(s=>{r(s)})})}}export{I as C,$ as D,q as I,l as P,H as a,j as g};
//# sourceMappingURL=dataunit-fetcher-1b78797a-DBNOZpxi.js.map

import{b as x,d as S,e as C,j as N,k as q,i as j}from"./index-ChOtpOHD.js";import{A as B,S as A,h as H,E as O,f as M}from"./dataUnitInMemoryLoader-BjgoPaoq.js";import{A as K}from"./ApplicationContext-B_qAnYBt.js";import{K as G}from"./index-dokJR7Uh.js";import{b as $,S as k,f as W,a as J,L as V,D as X,c as Y}from"./search-column-e609d513-w1mB9xeu.js";import{F as L}from"./FormLayout-071d324c-B21b_KW2.js";import"./ApplicationUtils-eaf91331-DedxIlrs.js";import"./DialogType-54a62731-BI65OFfy.js";import"./CheckMode-bdb2ec19-B2adzS2d.js";const Q=/child\[([^\]]+)\]/,Z=/\$\{.+\}/;class ee{constructor(){this._sheets=new Map,this._requiredFields=[],this._cleanOnCopyFields=[],this._defaultValues={}}static getDetailName(t){const s=Q.exec(t);return s?s[1]:void 0}getSheet(t){return this._sheets.get(t)}getAllSheets(){return this._sheets}addSheet(t){this._sheets.set(t.name,t)}addRequiredFields(t){this._requiredFields=this._requiredFields.concat(t)}getRequiredFields(){return this._requiredFields}addCleanOnCopyFields(t){this._cleanOnCopyFields=this._cleanOnCopyFields.concat(t)}getCleanOnCopyFields(){return this._cleanOnCopyFields}addDefaultValues(t){return this._defaultValues=Object.assign(Object.assign({},this._defaultValues),t)}getDefaultValues(){const t={};return Object.entries(this._defaultValues).forEach(([s,i])=>{if(typeof i=="string"){const n=Z.exec(i);n&&(i=this.getDefaultVar(n[0]))}t[s]=i}),t}getDefaultVar(t){return t==="${data}"?M.getToday():t==="${datahora}"?M.getToday(!0):this._defaultVars?this._defaultVars.get(t):void 0}setDefaultVars(t){this._defaultVars=t}}const te=e=>{const t=e.metadata;let s;return t&&(s=t.fields.filter(n=>n.visible!==!1).map(n=>({name:n.name,defaultValue:n.defaultValue}))),{emptyConfig:!1,fields:s}},ie=(e,t,s=!1)=>{var i,n;(e==null||(e==null?void 0:e.emptyConfig)===!0)&&(e=te(t));const o=new Map,d=new Map,u=[],c=[],y={};(i=e==null?void 0:e.tabs)===null||i===void 0||i.forEach(r=>{!d.has(r.label)&&r.visible===!1&&d.set(r.label,r)}),(n=e==null?void 0:e.fields)===null||n===void 0||n.forEach(r=>{var f,b,v;if(r.visible!==!1){const a=se(r.tab||"__main",o);if(d.has(a.label))return;const l=t.getField(r.name),F=(l==null?void 0:l.visible)==null||(l==null?void 0:l.visible)===!0;if(l&&F&&a.visible){o.has(a)||o.set(a,[]);const h=Y(l,r);o.get(a).push(h),h.required&&u.push(r.name),((r.cleanOnCopy==null?(f=l.properties)===null||f===void 0?void 0:f.cleanOnCopy:r.cleanOnCopy)||!((b=l.properties)===null||b===void 0)&&b.cleanOnCopy)&&c.push(r.name);let _=r.defaultValue==null?(v=l.properties)===null||v===void 0?void 0:v.defaultValue:r.defaultValue;if(_&&_.value!=null){const{type:w,value:D}=_;if(w)if(w==="V")_=D;else try{const E=JSON.parse(D);E&&"value"in E?_=E:_=D}catch{}y[r.name]=_}}}});const p=new ee;if(p.setDefaultVars(e.defaultVars),s){const r=t.metadata;r!=null&&r.children!=null&&r.children.forEach(f=>{const{label:b,name:v,fields:a}=ne(f);o.set({name:v,label:b},a)})}return Array.from(o.entries()).sort(re).forEach(([r,f])=>{p.addSheet({label:r.label==="__main"?"Principal":r.label,name:r.name||r.label,fields:f})}),p.addRequiredFields(u),p.addCleanOnCopyFields(c),p.addDefaultValues(y),p},se=(e,t)=>(typeof e=="string"?Array.from(t.keys()).find(i=>i.label===e):e)||{label:e,visible:!0},re=(e,t)=>e[0].label=="__main"?-1:(e[0].order||1e4)-(t[0].order||1e4),ne=e=>({name:`child[${e.name}]`,label:e.label,fields:[]});function m(e){return"Minified Redux error #"+e+"; visit https://redux.js.org/Errors?code="+e+" for the full message or use the non-minified dev environment for full errors. "}var R=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}(),z=function(){return Math.random().toString(36).substring(7).split("").join(".")},P={INIT:"@@redux/INIT"+z(),REPLACE:"@@redux/REPLACE"+z()};function ae(e){if(typeof e!="object"||e===null)return!1;for(var t=e;Object.getPrototypeOf(t)!==null;)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}function oe(e,t,s){var i;if(typeof e!="function")throw new Error(m(2));var n=e,o=t,d=[],u=d,c=!1;function y(){u===d&&(u=d.slice())}function p(){if(c)throw new Error(m(3));return o}function r(a){if(typeof a!="function")throw new Error(m(4));if(c)throw new Error(m(5));var l=!0;return y(),u.push(a),function(){if(l){if(c)throw new Error(m(6));l=!1,y();var h=u.indexOf(a);u.splice(h,1),d=null}}}function f(a){if(!ae(a))throw new Error(m(7));if(typeof a.type>"u")throw new Error(m(8));if(c)throw new Error(m(9));try{c=!0,o=n(o,a)}finally{c=!1}for(var l=d=u,F=0;F<l.length;F++){var h=l[F];h()}return a}function b(a){if(typeof a!="function")throw new Error(m(10));n=a,f({type:P.REPLACE})}function v(){var a,l=r;return a={subscribe:function(h){if(typeof h!="object"||h===null)throw new Error(m(11));function T(){h.next&&h.next(p())}T();var _=l(T);return{unsubscribe:_}}},a[R]=function(){return this},a}return f({type:P.INIT}),i={dispatch:f,subscribe:r,getState:p,replaceReducer:b},i[R]=v,i}const le={};function de(e=le,t){switch(t.type){case g.METADATA_LOADED:return Object.assign(Object.assign({},e),{formMetadata:t.payload,currentSheet:void 0});case g.CHANGE_TAB:return Object.assign(Object.assign({},e),{currentSheet:t.payload});default:return e}}function ue(e){return{type:g.METADATA_LOADED,payload:e}}function ce(e){return{type:g.CHANGE_TAB,payload:typeof e=="string"?e:e.tabKey}}function U(e){return e.formMetadata}function fe(e){return e.currentSheet}function I(e){const t=fe(e);return t?e.formMetadata.getSheet(t):Array.from(e.formMetadata.getAllSheets().values())[0]}var g;(function(e){e.METADATA_LOADED="FORM/METADATA_LOADED",e.CHANGE_TAB="FORM/CHANGE_TAB"})(g||(g={}));const he=".sc-ez-form-h{display:flex;flex-direction:column;width:100%}.dynamic-content.sc-ez-form ez-collapsible-box.sc-ez-form{--ez-collapsible-box__header--padding-right:var(--space-small, 6px);--ez-collapsible-box__header--padding-left:var(--space-small, 6px)}",me=class{constructor(e){x(this,e),this.ezFormRequestClearFieldToFocus=S(this,"ezFormRequestClearFieldToFocus"),this.ezFormSetFields=S(this,"ezFormSetFields"),this.ezReady=S(this,"ezReady"),this.formItemsReady=S(this,"formItemsReady"),this._customEditors=new Map,this._application=K.getContextValue("__SNK__APPLICATION__"),this.onDataUnitAction=t=>{t.type===B.METADATA_LOADED&&this.processMetadata()},this._fieldsProps=new Map,this._singleColumn=!1,this.dataUnit=void 0,this.config=void 0,this.recordsValidator=void 0,this.fieldToFocus=void 0,this.onlyStaticFields=!1,this.useSearchField=!0,this.elementFocusSearchField=void 0}validate(){return this._dataBinder.validate()}async addCustomEditor(e,t,s){if(this._formView){this._formView.addCustomEditor(e,t,s);return}const i=new Map(this._customEditors);i.set(e,{customEditor:t,detailContext:s}),this._customEditors=i}observeConfig(){this.processMetadata()}async setFieldProp(e,t,s){const i=new Map(this._fieldsProps),n=this._fieldsProps.get(e);i.set(e,Object.assign(Object.assign({},n),{[t]:s})),this._fieldsProps=i}getDynamicContent(){var e;const t=U(this._store.getState());if(!t)return null;const s=Array.from(t.getAllSheets().values()),i=I((e=this._store)===null||e===void 0?void 0:e.getState());let n=[];if(s.length>1){const o=s.map((u,c)=>({tabKey:u.name,label:u.label,index:c}));n.push(C("ez-tabselector",{tabs:this.buildIdTabSelector(o),onEzChange:u=>this._store.dispatch(ce(u.detail)),selectedTab:i.name,"data-element-id":"selector"}))}return n=n.concat(this.buildFormContent(i)),n}buildFormContent(e){const t=e==null?void 0:e.fields;if(e==null)return;this.ezFormSetFields.emit(t);const s=`${A.replaceAccentuatedChars(A.toCamelCase(e==null?void 0:e.label),!1)}_selectorContainer`;return C("div",{class:"dynamic-content ez-box--no-outline","data-element-id":s,ref:i=>this._container=i,tabindex:"0"},C("ez-popover",{ref:i=>this._ezPopoverSearchField=i,overlayType:"none"},this.renderFieldColumn()),C("ez-form-view",{ref:i=>this._formView=i,class:"ez-row ez-padding-vertical--small",fields:t,singleColumn:this._singleColumn,selectedRecord:this.dataUnit.getSelectedRecord()}))}renderFieldColumn(){return this._fieldSearch!=null?this._fieldSearch:(this._fieldSearch=$({value:A.generateUUID(),label:V},({argument:e})=>this.fieldsOptionLoader(e),e=>this.onSelectField(e)),this._fieldSearch)}getFormFields(){var e;return(e=this.config)===null||e===void 0?void 0:e.fields}fieldsOptionLoader(e){const t=e==null?void 0:e.toLowerCase(),n=this.getFormFields().map(o=>{var d;return(d=this.dataUnit)===null||d===void 0?void 0:d.getField(o.name)}).filter(o=>{var d,u;return((d=o.name)===null||d===void 0?void 0:d.toLowerCase().includes(t))||((u=o.label)===null||u===void 0?void 0:u.toLowerCase().includes(t))}).map(o=>({value:o.name,label:o.label}));return Promise.resolve(n)}onSelectField(e){if(e==null||e.value==null){this.fieldToFocus="";return}this.fieldToFocus=e.value,this._ezPopoverSearchField.hide()}async initKeyboardManager(){var e,t;this._keyboardManager=new G({propagate:!1,element:(e=this.elementFocusSearchField)!==null&&e!==void 0?e:this._element}),this.useSearchField&&this._keyboardManager.bind(k,async()=>{if(!this._container||!this._ezPopoverSearchField)return;const s=this._container.getBoundingClientRect();await W(this._fieldSearch),this._ezPopoverSearchField.showUnder(this._container,{horizontalGap:s.width-J,verticalGap:s.height*-1})},{description:V,element:(t=this.elementFocusSearchField)!==null&&t!==void 0?t:this._element})}componentDidLoad(){this.initKeyboardManager()}processMetadata(){if(this.bindFields()&&this.dataUnit&&this._store){const e=ie(this.config,this.dataUnit);this._store.dispatch(ue(e))}}isStatic(){var e;return((e=this._staticFields)===null||e===void 0?void 0:e.length)>0}bindFields(){return!this.isStatic()||this.onlyStaticFields===!1}async componentWillLoad(){var e;this.dataUnit===void 0&&(this.dataUnit=new H("ez-form")),this.dataUnit.unsubscribe(this.onDataUnitAction),this.dataUnit.subscribe(this.onDataUnitAction),this._dataBinder=new X(this.dataUnit),this._store=oe(de),this._store.subscribe(()=>N(this)),this._staticFields=Array.from(this._element.querySelectorAll("[data-field-name]")),this.processMetadata();const t={dataUnit:this.dataUnit};O.addIDInfo(this._element,null,t);const s=await((e=this._application)===null||e===void 0?void 0:e.getLayoutFormConfig());this.setSingleColumn(s),this.registerNotifyListeners(s)}async setSingleColumn(e){if(!(e!=null&&e.config)){this._singleColumn=!0;return}this._singleColumn=e.config===L.CASCADE}async registerNotifyListeners(e){e&&e.onConfigChange(t=>{t===L.CASCADE?this._singleColumn=!0:this._singleColumn=!1})}componentDidRender(){const e=U(this._store.getState());e.addRequiredFields(this._staticFields.filter(t=>t.dataset.required).map(t=>t.dataset.fieldName)),this._dataBinder.bind(Array.from(this._element.querySelectorAll("[data-field-name]")),this.dataUnit.dataUnitId,e,this.recordsValidator),this.ezReady.emit(),this.handleFieldToFocus(),this.setCustomEditors(),this.setFieldsProps()}setCustomEditors(){if(this._formView)for(const[e,t]of this._customEditors)this._formView.addCustomEditor(e,t.customEditor,t.detailContext),this._customEditors.delete(e)}handleFieldToFocus(){var e;if(this.fieldToFocus==null)return;const t=I((e=this._store)===null||e===void 0?void 0:e.getState());(t==null?void 0:t.fields).some(i=>i.name===this.fieldToFocus)&&requestAnimationFrame(()=>{this._dataBinder.setFocus(this.fieldToFocus),this.ezFormRequestClearFieldToFocus.emit(),this.fieldToFocus=null})}setFieldsProps(){if(this._formView)for(const[e,t]of this._fieldsProps){for(const s in t)this._formView.setFieldProp(e,s,t[s]);this._fieldsProps.delete(e)}}disconnectedCallback(){var e;this.dataUnit.unsubscribe(this.onDataUnitAction),this._dataBinder.onDisconnectedCallback(),(e=this._keyboardManager)===null||e===void 0||e.unbindAllShortcutKeys()}buildIdTabSelector(e){return e&&e.forEach(t=>t[O.DATA_ELEMENT_ID_ATTRIBUTE_NAME]=A.toCamelCase(t.label)),e}render(){return C(q,null,this.isStatic()?null:this.getDynamicContent())}get _element(){return j(this)}static get watchers(){return{config:["observeConfig"]}}};me.style=he;export{me as ez_form};

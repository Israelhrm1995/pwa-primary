import{A as r,S as g,O as E,W as f,m as h,U as D}from"./dataUnitInMemoryLoader-CwDmnNwL.js";import{A as c}from"./ApplicationContext-B_qAnYBt.js";import{A as u}from"./ApplicationUtils-eaf91331-DedxIlrs.js";import{e as v}from"./index-CHxCopeG.js";const S=(o,e)=>{let{name:t,label:a,group:i}=Object.assign({},e),{readOnly:n,required:s}=Object.assign({},e),d,l;return o&&(a=a||o.label,t=t||o.name,s=o.required||(e==null?void 0:e.required),n=o.readOnly||(e==null?void 0:e.readOnly),d=o.properties,l=o.userInterface),{name:t,label:a,group:i,readOnly:n,required:s,props:d,userInterface:l||D.SHORTTEXT}};class C{constructor(e,t,a){this._dataUnit=e,this._validationSource=t,this._validator=a}validate(e=!0){return new Promise((t,a)=>{const i=this._dataUnit.getModifiedRecords();for(let n=0;n<i.length;n++){const s=i[n],d=[];let l=this.validateRequired(s);if(l&&!l.isValid&&d.push(l),this._validator&&(l=this._validator.validateRecord(s),l&&!l.isValid&&d.push(l)),d.length>0){if(!e&&d[0].invalidFields.length>0){this._validationSource.markAsInvalid(d[0].invalidFields[0],s.__record__id__),a();break}this.processValidationResult(d,s.__record__id__),a();break}}return t()})}validateRequired(e){const t=this._validationSource.getRequiredFields(),a=[];if(new Set(t).forEach(i=>{const n=e[i];if(n==null||n===""){const s=this._validationSource.getMessageForField(i,e.__record__id__);s?a.push({name:i,message:s}):a.push({name:i,message:"Essa informação é obrigatória"})}}),a.length>0)return{isValid:!1,invalidFields:a,infoMessage:"Há pelo menos um campo obrigatório não preenchido."}}processValidationResult(e,t){e.forEach(a=>{const i=a.invalidFields;if(this._dataUnit.savingCanceled(i,t),i&&i.forEach(n=>{this.markAsInvalid(n,t)}),a.infoMessage&&u.info(a.infoMessage),a.errorMessage){const{errorTitle:n,errorMessage:s}=a;u.error(n,s)}})}markAsInvalid(e,t){this._dataUnit.setInvalidField(e.name,e.message,t),this._validationSource.markAsInvalid(e,t)}}class L{constructor(e){this.onDataUnitEvent=t=>{var a;switch(t.type){case r.MULTIPLE_EDITION_CHANGED:this.clearInvalid(),this.updateAllFieldsValues();break;case r.DATA_LOADED:case r.DATA_SAVED:case r.RECORDS_REMOVED:case r.RECORDS_ADDED:case r.RECORDS_COPIED:case r.EDITION_CANCELED:case r.SELECTION_CHANGED:case r.NEXT_SELECTED:case r.PREVIOUS_SELECTED:this.clearInvalid();case r.DATA_CHANGED:case r.CHANGE_UNDONE:case r.CHANGE_REDONE:case r.RECORD_LOADED:this.updateAllFieldsValues(),this.clearFieldError(Object.keys(t.payload)[0]);break;case r.FIELD_INVALIDATED:(a=this._fields)===null||a===void 0||a.forEach(i=>{this.updateErrorMessage(i.fieldName,i.field)});break}},this._uuid=g.generateUUID(),this._fields=new Map,this._dataUnit=e,this.applyDefaultValues(),this._dataUnit.subscribe(this.onDataUnitEvent),this._dataUnit.addInterceptor(this),this.setContextDataBinder(e)}get dataBinderId(){return this._uuid}setContextDataBinder(e){const t=c.getContextValue("__DATABINDER_BY_DATAUNIT__")||new Map,a=[...t.get(e.dataUnitId)||[],this];t.set(e.dataUnitId,a),c.setContextValue("__DATABINDER_BY_DATAUNIT__",t)}applyDefaultValues(){const e=(this._dataUnit.getAddedRecords()||[]).map(t=>t.__record__id__);if(e.length>0){const t=this.getDefaultValues();t&&Object.keys(t).forEach(a=>{this._dataUnit.setFieldValue(a,t[a],e)})}}bind(e,t,a,i){e.forEach(n=>{const{fieldName:s,contextName:d}=n.dataset;(d==null||d===t)&&this.updateBind(s,n)}),this._formMetadata=a,this._recordValidatorProcessor=new C(this._dataUnit,{getRequiredFields:()=>this.getFormRequiredFields(),markAsInvalid:n=>this.markInvalid(n),getMessageForField:n=>this.getErrorMessage(n)},i)}getFormRequiredFields(){return this._formMetadata.getRequiredFields()}disconnectDataUnit(){const e=c.getContextValue("__DATABINDER_BY_DATAUNIT__")||new Map,a=e.get(this._dataUnit.dataUnitId).filter(i=>i.dataBinderId!==this.dataBinderId);e.set(this._dataUnit.dataUnitId,a),c.setContextValue("__DATABINDER_BY_DATAUNIT__",e)}onDisconnectedCallback(){this._dataUnit.unsubscribe(this.onDataUnitEvent),this._dataUnit.removeInterceptor(this),this.disconnectDataUnit()}getCurrentRecordId(){const e=this._dataUnit.getSelectedRecord();return e==null?void 0:e.__record__id__}markInvalid(e){if(this._fields.has(e.name)){const t=this._fields.get(e.name).field;this.updateErrorMessage(e.name,t,e.message)}}setFocus(e){if(!this._fields.has(e))return;const t=this._fields.get(e).field;typeof t.setFocus=="function"&&t.setFocus()}clearInvalid(e){this._dataUnit.clearInvalid(e),this._fields.forEach(t=>{const a=t.field;a.errorMessage=""})}clearFieldError(e){var t;const a=(t=this._fields.get(e))===null||t===void 0?void 0:t.field;a.errorMessage&&(a.errorMessage="",this._dataUnit.clearInvalid(this.getCurrentRecordId(),e))}updateFieldValue(e,t){const a=this._fields.get(e);try{a&&(a.listen=!1),this._dataUnit.isMultipleEdition&&this.hasMultipleValuesBetweenRecords(e)?(t.value=void 0,t.alternativePlaceholder="Múltiplos Valores"):(t.value=this._dataUnit.getFieldValue(e),t.alternativePlaceholder=void 0),this.updateErrorMessage(e,t)}finally{a&&(a.listen=!0)}}hasMultipleValuesBetweenRecords(e){var t,a;const i=(a=(t=this._dataUnit.getSelectionInfo())===null||t===void 0?void 0:t.records)!==null&&a!==void 0?a:[];if(i.length<=1)return!1;const n=i[0][e];return!i.every(s=>E.equals(s[e],n))}validate(){return this._recordValidatorProcessor.validate()}static async validateByDataunit(e){try{const t=this.getDataBindersByDataUnit(e);return await Promise.all(t.map(a=>a.validate())),!0}catch{return!1}}static getDataBindersByDataUnit(e){const t=c.getContextValue("__DATABINDER_BY_DATAUNIT__");return(t==null?void 0:t.get(e.dataUnitId))||[]}updateErrorMessage(e,t,a){a==null&&(a=this._dataUnit.getInvalidMessage(this.getCurrentRecordId(),e)),t.errorMessage||(t.errorMessage=a)}getErrorMessage(e){if(this._fields.has(e))return this._fields.get(e).field.errorMessage}updateBind(e,t){const a=this._fields.get(e);a&&a.destroy(),this.bindSearchOptionsLoader(e,t),this.updateFieldValue(e,t),this.updateErrorMessage(e,t),this._fields.set(e,_.create(e,t,(i,n)=>this.changeStarted(i,n),i=>this.cancelWaitingChange(i),(i,n)=>this.setFieldValue(i,n))),this.applyEzUploadContext(e,t)}changeStarted(e,t){if(this._dataUnit.records.length===0&&this._dataUnit.addRecord(),!t.blocking&&t.promise==null){const a=this._fields.get(e);a&&(t.promise=new Promise((i,n)=>{a.waitingChangePromiseResolve=i,a.waitingChangePromiseReject=n}))}this._dataUnit.startChange(e,t)}cancelWaitingChange(e){if(this._dataUnit.waitingForChange(e)){this._dataUnit.cancelWaitingChange(e);const t=this._fields.get(e);t&&t.rejectWaitingChange(new f("Change canceled",e))}}setFieldValue(e,t){if(this._dataUnit.records.length===0&&this._dataUnit.addRecord(),this._dataUnit.clearInvalid(this.getCurrentRecordId(),e),this._dataUnit.isMultipleEdition){const a=this._dataUnit.getSelectionInfo();this._dataUnit.setFieldValue(e,t,a.recordIds)}else{const a=this._dataUnit.getSelectedRecord();this._dataUnit.setFieldValue(e,t,a?[a.__record__id__]:void 0)}if(this._dataUnit.waitingForChange(e)){const a=this._fields.get(e);a&&a.acceptWaitingChange()}}bindSearchOptionsLoader(e,t){if((t.nodeName==="EZ-SEARCH"||t.nodeName==="EZ-SEARCH-PLUS")&&t.optionLoader==null){const i=t.nodeName==="EZ-SEARCH-PLUS"?c.getContextValue("__EZUI__SEARCH__PLUS__OPTION__LOADER__"):c.getContextValue("__EZUI__SEARCH__OPTION__LOADER__");i&&(t.optionLoader=(n,s)=>i(n,e,this._dataUnit,s))}}applyEzUploadContext(e,t){var a,i;if(t.nodeName==="EZ-UPLOAD"){t.urlUpload=c.getContextValue("__EZUI__UPLOAD__ADD__URL__"),t.urlDelete=c.getContextValue("__EZUI__UPLOAD__DEL__URL__");const n=this._dataUnit.getField(e),s=(a=n.properties)===null||a===void 0?void 0:a.DESTINATION;s&&(t.requestHeaders={XTRAINF:`{"destination": "${s}"}`}),t.maxFiles=((i=n.properties)===null||i===void 0?void 0:i.MAX_FILES)||0}}updateAllFieldsValues(){var e;(e=this._fields)===null||e===void 0||e.forEach(t=>{this.updateFieldValue(t.fieldName,t.field)})}interceptAction(e){if(e.type===r.RECORDS_COPIED){const t=this._formMetadata.getCleanOnCopyFields();if(t){const a=e.payload;return new h(r.RECORDS_COPIED,a.map(i=>{const n=Object.assign({},i);return t.forEach(s=>delete n[s]),n}))}}if(e.type===r.SAVING_DATA)return new Promise(t=>{this.validate().then(()=>t(e)).catch(()=>{})});if(e.type===r.RECORDS_ADDED){const t=this.getDefaultValues();if(t){const a=e.payload;return new h(r.RECORDS_ADDED,a.map(i=>Object.assign(Object.assign({},i),t)))}}return e}getDefaultValues(){var e;const t=(e=this._formMetadata)===null||e===void 0?void 0:e.getDefaultValues();if(t){const a={};for(const i in t)a[i]=this._dataUnit.valueFromString(i,t[i]);return a}}}class _{constructor(){this.listen=!0,this.startChangeEventName="ezStartChange",this.cancelWaitingChangeEventName="ezCancelWaitingChange",this.changeEventName="ezChange"}destroy(){this.field.removeEventListener(this.startChangeEventName,this.startChangeListener),this.field.removeEventListener(this.cancelWaitingChangeEventName,this.cancelWaitingChangeListener),this.field.removeEventListener(this.changeEventName,this.changeListener)}acceptWaitingChange(){this.waitingChangePromiseResolve&&(this.waitingChangePromiseResolve(),this.waitingChangePromiseReject=void 0,this.waitingChangePromiseResolve=void 0)}rejectWaitingChange(e){this.waitingChangePromiseReject&&(this.waitingChangePromiseReject(e),this.waitingChangePromiseReject=void 0,this.waitingChangePromiseResolve=void 0)}static create(e,t,a,i,n){const s=new _;return s.field=t,s.fieldName=e,s.startChangeListener=d=>{s.listen&&a(e,d.detail)},s.field.addEventListener(s.startChangeEventName,s.startChangeListener),s.cancelWaitingChangeListener=()=>{s.listen&&i(e)},s.field.addEventListener(s.cancelWaitingChangeEventName,s.cancelWaitingChangeListener),s.changeListener=d=>{s.listen&&n(e,d.detail)},s.field.addEventListener(s.changeEventName,s.changeListener),s}}const O="Buscar campos (ctrl+F)",V="Buscar colunas (Ctrl+F)",T="ctrl+f",p=240,U="0px",A=String(p-30)+"px",B=(o,e,t)=>v("ez-search",{class:"ez-padding--small ez-margin--none",style:{"--ez-text-input__margin-bottom":U,"--ez-search--width":A},canShowError:!1,showSelectedValue:!1,showOptionValue:!1,suppressEmptyOption:!0,label:o.label,value:null,optionLoader:e,onEzChange:a=>t(a.detail),ignoreLimitCharsToSearch:!0}),M=async o=>{requestAnimationFrame(async()=>{if(o){const e=o.$elm$;if(!e)return;e.value=null,await e.setFocus()}})};export{L as D,O as L,C as R,T as S,p as a,B as b,S as c,V as d,M as f};
//# sourceMappingURL=search-column-e609d513-fnD8_mar.js.map

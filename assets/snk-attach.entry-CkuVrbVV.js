import{r as b,c as k,h as m}from"./index-BV2D5AMk.js";import{h as M,A as E,D as f,U as F,S as V,i as x}from"./dataUnitInMemoryLoader-BjgoPaoq.js";import{A as N}from"./ApplicationContext-B_qAnYBt.js";import{D as I}from"./DataFetcher-db08cad0-B7lG84WQ.js";import{S as _}from"./ISave-da565824-Ad8ZGazV.js";import"./index-b40568ff-7Mtm7E1e.js";import{D as K,I as P,P as B}from"./dataunit-fetcher-1b78797a-Cmcgnk35.js";import"./filter-item-type.enum-d45e026f-B41QHsvD.js";import"./form-config-fetcher-e623539b-By6wLJV7.js";import{V as L}from"./constants-7b422de0-BRz2gykn.js";import{A as Q}from"./auth-fetcher-43c8d76b-Co1wMKeu.js";import{T as v}from"./taskbar-elements-171476d4-BckCxYRz.js";import"./PrintUtils-3e4ff0f5-DDjQRNo9.js";import"./index-b72af127-DDDwiJmo.js";import"./constants-CKEKe-xZ.js";import"./ResourceIDUtils-a114189a-BM9f4Nxo.js";const p={save:"Attach.save",delete:"Attach.remove",view:"Attach.view",repository:"RepositorioArquivoSP.abreArquivo"};class U{constructor(e){this.dataUnitName=e}async save({dataUnit:e,record:t,updatingFields:i,operation:a}){var n,r;const o=a=="INSERT",d=o?i:t;if(!o&&(i!=null&&i.DESCRICAO)&&(i==null?void 0:i.DESCRICAO)!==(t==null?void 0:t.DESCRICAO))throw new Error(_.DESCRIPTION_CANNOT_BE_CHANGED);const u={anexo:{codata:o?i==null?void 0:i.REGISTER_KEY:t==null?void 0:t.CODATA,sequencia:(d==null?void 0:d.SEQUENCIA)||"0",tipo:(d==null?void 0:d.TIPO)||"N",descricao:d==null?void 0:d.DESCRICAO,arquivo:(r=(n=i.CAMINHO_ARQUIVO)===null||n===void 0?void 0:n[0])===null||r===void 0?void 0:r.name,ehInclusao:o?"S":"N",ehArquivoRepositorio:"N"}};return new Promise((l,c)=>{I.get().callServiceBroker(p.save,JSON.stringify(u)).then(D=>{var y;return l([Object.assign(Object.assign(Object.assign({},D),i),{__owner__dataunit__name__:(y=this.dataUnitName)!==null&&y!==void 0?y:e})])}).catch(D=>c(D))})}async edit(e){throw new Error("Method not implemented.")}async delete(e){var t={anexo:{codata:e.CODATA,tipo:e.TIPO,descricao:e.DESCRICAO}};const i=await I.get().callServiceBroker(p.delete,JSON.stringify(t));return Promise.resolve(i)}async getDownloadKey(e){var t,i,a;if(e.EHARQUIVOREPOSITORIO=="S"){const o={config:{path:e.ARQUIVO,tipoconteudo:e.TIPOCONTEUDO}},d=await I.get().callServiceBroker(p.repository,JSON.stringify(o));return Promise.resolve({chave:{valor:(i=(t=d==null?void 0:d.responseBody)===null||t===void 0?void 0:t.chave)===null||i===void 0?void 0:i.valor}})}const n={anexo:{codata:e.CODATA,codemp:e.CODEMP,sequencia:e.SEQUENCIA,tipo:e.TIPO,descricao:e.DESCRICAO,tipoConteudo:e.TIPOCONTEUDO}},r=await I.get().callServiceBroker(p.view,JSON.stringify(n));return r!=null&&r.chaveAnexo?Promise.resolve({chave:{valor:(a=r==null?void 0:r.chaveAnexo)===null||a===void 0?void 0:a.idChaveAnexo}}):Promise.reject(new Error("File not found."))}}const g={save:"AnexoSistemaSP.salvar",delete:"AnexoSistemaSP.excluir",download:"AnexoSistemaSP.baixar"};class T{constructor(e,t){var i;this.entityName=e,this.dataUnitName=t,this.validateFields=a=>{if(a.LINK&&a.NOMEARQUIVO)throw new Error(_.LINK_AND_FILE_AT_THE_SAME_TIME);if(!a.LINK&&!a.NOMEARQUIVO)throw new Error(_.ANY_LINK_OR_FILE_FILLED);if(!this._registerKey)throw new Error("Register key can not be null")},this.resourceID=window.resourceID||((i=window.workspace)===null||i===void 0?void 0:i.resourceID)}set registerKey(e){this._registerKey=e}async save(e){var t,i;let{updatingFields:a}=e;a=Object.assign(Object.assign({},a),{NOMEARQUIVO:(t=a.NOMEARQUIVO)===null||t===void 0?void 0:t[0]});try{this.validateFields(a);const n=a.LINK?null:a.NOMEARQUIVO,r={serviceName:g.save,requestBody:{params:{resourceID:this.resourceID,description:a.DESCRICAO,fileSelect:n?1:0,keySession:(i=n==null?void 0:n.properties)===null||i===void 0?void 0:i.fileNameTmp,nameAttach:n==null?void 0:n.name,link:a.LINK,nameEntity:this.entityName,pkEntity:this._registerKey,typeAcess:a.TIPOACESSO,typeApres:a.TIPOAPRES}}},o=await I.get().callServiceBroker(g.save,JSON.stringify(r));return Promise.resolve([Object.assign(Object.assign(Object.assign({},o),a),{ARQUIVOOULINK:a.LINK?a.LINK:n==null?void 0:n.name,__owner__dataunit__name__:this.dataUnitName})])}catch(n){return Promise.reject(n)}}async edit(e){var t,i,a;let{updatingFields:n,record:r}=e;const o=c=>n[c]!==void 0?n[c]:r[c],d=o("NOMEARQUIVO"),u=(i=(t=n.NOMEARQUIVO)===null||t===void 0?void 0:t[0])===null||i===void 0?void 0:i.downloadURL;n=Object.assign(Object.assign({},n),{DESCRICAO:o("DESCRICAO"),LINK:o("LINK"),TIPOACESSO:o("TIPOACESSO"),TIPOAPRES:o("TIPOAPRES"),CHAVEARQUIVO:r.CHAVEARQUIVO,NOMEARQUIVO:d==null?void 0:d[0]});const l=n.LINK?null:n.NOMEARQUIVO;try{this.validateFields(n);const c={serviceName:g.save,requestBody:{params:{resourceID:this.resourceID,nuAttach:r==null?void 0:r.NUATTACH,description:n.DESCRICAO,fileSelect:u?1:0,keySession:(a=l==null?void 0:l.properties)===null||a===void 0?void 0:a.fileNameTmp,keyAttach:n.CHAVEARQUIVO,nameAttach:l==null?void 0:l.name,link:n.LINK,nameEntity:this.entityName,pkEntity:this._registerKey,typeAcess:n.TIPOACESSO,typeApres:n.TIPOAPRES}}},D=await I.get().callServiceBroker(g.save,JSON.stringify(c));return Promise.resolve([Object.assign(Object.assign(Object.assign({},D),n),{ARQUIVOOULINK:n.LINK?n.LINK:l==null?void 0:l.name,__owner__dataunit__name__:this.dataUnitName})])}catch(c){return Promise.reject(c)}}delete(e){var t;const i=((t=e.NOMEARQUIVO)===null||t===void 0?void 0:t[0])||{},a={serviceName:g.delete,requestBody:{paramsDelete:{keyAttach:e.CHAVEARQUIVO,nameAttach:i==null?void 0:i.name,nameEntity:e.NOMEINSTANCIA,nuAttach:e.NUATTACH,pkEntity:e.PKREGISTRO}}};return new Promise((n,r)=>{I.get().callServiceBroker(g.delete,JSON.stringify(a)).then(o=>n(o)).catch(o=>r(o))})}getDownloadKey(e){var t;const i=((t=e.NOMEARQUIVO)===null||t===void 0?void 0:t[0])||{},a={serviceName:g.download,requestBody:{paramsDown:{nameAttach:i==null?void 0:i.name,nameEntity:e.NOMEINSTANCIA,nuAttach:e.NUATTACH,pkEntity:e.PKREGISTRO,keyAttach:e.CHAVEARQUIVO}}};return new Promise((n,r)=>{I.get().callServiceBroker(g.download,JSON.stringify(a)).then(o=>n(o)).catch(o=>r(o))})}}class G{constructor(e,t){this.entityName=e,this.getMessage=t,this._application=N.getContextValue("__SNK__APPLICATION__")}initLoaders(e,t,i){this.loader||(this.loader=e.dataLoader),e.dataLoader=(a,n)=>this.dataLoader(a,n),e.saveLoader=(a,n)=>this.saveLoader(n,t).then(r=>(r.length&&i(),r)),e.removeLoader=(a,n)=>this.removeLoader(a,n,t).then(r=>(r.length&&i(),r))}metadataLoader(e){throw new Error("Method not implemented.")}dataLoader(e,t){return new Promise(i=>{this.loader(e,t).then(a=>{const n=((a==null?void 0:a.records)||[]).map(r=>{let o;return r.LINK||(o=[{name:r.NOMEARQUIVO}]),Object.assign(Object.assign({},r),{ARQUIVOOULINK:r.LINK?r.LINK:r.NOMEARQUIVO,NOMEARQUIVO:o})});i(Object.assign(Object.assign({},a),{records:n}))})})}saveLoader(e,t){return new Promise(i=>{var a;const n=Array.isArray(e)?e[0]:{};(((a=n==null?void 0:n.record)===null||a===void 0?void 0:a.NUATTACH)>=0?t.edit.bind(t):t.save.bind(t))(n).then(o=>{i(o)}).catch(o=>{if(o.message===_.LINK_AND_FILE_AT_THE_SAME_TIME)return this._application.alert(this.getMessage("snkAttach.alertValidation.fileAndLinkAtTheSameTime.title"),this.getMessage("snkAttach.alertValidation.fileAndLinkAtTheSameTime.message")),i([]);if(o.message===_.ANY_LINK_OR_FILE_FILLED)return this._application.alert(this.getMessage("snkAttach.alertValidation.anyLinkOrFileFilled.title"),this.getMessage("snkAttach.alertValidation.anyLinkOrFileFilled.message")),i([]);if(o.message)return this._application.error(o.title||o.name,o.message),i([]);i([])})})}removeLoader(e,t,i){return new Promise(a=>{const{records:n}=e.getSelectionInfo(),r=n[0];i.delete(r).then(()=>(B.removeRecords(e,[r]),a(t)))})}getFilters(e){return[{name:"AttachmentsByPK",expression:"this.PKREGISTRO = :PKREGISTRO",params:[{name:"PKREGISTRO",dataType:f.TEXT,value:`${e}_${this.entityName}`}]}]}getInterceptions(e,t,i){return new Promise(a=>{if(t.type===E.EDITION_CANCELED)return e.isDirty()?this._application.confirm(this.getMessage("snkAttach.cancelConfirmation.title"),this.getMessage("snkAttach.cancelConfirmation.message")).then(n=>n?(i.goToView(L.GRID),a(t)):a(void 0)):a(t);if(t.type===E.DATA_SAVED)return e.loadData(),a(t);a(t)})}}const C=N.getContextValue("__SNK__APPLICATION__"),A=s=>{var e,t;return(t=(e=C==null?void 0:C.messagesBuilder)===null||e===void 0?void 0:e.getMessage)===null||t===void 0?void 0:t.call(e,s,null)},h={grid:{columns:[{name:"CODATA",orderIndex:0,width:0},{name:"DESCRICAO",orderIndex:1,width:0},{name:"ARQUIVO",orderIndex:2,width:0},{name:"DTALTER",orderIndex:3,width:0},{name:"USUARIO",orderIndex:4,width:0}]},form:{emptyConfig:!1,fields:[{name:"DESCRICAO",label:A("snkAttach.attachMetadata.lblDescription"),visible:!0,readOnly:!1,required:!0},{name:"CAMINHO_ARQUIVO",label:A("snkAttach.attachMetadata.lblFile"),visible:!0,readOnly:!1,required:!0}]}},j={name:"Attach",label:"Attach List",fields:[{name:"CODATA",label:A("snkAttach.attachMetadata.lblCode"),dataType:f.TEXT},{name:"DESCRICAO",label:A("snkAttach.attachMetadata.lblDescription"),dataType:f.TEXT,readOnly:!1},{name:"ARQUIVO",label:A("snkAttach.attachMetadata.lblFileOrLink"),dataType:f.TEXT},{name:"USUARIO",label:A("snkAttach.attachMetadata.lblUser"),dataType:f.TEXT},{name:"DTALTER",label:A("snkAttach.attachMetadata.lblDate"),dataType:f.TEXT},{name:"CAMINHO_ARQUIVO",label:A("snkAttach.attachMetadata.lblFileUpload"),dataType:f.OBJECT,userInterface:F.FILE,readOnly:!1,required:!0,visible:!0,properties:{subTitle:A("snkAttach.attachMetadata.lblSubTitle"),MAX_FILES:1,STORAGESTRATEGY:"SESSION",INTERNAL_FILENAME:"Attach.upload"}}]},H="Attach.load";class z{constructor(e){this.getMessage=e,this._records=[],this._application=N.getContextValue("__SNK__APPLICATION__")}initLoaders(e,t,i){e.metadataLoader=a=>this.metadataLoader(a),e.dataLoader=(a,n)=>this.dataLoader(a,n),e.saveLoader=(a,n)=>this.saveLoader(n,t).then(r=>(r.length&&i(),r)),e.removeLoader=(a,n)=>this.removeLoader(a,n,t).then(r=>(r.length&&i(),r))}metadataLoader(e){return Promise.resolve(j)}async dataLoader(e,t){if(!t.source)return Promise.resolve({records:this._records});if(!Number.isNaN(Number(t.source))){const i={criteria:{codata:t.source,tipoAnexo:"N"}},a=await this._application.getDataFetcher(),{anexos:{anexo:n=[]}}=await a.callServiceBroker(H,JSON.stringify(i)),r=[];n.forEach(o=>{r.push(Object.assign({__record__id__:V.generateUUID(),CAMINHO_ARQUIVO:[{name:o==null?void 0:o.ARQUIVO}]},o))}),this._records=r}return x.buildLoadDataResponse(this._records,e,t)}saveLoader(e,t){return new Promise(i=>{const a=Array.isArray(e)?e[0]:{};t.save(a).then(i).catch(n=>{if(n.message===_.DESCRIPTION_CANNOT_BE_CHANGED)return this._application.alert(this.getMessage("snkAttach.alertValidation.descriptionCannotBeChanged.title"),this.getMessage("snkAttach.alertValidation.descriptionCannotBeChanged.message")),i([]);if(n.message===_.LINK_AND_FILE_AT_THE_SAME_TIME)return this._application.alert(this.getMessage("snkAttach.alertValidation.fileAndLinkAtTheSameTime.title"),this.getMessage("snkAttach.alertValidation.fileAndLinkAtTheSameTime.message")),i([]);if(n.message===_.ANY_LINK_OR_FILE_FILLED)return this._application.alert(this.getMessage("snkAttach.alertValidation.anyLinkOrFileFilled.title"),this.getMessage("snkAttach.alertValidation.anyLinkOrFileFilled.message")),i([]);if(n.message)return this._application.error(n.title||n.name,n.message),i([]);i([])})})}removeLoader(e,t,i){return new Promise(a=>{e.getSelectionInfo().records.forEach(async n=>{this._application.hasAccess(Q.REMOVE).then(async r=>{r&&(await i.delete(n),a(t))})})})}getFilters(){throw new Error("Method not implemented.")}getInterceptions(e,t,i){return new Promise(a=>{var n,r,o,d,u,l;switch(t.type){case E.EDITION_CANCELED:return e.isDirty()?this._application.confirm(this.getMessage("snkAttach.cancelConfirmation.title"),this.getMessage("snkAttach.cancelConfirmation.message")).then(c=>c?(i.goToView(L.GRID),a(t)):a(void 0)):a(t);case E.DATA_SAVED:return e.loadData(void 0,void 0,!1,(o=(r=(n=t==null?void 0:t.payload)===null||n===void 0?void 0:n.records)===null||r===void 0?void 0:r[0])===null||o===void 0?void 0:o.REGISTER_KEY),a(t);case E.RECORDS_REMOVED:return e.loadData(void 0,void 0,!1,(l=(u=(d=t==null?void 0:t.payload)===null||d===void 0?void 0:d.cachedRecords)===null||u===void 0?void 0:u[0])===null||l===void 0?void 0:l.CODATA),a(t)}a(t)})}}const S=N.getContextValue("__SNK__APPLICATION__"),R=s=>{var e,t;return(t=(e=S==null?void 0:S.messagesBuilder)===null||e===void 0?void 0:e.getMessage)===null||t===void 0?void 0:t.call(e,s,null)},w={DOWNLOAD:{hint:R("snkAttach.taskbar.titleDownload"),name:"DOWNLOAD",iconName:"file-download"},LINK:{hint:R("snkAttach.taskbar.titleLink"),name:"LINK",iconName:"launch"}},q=()=>{const s=[v.REMOVE,"DOWNLOAD","LINK"];return{getButtons:(e,t,i)=>{const a=i.indexOf(v.REFRESH);if(t!=null&&t.insertionMode||t!=null&&t.isDirty)return i.reverse();a!==-1&&i.splice(a,1);const{selectedRecord:n}=t||{},r=n!=null&&n.LINK?w.LINK:w.DOWNLOAD;i.splice(i.indexOf(v.DIVIDER)+1,0,v.REMOVE,r,v.DIVIDER);const o=[v.CLONE,v.DATA_EXPORTER],d=Array.from(new Set(i.filter(u=>!o.includes(u))));return d.splice(d.indexOf(r)+1,0,v.DIVIDER),d},isEnabled:(e,t,i)=>{const a=(t==null?void 0:t.selectedRecord)!==void 0;return!(s.includes(i)&&!a)}}},O={grid:{columns:[{name:"ARQUIVOOULINK",orderIndex:0,width:0},{name:"DESCRICAO",orderIndex:1,width:0},{name:"DHCAD",orderIndex:2,width:0},{name:"DHALTER",orderIndex:3,width:0},{name:"TIPOAPRES",orderIndex:4,width:0},{name:"TIPOACESSO",orderIndex:5,width:0},{name:"CODUSU",orderIndex:6,width:0},{name:"CODUSUALT",orderIndex:7,width:0}]},form:{emptyConfig:!1,fields:[{name:"DESCRICAO",required:!0},{name:"TIPOAPRES",required:!0},{name:"TIPOACESSO",required:!0},{name:"LINK"},{name:"NOMEARQUIVO"}]}},W=".snk-attach__header.sc-snk-attach,.snk-attach__crud-section.sc-snk-attach{padding:0 var(--space--lg)}.snk-attach__file-info.sc-snk-attach{padding:var(--space--small);max-width:50%}.snk-attach__main.sc-snk-attach{height:85%}.ez-box__container.sc-snk-attach{height:100%}",J="AnexoSistema",Y="br.com.sankhya.core.v3.anexoSistema",X="GrdCfgHtml5:grdcfg.dynaform.anexo",$="ARQUIVOOULINK",Z=class{constructor(s){b(this,s),this.back=k(this,"back",7),this.handleTaskbarClick=async({detail:e})=>{if(["DOWNLOAD","LINK"].includes(e))return this.downloadAttachment(this._currentDataUnit.getSelectedRecord());this.fetcherType==="Attach"&&["SAVE"].includes(e)&&this._currentDataUnit.isDirty()&&await this._currentDataUnit.setFieldValue("REGISTER_KEY",this.registerKey)},this.handleBack=()=>{this._currentDataUnit.cancelEdition().then(e=>{e&&this.back.emit()})},this.handleFinish=()=>{if(!this._currentDataUnit.isDirty())return this.back.emit();this.validateAnexoSistema()&&this._currentDataUnit.saveData().then(()=>{this.showFinishedToast(),this.back.emit()})},this.gridLegacyConfigName=void 0,this.fetcherType=void 0,this.fetcher=void 0,this.dataUnit=void 0,this.dataUnitBuilder=void 0,this.registerKey=void 0,this.entityName=void 0,this.messagesBuilder=void 0,this._currentFetcher=void 0,this._currentDataUnit=void 0,this.crudConfig=void 0}async registerKeyWatcher(s,e){var t;this._currentDataUnit==null&&this.loadAttachmentDataUnit(),e!==s&&(this._currentFetcher instanceof T&&(this._currentFetcher.registerKey=s),await((t=this._currentDataUnit)===null||t===void 0?void 0:t.loadData()))}getAnexoSistemaFetcherInstance(){var s;const e=new T(this.entityName,(s=this._currentDataUnit)===null||s===void 0?void 0:s.name);return e.registerKey=this.registerKey,e}async initAttach(){var s,e,t,i,a;if(!(!this.fetcherType&&!this.registerKey)){if(this.fetcherType||(this.fetcherType="AnexoSistema"),this.returnToGridMode(),this.fetcherType==="AnexoSistema"){this._currentFetcher=this.getAnexoSistemaFetcherInstance(),(s=this._currentDataUnitBuilder)===null||s===void 0||s.initLoaders(this._currentDataUnit,this._currentFetcher,this.returnToGridMode.bind(this)),await((e=this._currentDataUnit)===null||e===void 0?void 0:e.loadData());return}this.fetcherType==="Attach"&&((t=this.registerKey)===null||t===void 0?void 0:t.split("_").length)>1||(await((i=this._currentDataUnit)===null||i===void 0?void 0:i.loadMetadata()),await((a=this._currentDataUnit)===null||a===void 0?void 0:a.loadData(void 0,void 0,!0,this.registerKey)))}}getMessage(s,e){if(this.messagesBuilder)return this.messagesBuilder.getMessage(s,e)}showFinishedToast(){this._application.info(this.getMessage("snkAttach.finishedMessage"),{iconName:"check"})}downloadAttachment(s){if(!s)throw new Error("Nenhum registro selecionado");if(s.LINK){window.open(`${s.LINK}`);return}this._currentFetcher.getDownloadKey(s).then(({chave:e})=>{var t;let i=!1;!((t=s==null?void 0:s.ARQUIVO)===null||t===void 0)&&t.endsWith(".pdf")||(i=!0),window.open(`/mge/visualizadorArquivos.mge?chaveArquivo=${e.valor}${i?"&forcarDownload=S":""}`)})}returnToGridMode(){var s;(s=this._currentDataUnit)===null||s===void 0||s.clearSelection(),this._crudElement&&this._crudElement.goToView(L.GRID)}async loadAttachmentDataUnit(){try{switch(this.fetcherType){case"AnexoSistema":await this.loadAnexoSistema();break;case"Attach":await this.loadAttach();break;default:this._currentFetcher=this.fetcher,this._currentDataUnit=this.dataUnit,this._currentDataUnitBuilder=this.dataUnitBuilder}}catch{throw new Error("There was an error while creating the data unit")}}async loadAnexoSistema(){var s,e;this._currentDataUnit=new K().getDataUnit(J,Y),this._currentFetcher=this.getAnexoSistemaFetcherInstance();let t;this._currentDataUnit.metadata||(await((s=this._currentDataUnit)===null||s===void 0?void 0:s.loadMetadata()),this.crudConfig=this.entityName?{form:O==null?void 0:O.form}:Object.assign({},O),t={grid:O==null?void 0:O.grid}),this.initDataUnitLoaders(),this._currentDataUnit.addFilterProvider({getFilter:()=>this._currentDataUnitBuilder.getFilters(this.registerKey)}),this._currentDataUnit.addInterceptor({interceptAction:i=>this._currentDataUnitBuilder.getInterceptions(this._currentDataUnit,i,this._crudElement)}),await((e=this._currentDataUnit)===null||e===void 0?void 0:e.loadData()),this.disableEditFieldsNotInForm(t)}async loadAttach(){var s,e;this._currentFetcher=new U,this._currentDataUnit=new M(P.IN_MEMORY_DATA_UNIT_NAME),this._currentDataUnit.pageSize=150;let t;this.initDataUnitLoaders(),this._currentDataUnit.addInterceptor({interceptAction:i=>{var a;return i.type===E.METADATA_LOADED&&(this.crudConfig=this.entityName?{form:h==null?void 0:h.form}:Object.assign({},h),t={grid:h==null?void 0:h.grid},(a=this._crudElement)===null||a===void 0||a.updateConfig()),this._currentDataUnitBuilder.getInterceptions(this._currentDataUnit,i,this._crudElement)}}),this._currentDataUnit.metadata||(await((s=this._currentDataUnit)===null||s===void 0?void 0:s.loadMetadata()),this.crudConfig=this.entityName?{form:h==null?void 0:h.form}:Object.assign({},h),t={grid:h==null?void 0:h.grid},await((e=this._currentDataUnit)===null||e===void 0?void 0:e.loadData(void 0,void 0,!0,this.registerKey)),this.disableEditFieldsNotInForm(t))}initDataUnitLoaders(){var s,e;this.fetcherType==="AnexoSistema"&&(this._currentFetcher=this.getAnexoSistemaFetcherInstance(),this._currentDataUnitBuilder=new G(this.entityName,this.getMessage.bind(this)),(s=this._currentDataUnitBuilder)===null||s===void 0||s.initLoaders(this._currentDataUnit,this._currentFetcher,this.returnToGridMode.bind(this))),this.fetcherType==="Attach"&&(this._currentFetcher=new U,this._currentDataUnitBuilder=new z(this.getMessage.bind(this)),(e=this._currentDataUnitBuilder)===null||e===void 0||e.initLoaders(this._currentDataUnit,this._currentFetcher,async()=>{this.returnToGridMode(),await this._currentDataUnit.loadData(void 0,void 0,!0,this.registerKey)}))}disableEditFieldsNotInForm(s){var e,t,i,a,n;const r=((t=(e=this._crudElement)===null||e===void 0?void 0:e.gridConfig)===null||t===void 0?void 0:t.columns)||((i=s==null?void 0:s.grid)===null||i===void 0?void 0:i.columns)||((n=(a=this.crudConfig)===null||a===void 0?void 0:a.grid)===null||n===void 0?void 0:n.columns);this.getGridLegacyConfigName()&&this._currentDataUnit.disableField($),r==null||r.forEach(o=>{var d,u;const l=o.name;!((u=(d=this.crudConfig)===null||d===void 0?void 0:d.form)===null||u===void 0)&&u.fields.some(c=>(c==null?void 0:c.name)===l)||this._currentDataUnit.disableField(l)})}validateAnexoSistema(){var s;if(this._currentFetcher instanceof T)try{let e=this._currentDataUnit.getSelectedRecord();e=Object.assign(Object.assign({},e),{NOMEARQUIVO:(s=e.NOMEARQUIVO)===null||s===void 0?void 0:s[0]}),this._currentFetcher.validateFields(e)}catch(e){if(e.message===_.LINK_AND_FILE_AT_THE_SAME_TIME)return this._application.alert(this.getMessage("snkAttach.alertValidation.fileAndLinkAtTheSameTime.title"),this.getMessage("snkAttach.alertValidation.fileAndLinkAtTheSameTime.message")),!1;if(e.message===_.ANY_LINK_OR_FILE_FILLED)return this._application.alert(this.getMessage("snkAttach.alertValidation.anyLinkOrFileFilled.title"),this.getMessage("snkAttach.alertValidation.anyLinkOrFileFilled.message")),!1}return!0}async componentWillLoad(){this._application=N.getContextValue("__SNK__APPLICATION__"),await this.initAttach()}componentWillRender(){this.fetcherType||(this.fetcherType="AnexoSistema"),this._currentDataUnit==null&&this.loadAttachmentDataUnit()}async handleOnDataStateChange({detail:s}){this.fetcherType==="Attach"&&(s.insertionMode?this._currentDataUnit.enableField("DESCRICAO"):this._currentDataUnit.disableField("DESCRICAO"),await this._currentDataUnit.loadMetadata())}getGridLegacyConfigName(){return this.gridLegacyConfigName?this.gridLegacyConfigName:this.entityName?X+"."+this.entityName:this.entityName}render(){var s,e;return this._currentDataUnit?m("main",{class:"snk-attach__main"},m("header",{class:"snk-attach__header"},m("snk-simple-bar",{onExit:this.handleBack,messagesBuilder:this.messagesBuilder},m("div",{slot:"rightSlot"},m("ez-button",{class:"ez-button--primary",label:this.getMessage("snkAttach.finish"),onClick:this.handleFinish})))),m("div",{class:"snk-attach__crud-section ez-size-height--full ez-size-width--full ez-flex ez-flex--column"},m("div",{class:"ez-box__container"},m("snk-simple-crud",{ref:t=>this._crudElement=t,dataUnit:this._currentDataUnit,taskbarManager:q(),gridConfig:(s=this.crudConfig)===null||s===void 0?void 0:s.grid,formConfig:(e=this.crudConfig)===null||e===void 0?void 0:e.form,useCancelConfirm:!1,onActionClick:this.handleTaskbarClick,messagesBuilder:this.messagesBuilder,onDataStateChange:this.handleOnDataStateChange.bind(this),multipleSelection:!0,configName:this.entityName,ignoreReadOnlyFormFields:!!this.entityName,gridLegacyConfigName:this.getGridLegacyConfigName()},m("div",{slot:"snkSimpleCrudHeader"},m("div",{class:"ez-flex ez-flex--column"},m("span",{class:"ez-title--primary ez-text ez-text--large ez-text--bold ez-padding-bottom--medium"},this.getMessage("snkAttach.title")),m("span",{class:"ez-text ez-text--medium ez-text--secondary ez-padding-bottom--medium"},this.getMessage("snkAttach.description")))))))):null}static get watchers(){return{registerKey:["registerKeyWatcher"]}}};Z.style=W;export{Z as snk_attach};

import{r as h,c as d,S as c,E as l,A as u,h as i,H as m,g}from"./index-CxFxc26b.js";import{K as _}from"./index-dPP-F_x9.js";import{T as r}from"./taskbar-elements-171476d4-AkTdhoOC.js";import"./DataFetcher-db08cad0-DvO7h7yr.js";import"./ISave-da565824-Eut4pXqL.js";import{P as f,E as C}from"./index-b40568ff-7Mtm7E1e.js";import"./dataunit-fetcher-1b78797a-DBNOZpxi.js";import"./filter-item-type.enum-d45e026f-B41QHsvD.js";import"./form-config-fetcher-e623539b-VBVHUPpx.js";import{V as s}from"./constants-7b422de0-BRz2gykn.js";import{A as E}from"./auth-fetcher-43c8d76b-DMf49abo.js";import"./index-b72af127-BthcoYGc.js";import"./PrintUtils-3e4ff0f5-BzI1KebB.js";import"./ResourceIDUtils-a114189a-DvfZuq5X.js";const k=".sc-snk-crud-h{display:flex;flex-direction:column;height:100%;width:100%}",p=class{constructor(e){h(this,e),this.actionClick=d(this,"actionClick",7),this.configuratorSave=d(this,"configuratorSave",7),this.configuratorCancel=d(this,"configuratorCancel",7),this.formItemsReady=d(this,"formItemsReady",7),this.viewModeChanged=d(this,"viewModeChanged",7),this._viewHistory=[],this._customEditors=new Map,this._customRenders=new Map,this._dataUnit=void 0,this._dataState=void 0,this.attachmentRegisterKey=void 0,this._currentViewMode=s.GRID,this._canEdit=void 0,this._resourceID=void 0,this.enableLockManagerLoadingComp=!1,this.enableLockManagerTaskbarClick=!1,this.configName=void 0,this.filterBarTitle=void 0,this.selectionToastConfig=void 0,this.showActionButtons=!1,this.actionsList=void 0,this.taskbarManager=void 0,this.recordsValidator=void 0,this.statusResolver=void 0,this.multipleSelection=!0,this.presentationMode=f.PRIMARY,this.messagesBuilder=void 0,this.useEnterLikeTab=!1,this.gridLegacyConfigName=void 0,this.filterBarLegacyConfigName=void 0,this.formLegacyConfigName=void 0,this.disablePersonalizedFilter=void 0,this.autoLoad=void 0,this.autoFocus=!0,this.enableGridInsert=!1,this.domainMessagesBuilder=void 0,this.ignoreReadOnlyFormFields=void 0,this.setCustomFormTitle=void 0,this.strategyExporter=C.SERVER_SIDE,this.layoutFormConfig=!1,this.multipleEditionEnabled=!0,this.paginationCounterMode="auto",this.layoutFormConfig=!1,this.customContainerId=`SNK-CRUD-CUSTOM-CONTAINER-${c.generateUUID()}`}async goToView(e){this.executeAction(e)}async openConfigurator(){var e;(e=this._snkConfigurator)===null||e===void 0||e.open()}async closeConfigurator(){var e;(e=this._snkConfigurator)===null||e===void 0||e.close()}async reloadFilterBar(){var e;(e=this._snkGrid)===null||e===void 0||e.reloadFilterBar()}async getFilterBar(){return await this._snkGrid.getFilterBar()}async addCustomEditor(e,t){if(this._guidesViewer&&this._snkGrid){this._guidesViewer.addCustomEditor(e,t),this._snkGrid.addCustomEditor(e,t);return}const a=new Map(this._customEditors);a.set(e,t),this._customEditors=a}async addGridCustomRender(e,t){if(this._snkGrid){this._snkGrid.addGridCustomRender(e,t);return}const a=new Map(this._customRenders);a.set(e,t),this._customRenders=a}async addCustomValueFormatter(e,t){this._snkGrid.addCustomValueFormatter(e,t)}async removeCustomValueFormatter(e){this._snkGrid.removeCustomValueFormatter(e)}async setFieldProp(e,t,a){await this._guidesViewer.setFieldProp(e,t,a)}currentViewModeWatcher(e){this._viewHistory=[...this._viewHistory.slice(-1),e]}async gridToForm(e=!1){this._backToGrid=!e&&await this._viewStack.getSelectedIndex()===s.GRID,this.setViewMode(s.FORM)}async executeAction(e){switch(e){case r.GRID_MODE:return this.setViewMode(s.GRID);case r.FORM_MODE:case r.UPDATE:return this.gridToForm(e!==r.UPDATE);case r.UPDATE_MULTIPLE:return this._dataUnit.isMultipleEdition=!0,this.setViewMode(s.FORM);case r.CONFIGURATOR:return this._snkConfigurator.open();case r.ATTACH:return this.setViewMode(s.ATTACHMENT)}}backView(){const e=this._viewHistory.at(-2)||s.GRID;this.setViewMode(e)}setViewMode(e){this._viewStack.show(e),this._currentViewMode=e,e===s.GRID?(this._dataUnit.isMultipleEdition=!1,this._snkGrid.setFocus()):e===s.FORM&&this._guidesViewer.setFocus(),this.viewModeChanged.emit(e)}openConfig(e){this._snkConfigurator.close(),e===s.GRID?this._snkGrid.showConfig():e===s.FORM&&this._guidesViewer.showFormConfig()}addDataElementID(){const e={dataUnit:this._dataUnit};l.addIDInfo(this._element,null,e)}insertionModeHandler(){this.enableGridInsert||this.gridToForm()}cancelHandler(){this._backToGrid&&this.setViewMode(s.GRID)}async getAttachmentRegisterKey(){return this._snkDataUnit?(await this._snkDataUnit.getSelectedRecordsIDsInfo()).map(({value:a})=>a).join("_"):void 0}setCustomRenders(){if(this._snkGrid)for(const[e,t]of this._customRenders)this._snkGrid.addGridCustomRender(e,t),this._customRenders.delete(e)}setCustomEditors(){if(!(!this._snkGrid||!this._guidesViewer))for(const[e,t]of this._customEditors)this._guidesViewer.addCustomEditor(e,t),this._snkGrid.addCustomEditor(e,t),this._customEditors.delete(e)}componentDidRender(){this.setCustomRenders(),this.setCustomEditors()}componentWillLoad(){this._application=u.getContextValue("__SNK__APPLICATION__");let e=this._element.parentElement;for(this._application.hasAccess(E.UPDATE,this._resourceID).then(t=>this._canEdit=t);e;){if(e.tagName.toUpperCase()==="SNK-DATA-UNIT"){this._snkDataUnit=e,this._snkDataUnit.addEventListener("insertionMode",()=>this.insertionModeHandler()),this._snkDataUnit.addEventListener("cancelEdition",()=>this.cancelHandler()),this._snkDataUnit.domainMessagesBuilder=this.domainMessagesBuilder,this._dataUnit=this._snkDataUnit.dataUnit,this._dataState=this._snkDataUnit.dataState,this._dataUnit?this.initDataUnit():this._snkDataUnit.addEventListener("dataUnitReady",t=>{this._dataUnit=t.detail,this.initDataUnit()}),this._snkDataUnit.addEventListener("dataStateChange",this.handleDataStateChange.bind(this));break}e=e.parentElement}this.configName||(this.configName=this._application.configName)}componentDidLoad(){this.initKeyboardManager()}disconnectedCallback(){this.removeShortcuts()}async handleDataStateChange(e){var t;this._dataState=e.detail,this._dataState.selectedRecord!==void 0&&(this.attachmentRegisterKey=await this.getAttachmentRegisterKey());const a=await this._snkDataUnit.getFieldsWithRmPrecision();for(const n of a||[]){if(!n)continue;const o=(t=this._dataState.rowMetadata)===null||t===void 0?void 0:t.getProp("rm_precision",n);!o&&o!==0||(await this.setFieldProp(n,"precision",o),await this.setFieldProp(n,"prettyPrecision",o))}}async initKeyboardManager(){this._keyboardManager=new _({propagate:!1,element:this._element});const e=this._dataUnit||await this._snkDataUnit.getDataUnit();async function t(){const n=document.activeElement,o=n==document.body;if(o||n.blur(),await e.saveData(),!o&&n.setFocus!=null){n.setFocus();return}o||n.focus()}async function a(){e.hasNewRecord()||e.addRecord()}this._keyboardManager&&this._keyboardManager.bind("F6",this.toggleView.bind(this),{description:"Alterna entre modo formulário e grade.",element:this._element}).bind("F7",t.bind(this),{description:"Salva os dados.",element:this._element}).bind("ctrl + \\",t.bind(this),{description:"Salva os dados.",element:this._element}).bind("F8",a.bind(this),{description:"Adiciona um novo registro.",element:this._element}).bind("F9",e.removeSelectedRecords.bind(e),{description:"Remove o registro selecionado.",element:this._element}).bind("ctrl + F9",e.removeSelectedRecords.bind(e),{description:"Remove o registro selecionado.",element:this._element}).bind("F5",async()=>{const n=await this._viewStack.getSelectedIndex();s.GRID===n&&e.loadData()},{description:"Atualiza os dados.",element:this._element}).bind("Escape",()=>{e.isDirty()&&e.cancelEdition()},{debounceTime:1e3,description:"Cancela uma ação.",element:this._element})}async removeShortcuts(){var e;(e=this._keyboardManager)===null||e===void 0||e.unbindAllShortcutKeys()}async toggleView(){const e=await this._viewStack.getSelectedIndex();this.setViewMode(s.GRID===e?s.FORM:s.GRID)}async initDataUnit(){this.addDataElementID(),this.messagesBuilder||(this.messagesBuilder=this._snkDataUnit.messagesBuilder),this._resourceID==null&&(this._resourceID=this._snkDataUnit.resourceID,this._resourceID==null&&(this._resourceID=await this._application.getResourceID()))}handleConfiguratorEvent(e,t){if(e.stopImmediatePropagation(),t==="SAVE"){this.configuratorSave.emit();return}this.configuratorCancel.emit()}render(){if(this._resourceID!=null)return this._snkDataUnit.ignoreSaveMessage=this._currentViewMode===s.GRID&&!this.enableGridInsert,i(m,null,i("ez-view-stack",{ref:e=>this._viewStack=e,"data-element-id":"crud"},i("stack-item",{class:"ez-flex ez-flex--column ez-size-height--full ez-size-width--full ez-padding--medium"},i("snk-grid",{ref:e=>this._snkGrid=e,class:"ez-flex ez-flex--column ez-size-height--full ez-size-width--full",filterBarTitle:this.filterBarTitle,"data-element-id":"crud_grid",configName:this.configName,onGridDoubleClick:()=>this.gridToForm(!0),taskbarManager:this.taskbarManager,onActionClick:e=>this.executeAction(e.detail),messagesBuilder:this.messagesBuilder,actionsList:this.actionsList,statusResolver:this.statusResolver,multipleSelection:this.multipleSelection,presentationMode:this.presentationMode,recordsValidator:this.recordsValidator,selectionToastConfig:this.selectionToastConfig,useEnterLikeTab:this.useEnterLikeTab,canEdit:this._canEdit,resourceID:this._resourceID,disablePersonalizedFilter:this.disablePersonalizedFilter,gridLegacyConfigName:this.gridLegacyConfigName,filterBarLegacyConfigName:this.filterBarLegacyConfigName,autoLoad:this.autoLoad,autoFocus:this.autoFocus,enableGridInsert:this.enableGridInsert,enableLockManagerTaskbarClick:this.enableLockManagerTaskbarClick,enableLockManagerLoadingComp:this.enableLockManagerLoadingComp,strategyExporter:this.strategyExporter,multipleEditionEnabled:this.multipleEditionEnabled,paginationCounterMode:this.paginationCounterMode},i("slot",{name:"GRID_TASKBAR_CUSTOM_ELEMENTS"}),i("slot",{name:"GRID_HEADER_CUSTOM_ELEMENTS"}),i("slot",{name:"SnkGridHeader"}),i("slot",{name:"SnkGridFooter"}),i("slot",{name:"SnkGridTaskBar"}))),i("stack-item",null,i("snk-guides-viewer",{ref:e=>this._guidesViewer=e,entityPath:this._snkDataUnit.entityName,messagesBuilder:this.messagesBuilder,onExit:()=>this.setViewMode(s.GRID),dataState:this._dataState,dataUnit:this._dataUnit,actionsList:this.actionsList,taskbarManager:this.taskbarManager,configName:this.configName,onActionClick:e=>this.executeAction(e.detail),presentationMode:this.presentationMode,"data-element-id":"crud_form",canEdit:this._canEdit,recordsValidator:this.recordsValidator,resourceID:this._resourceID,detailTaskbarCustomContainerId:this.customContainerId,formLegacyConfigName:this.formLegacyConfigName,enableGridInsert:this.enableGridInsert,getCustomTitle:this.setCustomFormTitle,ignoreReadOnlyFormFields:this.ignoreReadOnlyFormFields},i("slot",{name:"GUIDES_VIEWER_TASKBAR_CUSTOM_ELEMENTS"}),i("slot",{name:"SnkFormTaskBar"}))),i("stack-item",{tabIndex:"0"},i("snk-attach",{registerKey:this.attachmentRegisterKey,messagesBuilder:this.messagesBuilder,entityName:this._snkDataUnit.entityName,onBack:this.backView.bind(this)})),i("snk-configurator",{ref:e=>this._snkConfigurator=e,viewMode:this._currentViewMode,messagesBuilder:this.messagesBuilder,onConfigSelected:e=>this.setViewMode(e.detail),onOpenConfig:e=>this.openConfig(e.detail),showActionButtons:this.showActionButtons,onSave:e=>this.handleConfiguratorEvent(e,"SAVE"),onCancel:e=>this.handleConfiguratorEvent(e,"CANCEL"),resourceID:this._resourceID,customContainerId:this.customContainerId,layoutFormConfig:this.layoutFormConfig})),i("div",{id:`${this.customContainerId}`},i("slot",{name:"SnkConfigContainerSlot"}),i("slot",{name:"DETAIL_GRID_HEADER_CUSTOM_ELEMENTS"}),i("slot",{name:"DETAIL_GRID_TASKBAR_CUSTOM_ELEMENTS"}),i("slot",{name:"DETAIL_TASKBAR_CUSTOM_ELEMENTS"})))}get _element(){return g(this)}static get watchers(){return{_currentViewMode:["currentViewModeWatcher"]}}};p.style=k;export{p as snk_crud};
//# sourceMappingURL=snk-crud.entry-DtwT2FhR.js.map

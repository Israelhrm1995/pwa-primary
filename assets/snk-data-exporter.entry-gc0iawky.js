import{r as y,h as g,H as C,g as I}from"./index-CzwKln6B.js";import{D as w,E as T,O as x,U as E}from"./dataUnitInMemoryLoader-CwDmnNwL.js";import{A as O}from"./ApplicationContext-B_qAnYBt.js";import{A as f,D as k}from"./FormLayout-CTCTPPNq.js";import{I as R}from"./IFetchDataExporterParams-d73bed3d-DNdoYuuf.js";import{D as r,a as b,b as L}from"./index-b40568ff-7Mtm7E1e.js";import{R as M}from"./constants-7b422de0-BRz2gykn.js";import{D as S}from"./DataFetcher-db08cad0-YRT7v6X1.js";import{snk_data_unit as N}from"./snk-data-unit.entry-C0s2gUE3.js";import"./ISave-da565824-BpwjVTmC.js";import"./dataunit-fetcher-1b78797a-B5AebLgP.js";import"./filter-item-type.enum-d45e026f-B41QHsvD.js";import"./form-config-fetcher-e623539b-ClsRvgut.js";import"./PrintUtils-3e4ff0f5-Dyc0ptsy.js";import"./SnkMessageBuilder-c8b452b6-DiTA3Jtf.js";import"./GetSelectedRecordsIDsInfo-9fa41508-Dkcln7_7.js";import"./constants-CKEKe-xZ.js";import"./ResourceIDUtils-a114189a-DSWFS9XU.js";class F{constructor(e,i){this._selectedNumber=0,this._getMessage=e,this._selectedNumber=i}setExportOption(e,i){const s=this.getExportGroupName();e===r.EXPORT_TO_PDF&&i.push(this.getExportToPDF(s)),e===r.EXPORT_TO_XLS&&i.push(this.getExportToXLS(s)),this.setExportCurrentPage(e,i),this._selectedNumber>0&&this.setExportAllRecords(e,i),this.setExportByEmail(e,i)}setExportCurrentPage(e,i){var s;const n=[r.EXPORT_PAGE_TO_PDF,r.EXPORT_PAGE_TO_XLS];if(e===r.EXPORT_CURRENT_PAGE&&i.push(this.getCurrentPage()),n.includes(e)){let o=i.find(a=>a.id===r.EXPORT_CURRENT_PAGE);o==null&&(i.push(this.getCurrentPage()),o=i.find(a=>a.id===r.EXPORT_CURRENT_PAGE)),!((s=o==null?void 0:o.children)===null||s===void 0)&&s.length||(o.children=[]),e===r.EXPORT_PAGE_TO_PDF&&o.children.push(this.getExportPageToPDF()),e===r.EXPORT_PAGE_TO_XLS&&o.children.push(this.getExportPageToXLS())}}setExportAllRecords(e,i){var s;const n=[r.EXPORT_ALL_RECORDS_TO_PDF,r.EXPORT_ALL_RECORDS_TO_XLS];if(e===r.EXPORT_ALL_RECORDS&&i.push(this.getAllRecords()),n.includes(e)){let o=i.find(a=>a.id===r.EXPORT_ALL_RECORDS);o==null&&(i.push(this.getAllRecords()),o=i.find(a=>a.id===r.EXPORT_ALL_RECORDS)),!((s=o.children)===null||s===void 0)&&s.length||(o.children=[]),e===r.EXPORT_ALL_RECORDS_TO_PDF&&o.children.push(this.getExportAllRecordsToPDF()),e===r.EXPORT_ALL_RECORDS_TO_XLS&&o.children.push(this.getExportAllRecordsToXLS())}}setExportByEmail(e,i){e===r.EXPORT_BY_EMAIL&&i.push(this.getExportByEmail())}getExportToPDF(e){return{id:r.EXPORT_TO_PDF,label:"PDF (.pdf)",group:e}}getExportToXLS(e){return{id:r.EXPORT_TO_XLS,label:`${this._getMessage("snkDataExporter.label.spreadsheet")} (.xls)`,group:e}}getCurrentPage(){return{id:r.EXPORT_CURRENT_PAGE,label:this._getMessage("snkDataExporter.label.currentPage"),group:this._getMessage("snkDataExporter.group.custom")}}getAllRecords(){return{id:r.EXPORT_ALL_RECORDS,label:this._getMessage("snkDataExporter.label.allRecords"),group:this._getMessage("snkDataExporter.group.custom")}}getExportPageToPDF(){return{id:r.EXPORT_PAGE_TO_PDF,label:"PDF (.pdf)"}}getExportPageToXLS(){return{id:r.EXPORT_PAGE_TO_XLS,label:`${this._getMessage("snkDataExporter.label.spreadsheet")} (.xls)`}}getExportAllRecordsToPDF(){return{id:r.EXPORT_ALL_RECORDS_TO_PDF,label:"PDF (.pdf)"}}getExportAllRecordsToXLS(){return{id:r.EXPORT_ALL_RECORDS_TO_XLS,label:`${this._getMessage("snkDataExporter.label.spreadsheet")} (.xlsx)`}}getExportByEmail(){return{id:r.EXPORT_BY_EMAIL,label:`${this._getMessage("snkDataExporter.label.sendByEmail")}...`}}getExportGroupName(){return this._selectedNumber===1?this._getMessage("snkDataExporter.group.export.selectedLine"):this._selectedNumber>1?this._getMessage("snkDataExporter.group.export.multiSelected").replace("{0}",this._selectedNumber.toString()):this._getMessage("snkDataExporter.group.export.default")}}function B(t,e,i){var s;return(s=t==null?void 0:t.messagesBuilder)===null||s===void 0?void 0:s.getMessage(e,i)}function j({fileSessionKey:t,isDownload:e}){const i=O.getContextValue("__SNK__APPLICATION__");window.open(`${window.location.protocol}//${window.location.hostname}:${window.location.port}/mge/visualizadorArquivos.mge?chaveArquivo=${t}${e?"&download=S":""}`),f.info(B(i,"fileViewer.message.exportSuccess"),{iconName:"check"})}function $(t){const i=`${O.getContextValue("__SNK__APPLICATION__").getModuleName()}@DataExporterSPBean.getPersonalizedReports`,s={serviceName:i,requestBody:t};return new Promise((n,o)=>S.get().callServiceBroker(i,x.objectToString(s)).then(a=>n(G(a))).catch(a=>o(a)))}function G(t){var e;const i=(e=t==null?void 0:t.json)===null||e===void 0?void 0:e.$;if(i!=null)return x.stringToObject(i)}const U=860;function A(t){const e=[];let i=0;for(const s of t){if(i+=s.width,i>=U)break;e.push(s)}return e}function X(t){return Object.keys(r).find(e=>r[e]===t)}var z=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(t!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,s=Object.getOwnPropertySymbols(t);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(t,s[n])&&(i[s[n]]=t[s[n]]);return i};class K{constructor(e){this._provider=e}async getParsedColumns(){const e=await this._provider.getColumnsMetadata();return A(e)}async getColumns(e){var i;return!((i=X(e==null?void 0:e.exportOption))===null||i===void 0)&&i.includes("PDF")?await this.getParsedColumns():await this._provider.getColumnsMetadata()}async getParams(e){var i,s,n,o,a,d;const l=(s=(i=this._provider).getFilters)===null||s===void 0?void 0:s.call(i),c=await this.getColumns(e),p=(o=(n=this._provider).getOrders)===null||o===void 0?void 0:o.call(n),u=(d=(a=this._provider).getResourceURI)===null||d===void 0?void 0:d.call(a),h=this._provider.getSelectedIDs(),P=e.exportOption,m=[r.EXPORT_PAGE_TO_PDF,r.EXPORT_PAGE_TO_XLS];delete e.exportOption;let _=Object.assign({filters:l,columns:c,sort:p,resourceURI:u,selectedIDs:h.slice(0,this._provider.getExportLimit())},e);if(m.includes(P)||e.type=="page"){const D=this._provider.getOffset(),v=this._provider.getPageSize();_=Object.assign(Object.assign({},_),{offset:D,limit:v,selectedIDs:[]})}else e.type=="all"&&(_=Object.assign(Object.assign({},_),{offset:0,limit:this._provider.getExportLimit(),selectedIDs:[]}));return Promise.resolve(_)}async executeExport(e){const i=await this.getParams(e),{methodName:s}=i,n=z(i,["methodName"]),a=`${O.getContextValue("__SNK__APPLICATION__").getModuleName()}@DataExporterSPBean.${s}`,d={serviceName:a,requestBody:n};return new Promise((l,c)=>{S.get().callServiceBroker(a,x.objectToString(d)).then(p=>l(this.getFormatResponse(p))).catch(p=>c(p))})}getFormatResponse(e){var i;const s=(i=e==null?void 0:e.json)===null||i===void 0?void 0:i.$;if(s!=null)return x.stringToObject(s)}}class V{constructor(e){this._provider=e}async getParsedColumns(){const e=await this._provider.getColumnsMetadata();return A(e)}async executeExport(e){var i;const{methodName:s,gridTitle:n}=e,o=await this._provider.getRecords(e.type),a=!((i=X(e==null?void 0:e.exportOption))===null||i===void 0)&&i.includes("PDF")?await this.getParsedColumns():await this._provider.getColumnsMetadata(),[d,l]=this.getExecutor(s),c={serviceName:d,requestBody:{grid:{gridTitle:n,columns:this.buildColumnsObject(a),rows:this.buildRowsObject(a,o),customOptions:{xlsxExtension:!1}}}};return new Promise((p,u)=>{S.get().callServiceBroker(d,c).then(h=>p(l(h))).catch(h=>u(h))})}getExecutor(e){return e==="exportToPDF"?["GridPDFBuilderSP.buildPDFFromJson",i=>({fileSessionKey:i.chavePDF.valor,canPrint:i.permiteImprimir.valor==="S",canExport:i.permiteExportar.valor==="S",canSendEmail:i.canSendEmail.valor==="S",useAppPrint:!0})]:["GridXLSBuilderSP.buildXLSFromJson",i=>({fileSessionKey:i.chaveXLS.valor,canPrint:!0,canExport:!0,canSendEmail:!0,useAppPrint:!1})]}buildColumnsObject(e){return{column:e.map((i,s)=>{const{label:n,id:o,width:a,userInterface:d}=i;return Object.assign({index:s+1,id:o,label:n,width:a,presentationType:"P"},H[d]||{type:"S",align:"left"})})}}buildRowsObject(e,i){return{row:i.map(s=>{const n={};return e.forEach((o,a)=>n["c"+(a+1)]={$:this.formatValue(s,o)}),n})}}formatValue(e,i){return this._provider.formatValue!=null?this._provider.formatValue(e,i):e[i.id]||""}}const H={[E.DATE]:{type:"D",align:"center"},[E.DATETIME]:{type:"H",align:"center"},[E.TIME]:{type:"I",align:"right"},[E.ELAPSEDTIME]:{type:"I",align:"right"},[E.DECIMALNUMBER]:{type:"F",align:"right"},[E.INTEGERNUMBER]:{type:"I",align:"right"},[E.SEARCH]:{type:"S",align:"right"}},W=".sc-snk-data-exporter-h{display:flex;width:fit-content;height:fit-content}.snk-data-exporter.sc-snk-data-exporter{display:flex;width:fit-content;height:fit-content}.snk-data-exporter__dropdown.sc-snk-data-exporter{display:none}.snk-data-exporter__dropdown--show.sc-snk-data-exporter{display:flex;flex-direction:column;position:fixed}.snk-data-exporter__dropdown.sc-snk-data-exporter>ez-dropdown.sc-snk-data-exporter{position:relative}",Y=class{constructor(t){y(this,t),this._selectedNumber=0,this._customPrefix="$custom$",this._releasedToExport=[r.EXPORT_TO_PDF,r.EXPORT_TO_XLS,r.EXPORT_BY_EMAIL,r.EXPORT_PDF_TO_EMAIL,r.EXPORT_XLS_TO_EMAIL,r.EXPORT_PAGE_TO_PDF,r.EXPORT_PAGE_TO_XLS,r.EXPORT_ALL_RECORDS_TO_PDF,r.EXPORT_ALL_RECORDS_TO_XLS],this._items=[],this._showDropdown=!1,this.provider=null,this.messagesBuilder=void 0}async exportByEmail(){const t=this._selectedNumber,e={type:t>0?"selection":"all",selectedRows:t,email:{attachments:[{name:this._appLabel}]},resolver:({type:i,format:s,email:{to:n,subject:o,message:a}})=>{var d;const l=(d=L[s==null?void 0:s.toUpperCase()])!==null&&d!==void 0?d:L.PDF;this.resolveExporter({type:i,methodName:l,to:n,subject:o,message:a,fileName:this._appLabel,gridTitle:this._appLabel},()=>{this._snkEmailSender.close(),f.info(this.getMessage("snkDataExporter.message.emailSuccess"),{iconName:"check"})})}};this._snkEmailSender.open(e)}getMessage(t,e){if(this.messagesBuilder==null){const i=N.getNearestInstance(this._element);i&&(this.messagesBuilder=i.messagesBuilder)}return this.messagesBuilder.getMessage(t,e)}positionDropdown(){var t;const e=(t=this._ezButton)===null||t===void 0?void 0:t.getBoundingClientRect();e==null||this._dropdownParent==null||(this._dropdownParent.style.top=e.y+e.height+5+"px",this._dropdownParent.style.left=e.x+"px")}closeDropdown(t){const e=t==null?void 0:t.target;e!=null&&(e.closest(".snk-data-exporter")||(this._showDropdown=!1))}setEvents(){document.removeEventListener("click",this.closeDropdown.bind(this)),document.addEventListener("click",this.closeDropdown.bind(this)),document.removeEventListener("scroll",this.positionDropdown.bind(this)),document.addEventListener("scroll",this.positionDropdown.bind(this))}controlDropdown(){this._showDropdown=!this._showDropdown}async resolveExporter(t,e){this.provider==null||t==null||e==null||this.getExporterStrategy().executeExport(t).then(i=>e(i)).catch(i=>{console.error(i);let{title:s,message:n,statusMessage:o}=i||{};f.error(s||this.getMessage("snkDataExporter.message.exportError"),o||n||this.getMessage("snkDataExporter.message.unknownFailure"))})}getExporterStrategy(){return this.provider.getRecords==null?new K(this.provider):new V(this.provider)}getOptionKey(t){return Object.keys(r).find(e=>r[e]===t)}getExportType(t){return t===r.EXPORT_ALL_RECORDS_TO_PDF||t===r.EXPORT_ALL_RECORDS_TO_XLS?R.ALL:t===r.EXPORT_PAGE_TO_PDF||t===r.EXPORT_PAGE_TO_XLS?R.PAGE:R.SELECTION}async dispatchExporter(t){var e,i,s;const n=this.getOptionKey(t),o=(e=b[n])!==null&&e!==void 0?e:b.EXPORT_TO_PDF,a={methodName:r[`EXPORT_TO_${o}`],fileName:this._appLabel,gridTitle:this._appLabel,exportOption:t,limit:(s=(i=this.provider)===null||i===void 0?void 0:i.getExportLimit)===null||s===void 0?void 0:s.call(i),type:this.getExportType(t)};await this.resolveExporter(a,d=>{d.canExport||o===b.EXPORT_TO_PDF?j(Object.assign(Object.assign({},d),{fileType:o})):f.error(this.getMessage("snkDataExporter.title.permission"),this.getMessage("snkDataExporter.message.exportPermission"))})}async processExporter(t){var e,i,s,n,o,a,d;const l=t==null?void 0:t.detail,c=[r.EXPORT_PAGE_TO_PDF,r.EXPORT_PAGE_TO_XLS],p=(e=l==null?void 0:l.id)===null||e===void 0?void 0:e.includes(this._customPrefix);if((l==null?void 0:l.id)===r.EXPORT_CURRENT_PAGE)return;const u=(i=this.provider)===null||i===void 0?void 0:i.getSelectedIDs(),h=(s=this.provider)===null||s===void 0?void 0:s.getTotalRecords(),P=(o=(n=this.provider)===null||n===void 0?void 0:n.getPageSize)===null||o===void 0?void 0:o.call(n),m=(d=(a=this.provider)===null||a===void 0?void 0:a.getExportLimit)===null||d===void 0?void 0:d.call(a);let _=!1;if(c.includes(l==null?void 0:l.id)&&P<=m||p?_=!1:u!=null&&u.length?_=u.length>m:h>m&&(_=!0),_){const D=m.toLocaleString("pt-BR",{minimumFractionDigits:0}),v={title:this.getMessage("snkDataExporter.limitExceeded.title"),description:`
          ${this.getMessage("snkDataExporter.limitExceeded.description",{limit:D})}
          <br/><br/>
          <b>
          ${this.getMessage("snkDataExporter.limitExceeded.subdescription")}
          </b>
        `,cancel:this.getMessage("snkDataExporter.limitExceeded.cancel"),confirm:this.getMessage("snkDataExporter.limitExceeded.continue")};if(!await f.confirm(v.title,v.description,null,k.WARN,{labelCancel:v.cancel,labelConfirm:v.confirm}))return}if(p){this.openPersonalizedReports(l.id),this._showDropdown=!1;return}this.getFilteredReleasedToExport().includes(l==null?void 0:l.id)&&(l.id===r.EXPORT_BY_EMAIL?this.exportByEmail():this.dispatchExporter(l.id),this._showDropdown=!1)}getFilteredReleasedToExport(){var t,e;if(this.provider==null)return this._releasedToExport;const i=(e=(t=this.provider).getHiddenOptions)===null||e===void 0?void 0:e.call(t);return i==null?this._releasedToExport:this._releasedToExport.filter(s=>!i.includes(s))}loadItems(){const t=[];this.getFilteredReleasedToExport().forEach(e=>{var i;(i=this._itemBuilder)===null||i===void 0||i.setExportOption(e,t)}),this.loadPersonalizedItems(t)}async loadPersonalizedItems(t){var e,i;const s=(i=(e=this.provider)===null||e===void 0?void 0:e.getRecordID)===null||i===void 0?void 0:i.call(e);if(s==null){this._items=t;return}const n=await $({recordID:s});n==null||n.forEach(o=>{t.push({id:`${this._customPrefix}_${o.ID}`,label:o.label,group:this.getMessage("snkDataExporter.group.custom")})}),this._items=t}openPersonalizedReports(t){var e,i;const s=[],n=(t==null?void 0:t.replace(this._customPrefix,""))||"";(i=(e=this.provider)===null||e===void 0?void 0:e.getSelectedIDs)===null||i===void 0||i.call(e).forEach(({name:o,type:a,value:d},l)=>{const c={};c.fields=[],l===0&&(s[`PK_${o}`]={type:this.parseDataType(a),value:d},s.pks=[]);const p={nome:`PK_${o}`,tipo:this.parseDataType(a),valor:d};c.fields.push(p),s.pks.push(c)}),this._application.openApp(`${M}${n}`,s)}parseDataType(t){switch(t){case w.NUMBER:return"I";case w.DATE:return"D";default:return"S"}}loadDropdown(){var t;this._selectedNumber=((t=this.provider)===null||t===void 0?void 0:t.getSelectedNumber())||0,this._itemBuilder=new F(this.getMessage.bind(this),this._selectedNumber),this.loadItems()}getElementID(t){return{[T.DATA_ELEMENT_ID_ATTRIBUTE_NAME]:T.getInternalIDInfo(t)}}canShowDropdown(){var t;return this._showDropdown&&((t=this._items)===null||t===void 0?void 0:t.length)>0}componentWillLoad(){var t;this._application=O.getContextValue("__SNK__APPLICATION__"),(t=this._application)===null||t===void 0||t.getAppLabel().then(e=>this._appLabel=e),this.setEvents()}componentDidLoad(){this._element!=null&&(T.addIDInfo(this._element),this.positionDropdown())}componentWillUpdate(){var t;this._showDropdown&&!(!((t=this._items)===null||t===void 0)&&t.length)&&this.loadDropdown()}componentDidUpdate(){var t;this._showDropdown?this.positionDropdown():((t=this._items)===null||t===void 0?void 0:t.length)>0&&(this._items=[])}render(){return g(C,null,g("div",{class:`snk-data-exporter
          ${this.canShowDropdown()?" ez-elevation--16":""}
        `},g("ez-button",Object.assign({ref:t=>this._ezButton=t,iconName:"file-download",size:"small",mode:"icon",title:this.getMessage("snkDataExporter.group.export.title"),onClick:()=>this.controlDropdown()},this.getElementID("button"))),g("div",Object.assign({ref:t=>this._dropdownParent=t,class:`snk-data-exporter__dropdown
              ${this.canShowDropdown()?"snk-data-exporter__dropdown--show":""}
            `},this.getElementID("dropdown")),this.canShowDropdown()&&g("ez-dropdown",Object.assign({items:this._items,onEzClick:t=>this.processExporter(t)},this.getElementID("dropdown"))))),this.canShowDropdown()&&g("div",Object.assign({class:"ez-scrim ez-scrim--light"},this.getElementID("ezScrim"))),g("snk-exporter-email-sender",Object.assign({ref:t=>this._snkEmailSender=t,getMessage:(t,e)=>this.getMessage(t,e)},this.getElementID("snkExporterEmailSender"))))}get _element(){return I(this)}};Y.style=W;export{Y as snk_data_exporter};
//# sourceMappingURL=snk-data-exporter.entry-gc0iawky.js.map

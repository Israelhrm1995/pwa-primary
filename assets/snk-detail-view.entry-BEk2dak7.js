import{r as S,c as g,f as k,h as n,H as C,g as R}from"./index-ChOtpOHD.js";import{A as E,S as M}from"./dataUnitInMemoryLoader-BjgoPaoq.js";import{K as F}from"./index-dokJR7Uh.js";import{S as I}from"./SnkFormConfigManager-d64d62d6-CQQ8yzXS.js";import{b as w,F as G}from"./FormMetadata-CURdpt0q.js";import"./FormLayout-pPi2ZB-q.js";import"./DataFetcher-db08cad0-B7lG84WQ.js";import"./ISave-da565824-Ad8ZGazV.js";import{P as y}from"./index-b40568ff-7Mtm7E1e.js";import"./dataunit-fetcher-1b78797a-Cmcgnk35.js";import"./filter-item-type.enum-d45e026f-B41QHsvD.js";import"./form-config-fetcher-e623539b-By6wLJV7.js";import{V as r}from"./constants-7b422de0-BRz2gykn.js";import{T as h}from"./taskbar-elements-171476d4-B0pY5djo.js";import{snk_guides_viewer as D}from"./snk-guides-viewer.entry-DTmlvpPK.js";import{S as T}from"./SnkMessageBuilder-6327dfe7-D9Ev566n.js";import{b as A,S as U,L as N}from"./search-column-Da0RZOkA.js";import"./ConfigStorage-89154c4e-iTHVKliQ.js";import"./PrintUtils-3e4ff0f5-DDjQRNo9.js";import"./index-b72af127-9QtucbV0.js";import"./ApplicationContext-B_qAnYBt.js";import"./constants-CKEKe-xZ.js";import"./ResourceIDUtils-a114189a-BM9f4Nxo.js";import"./taskbar-processor-3436124c-7XYCPk7j.js";import"./index-BdigElPL.js";class v{constructor(t,i,s){this._parentGuide=t,this._formMetadata=i,this._dataUnit=s}get id(){return this._parentGuide.id}buildGuideItem(t){const i=Object.assign({},this._parentGuide);delete i.expanded,delete i.children;const s=this._dataUnit.getSelectedRecord();if(!s)return i;const o=this._dataUnit.isNewRecord(s.__record__id__),d=Array.from(this._formMetadata.getAllSheets().values()).map(l=>{const{name:c,label:b}=l,u=G.getDetailName(c.split("::").pop())!=null,m=u&&o,p=this._parentGuide.id,f=u?`${p}::${c}`:`${p}__FORM:${c}`;return u&&t.has(f)&&!m?t.get(f).buildGuideItem(t):{id:f,label:b,disabled:m,tooltip:m?"Finalize o cadastro para ter acesso a esta guia.":void 0}}),a=d.shift();return a.label=o?"Novo Registro":s.__record__label__,a.children=d,i.children=[a],i}}const B=".sc-snk-detail-view-h{display:flex;row-gap:24px;flex-direction:column;width:100%;height:100%}.level-path.sc-snk-detail-view{color:var(--color--title-primary, #2B3A54);font-weight:var(--text-weight--medium, 400);padding-right:3px}.form-taskbar.sc-snk-detail-view{padding-bottom:var(--space--medium)}.grid-container.sc-snk-detail-view{background-color:#FFF;min-height:100px;height:100%}.detail-header.sc-snk-detail-view{padding-bottom:0}snk-data-unit.sc-snk-detail-view{flex:1}snk-grid.sc-snk-detail-view{height:calc(100% - 43px)}",_=class{constructor(e){S(this,e),this.snkDetailGuidesChange=g(this,"snkDetailGuidesChange",7),this.snkSwitchGuide=g(this,"snkSwitchGuide",7),this.formItemsReady=g(this,"formItemsReady",7),this._disabledButtons=void 0,this._currentView=void 0,this.attachmentRegisterKey=void 0,this._fieldToGetFocus=void 0,this._hasToCreateFieldSearch=!0,this.formConfigManager=void 0,this.dataUnitName=void 0,this.resourceID=void 0,this.guideItemPath=void 0,this.entityName=void 0,this.label=void 0,this.dataUnit=void 0,this.selectedForm=void 0,this.dataState=void 0,this.messagesBuilder=void 0,this.branchGuide=void 0,this.canEdit=!0,this.taskbarCustomContainerId=void 0,this.customEditors=void 0,this.customRenders=void 0,this.presentationMode=y.SECONDARY}observeDataUnit(e,t){e==null||e.subscribe(this.dataUnitActionHandler.bind(this)),t==null||t.unsubscribe(this.dataUnitActionHandler)}observerDataState(e,t){const i=!(t!=null&&t.insertionMode)&&(e==null?void 0:e.insertionMode),s=(t==null?void 0:t.insertionMode)&&!(e!=null&&e.insertionMode);if((i||s)&&this.loadMetadata(),this._formMetadata==null)return;const o=e==null?void 0:e.selectedRecord,d=t==null?void 0:t.selectedRecord;(o==null?void 0:o.__record__id__)!==(d==null?void 0:d.__record__id__)&&this.snkDetailGuidesChange.emit(new v(this.branchGuide,this._formMetadata,this.dataUnit)),i&&setTimeout(()=>{this.changeViewMode(r.FORM)},0),s&&this.changeViewMode(r.GRID);const a=[];this.dataState.hasPrevious||a.push(h.PREVIOUS),this.dataState.hasNext||a.push(h.NEXT),this.dataState.insertionMode&&a.push(h.INSERT),this._disabledButtons=a}async changeViewMode(e){this.emitSwitchEvent(e)}async configGrid(){this._snkGrid&&this._snkGrid.showConfig()}async showUp(){this._snkFormView&&this._snkFormView.showUp(),this._snkGrid&&this._snkGrid.scrollIntoView({behavior:"smooth",block:"start"})}async addCustomEditor(e,t){var i;const s=this.normalizeBranchGuideId((i=this.branchGuide)===null||i===void 0?void 0:i.id);this._snkGrid.addCustomEditor(e,t,s),this._snkFormView.addCustomEditor(e,t,s)}async observerPropsCustomEditor(e){for(const t in e)await this.addCustomEditor(t,e[t])}async addGridCustomRender(e,t){var i;const s=this.normalizeBranchGuideId((i=this.branchGuide)===null||i===void 0?void 0:i.id);await this._snkGrid.addGridCustomRender(e,t,s)}onContentCardChanged(e){D.updateContentCard(e.detail.formName,e.detail.cardConfig,e.detail.propertyChanged,this.formConfigManager).then(()=>k(this)),e.stopPropagation()}async observeCustomRenders(e){for(const t in e){const i=e[t];await this.addGridCustomRender(t,i)}}updateLabel(){const e=this.guideItemPath?this.guideItemPath.length:0;if(e>0){const t=e>0?this.guideItemPath.map(i=>i.label):void 0;this.label=t.pop(),this._levelPath=t.length>0?t.join(" / "):void 0}else this.label="",this._levelPath=void 0}getFormGuideId(e){var t;if(!e){if(((t=this.dataState)===null||t===void 0?void 0:t.selectedRecord)==null)return;const s=Array.from(this._formMetadata.getAllSheets().keys());if(!s||s.length==0)return;e=s[0]}return`${this.stripFormPattern(this.branchGuide.id)}__FORM:${e}`}stripFormPattern(e){return e.replace(_.REGEX_FORM_ID,"")}loadMetadata(){if(!this.dataUnit||!this.formConfigManager.isLoaded)return;const e=this.formConfigManager.getConfig(this.dataUnit);this._formMetadata=w(e==null||e.fields.length===0?void 0:e,this.dataUnit,!0)}dataUnitReadyHandler(e){this.dataUnit=e.detail,this.loadMetadata()}updateViewStack(e){var t,i;this._viewStack=e,this._currentView=this.selectedForm?1:0,(i=(t=this._viewStack)===null||t===void 0?void 0:t.show)===null||i===void 0||i.call(t,this._currentView)}getFormFields(){return this.selectedForm&&this._formMetadata?this._formMetadata.getSheet(this.selectedForm).fields:[]}emitSwitchEvent(e){const t=e===r.GRID?this.stripFormPattern(this.branchGuide.id):this.getFormGuideId();t&&this.snkSwitchGuide.emit(t)}handleAttachBack(){this._viewStack.show(r.GRID)}executeActionHandler(e){e.detail===h.GRID_MODE&&(this.emitSwitchEvent(r.GRID),e.stopPropagation()),(e.detail===h.FORM_MODE||e.detail===h.UPDATE)&&(this.emitSwitchEvent(r.FORM),e.stopPropagation()),e.detail===h.ATTACH&&(this._viewStack.show(r.ATTACHMENT),e.stopPropagation())}async getAttachmentRegisterKey(){return this._snkDataUnit?(await this._snkDataUnit.getSelectedRecordsIDsInfo()).map(({value:i})=>i).join("_"):void 0}async handleDataStateChange({detail:e}){this.dataState=e,e.selectedRecord!==void 0&&this._snkDataUnit&&(this.attachmentRegisterKey=await this.getAttachmentRegisterKey())}componentWillLoad(){this._configName=`dynaform.${this.entityName}`,this.formConfigManager=new I(this._configName,this.resourceID,()=>this.loadMetadata(),this.dataUnit),this.formConfigManager.loadConfig(),this.messagesBuilder==null&&(this.messagesBuilder=new T(this.entityName))}async componentDidLoad(){await this.observerPropsCustomEditor(this.customEditors),await this.observeCustomRenders(this.customRenders),this.initKeyboardManager()}disconnectedCallback(){var e;(e=this._keyboardManager)===null||e===void 0||e.unbindAllShortcutKeys()}async dataUnitActionHandler(e){e.type===E.FIELD_INVALIDATED&&this.addErrorBadgeToBranchGuide()}addErrorBadgeToBranchGuide(){this.branchGuide=Object.assign(Object.assign({},this.branchGuide),{badge:"error"}),this.snkDetailGuidesChange.emit(new v(this.branchGuide,this._formMetadata,this.dataUnit))}normalizeBranchGuideId(e){return e==null?void 0:e.replace(/child\[(.*?)\]/g,"$1").replace(/::/g,">")}getSettingsListForm(){return[{value:M.generateUUID(),label:this.messagesBuilder.getMessage("snkCrud.findColumn",void 0),disableCloseOnSelect:!0,eagerInitialize:!0,itemBuilder:(t,i)=>this.getFieldsSearch(i)}]}getFieldsSearch(e){return(this._fieldSearch==null||this._hasToCreateFieldSearch)&&(this._hasToCreateFieldSearch=!1,this._fieldSearch=A(e,({argument:t})=>this.fieldsOptionLoader(t),t=>this.onSelectField(t))),this._fieldSearch}fieldsOptionLoader(e){const t=e==null?void 0:e.toLowerCase(),o=this.getFormFields().map(d=>{var a;return(a=this.dataUnit)===null||a===void 0?void 0:a.getField(d.name)}).filter(d=>{var a,l;return((a=d.name)===null||a===void 0?void 0:a.toLowerCase().includes(t))||((l=d.label)===null||l===void 0?void 0:l.toLowerCase().includes(t))}).map(d=>({value:d.name,label:d.label}));return Promise.resolve(o)}onSelectField(e){e!=null&&(this._fieldToGetFocus=e.value)}clearFieldToFocusHandler(){this._fieldToGetFocus=void 0}async initKeyboardManager(){this._keyboardManager=new F({propagate:!1,element:this._element}),this._keyboardManager.bind(U,async()=>{await this._snkFormView.showSearchField()},{description:N,element:this._element})}render(){return this.updateLabel(),n(C,null,n("snk-data-unit",{ref:e=>this._snkDataUnit=e,dataUnitName:`${this.dataUnitName}`,onDataUnitReady:e=>this.dataUnitReadyHandler(e),entityName:this.entityName,onDataStateChange:this.handleDataStateChange.bind(this),ignoreSaveMessage:this._currentView===r.GRID,messagesBuilder:this.messagesBuilder,configName:this._configName},n("ez-view-stack",{ref:e=>this.updateViewStack(e)},n("stack-item",null,n("div",{class:"ez-box ez-box--shadow grid-container"},n("div",{class:"ez-title--primary ez-size-width--full ez-padding--large detail-header"},n("div",{class:"ez-flex ez-text ez-text--bold ez-flex--justify-start ez-flex--align-items-center"},this._levelPath?n("span",{class:"level-path"},this._levelPath+" /"):void 0,this.label)),n("snk-grid",{class:"ez-size-width--full",ref:e=>this._snkGrid=e,configName:this._configName,messagesBuilder:this.messagesBuilder,onGridDoubleClick:()=>this.emitSwitchEvent(r.FORM),onActionClick:e=>this.executeActionHandler(e),presentationMode:this.presentationMode,canEdit:this.canEdit,isDetail:!0,taskbarCustomContainerId:this.taskbarCustomContainerId,gridHeaderCustomSlotId:"DETAIL_GRID_HEADER_CUSTOM_ELEMENTS",topTaskbarCustomSlotId:"DETAIL_GRID_TASKBAR_CUSTOM_ELEMENTS",outlineMode:!1}))),n("stack-item",null,n("snk-form-view",{ref:e=>this._snkFormView=e,canExpand:!1,canFix:!1,name:this.selectedForm,formMetadata:this._formMetadata,dataUnit:this.dataUnit,fields:this.getFormFields(),fieldToFocus:this._fieldToGetFocus,label:this.label,levelPath:this._levelPath,onFormItemsReady:({detail:e})=>this.formItemsReady.emit(e),onSnkRequestClearFieldToFocus:this.clearFieldToFocusHandler.bind(this),fieldSearch:this._fieldSearch},n("snk-taskbar",{key:"guideViewerTaskbar",class:"form-taskbar","data-element-id":"guideViewer",configName:this._configName,messagesBuilder:this.messagesBuilder,disabledButtons:this._disabledButtons,buttons:"INSERT,PREVIOUS,NEXT,DIVIDER,CLONE,REMOVE,MORE_OPTIONS,DIVIDER,GRID_MODE,CONFIGURATOR",primaryButton:"INSERT",presentationMode:this.presentationMode,onActionClick:e=>this.executeActionHandler(e),dataUnit:this.dataUnit,resourceID:this.resourceID,customContainerId:this.taskbarCustomContainerId,customSlotId:"DETAIL_TASKBAR_CUSTOM_ELEMENTS",actionsSettingsList:this.getSettingsListForm()},n("slot",{name:"DETAIL_TASKBAR_CUSTOM_ELEMENTS"})))),n("stack-item",null,n("snk-attach",{registerKey:this.attachmentRegisterKey,messagesBuilder:this.messagesBuilder,entityName:this.entityName,onBack:this.handleAttachBack.bind(this)})))))}get _element(){return R(this)}static get watchers(){return{dataUnit:["observeDataUnit"],dataState:["observerDataState"],customEditors:["observerPropsCustomEditor"],customRenders:["observeCustomRenders"]}}};_.REGEX_FORM_ID=/__FORM:[^:]+/g;_.style=B;export{_ as snk_detail_view};
//# sourceMappingURL=snk-detail-view.entry-BEk2dak7.js.map

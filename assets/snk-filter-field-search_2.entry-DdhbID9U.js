import{r as b,c as y,h as s,g as S}from"./index-ChOtpOHD.js";import{S as g}from"./index-620ac460-DzCD8Y6b.js";import{J as _,E as m,S as d,D as F,U as l}from"./dataUnitInMemoryLoader-BjgoPaoq.js";import{A as f}from"./ApplicationContext-B_qAnYBt.js";import{M as T}from"./modal-action-DYa1rU64.js";import"./modal-button-status-OTEz8c7N.js";import{b as r,c as p,d as E}from"./index-8acbae97-DxLtPl40.js";import{P as k}from"./PersonalizedFilterUtils-2db38ff2-DFX-27dU.js";import"./filter-item-type.enum-d45e026f-B41QHsvD.js";const z={[l.SHORTTEXT]:"text",[l.LONGTEXT]:"text",[l.INTEGERNUMBER]:"number",[l.DECIMALNUMBER]:"number",[l.DATE]:"calendar",[l.DATETIME]:"calendar",[l.SWITCH]:"boolean",[l.CHECKBOX]:"check-circle-inverted",[l.OPTIONSELECTOR]:"list",[l.SEARCH]:"search",[l.HTML]:"tag_code",[l.IMAGE]:"png",[l.FILE]:"edit-file",[l.TIME]:"timer-outline",[l.ELAPSEDTIME]:"timer",[l.MASKEDTEXT]:"text",[l.PASSWORD]:"email"},O=({userInterface:e,description:t})=>s("ez-icon",{iconName:z[e],class:"ez-padding-left--small",title:t}),x=".sc-snk-filter-field-search-h{--snk-filter-field-search--container-width:468px;--snk-filter-field-search--container-height:322px}.snk-filter-field-search__container.sc-snk-filter-field-search{display:flex;flex-direction:column;padding:var(--space--medium);width:var(--snk-filter-field-search--container-width);height:var(--snk-filter-field-search--container-height)}.snk-filter-field-search__section.sc-snk-filter-field-search{display:grid;grid-template-columns:1fr 1fr;place-items:flex-start;overflow:hidden;gap:var(--space--small)}.snk-filter-field-search__input.sc-snk-filter-field-search{margin-bottom:var(--space--medium)}.snk-filter-field-search__list_container.sc-snk-filter-field-search{display:flex;flex-direction:column}.snk-filter-field-search__list.sc-snk-filter-field-search{overflow-y:auto}",v="__SNK__APPLICATION__",L=/\w+:\/\/(\w+)/,N=class{constructor(e){b(this,e),this.ezSelectFilterItem=y(this,"ezSelectFilterItem",7),this._currentMetadata=null,this._filterText="",this._isLoading=!1,this.searchable=!0,this.fieldsDataSource=void 0,this.breadcrumbItems=[],this.linkItems=[],this.fieldItems=[],this.searchEmpty=!1,this.groupEmpty=!1}async show(e,t){var i;return e?(i=this._ezPopover)===null||i===void 0||i.showUnder(e,t):this._ezPopover.show(),this.loadData()}async applyFilter(e){if(this.searchable)throw new Error("This method is not available when searchable is true");this.handleFilterChange(e)}async loadData(){var e,t;this._isLoading=!0;let i=await this.fieldsDataSource.fetchData(this._currentLink);this._currentLink=i.currentLink;const{fields:n,links:a}=i||{};if(!Array.isArray(n)||!Array.isArray(a))throw new Error("Invalid metadata");this._currentMetadata=i,this.mapDataSourceToLinkItems(),this.mapDataSourceToFieldItems(),this._isLoading=!1,(e=this._ezFieldList)===null||e===void 0||e.scrollToTop(),(t=this._ezLinkList)===null||t===void 0||t.scrollToTop()}mapDataSourceToLinkItems(){var e;const{links:t}=this._currentMetadata,i=this.getMessage("snkFilterFieldSearch.linkLabel",{link:(e=this._currentLink)===null||e===void 0?void 0:e.description}),n=t.map(a=>Object.assign({label:a.description},a));this.groupEmpty=n.length===0,this.linkItems=[{group:i,items:n}],this.breadcrumbItems.length===0&&(this.breadcrumbItems=[Object.assign({id:_.generateUUID(),label:this._currentLink.description},this._currentLink)])}mapDataSourceToFieldItems(){var e;const t=this._currentMetadata.fields,i=this.getMessage("snkFilterFieldSearch.fieldLabel",{link:(e=this._currentLink)===null||e===void 0?void 0:e.description}),a=t.filter(o=>{if(!this._currentLink)return!0;const c=o.description.toLowerCase().includes(this._filterText.toLowerCase()),h=o.name.toLowerCase().includes(this._filterText.toLowerCase());return c||h}).map(o=>Object.assign({label:o.description},o));this.searchEmpty=!!(this._filterText&&a.length===0),this.fieldItems=[{group:i,items:a}]}handleFilterChange(e){this._isLoading||(this._filterText=e,this.mapDataSourceToFieldItems())}handleSelectLink({detail:e}){if(this._isLoading)return;const t=this.breadcrumbItems.findIndex(n=>n.id===e.id);t>-1?this.breadcrumbItems=this.breadcrumbItems.slice(0,t+1):this.breadcrumbItems=[...this.breadcrumbItems,Object.assign({id:_.generateUUID(),label:e.description},e)];const i=Object.assign(Object.assign({},e),{type:g.LINK});this._currentLink=i,this.ezSelectFilterItem.emit(i),this.loadData()}getEntityFromBreadCrumbItem(e){const t=L.exec(e.uri);if(t)return t[1]}handleSelectField({detail:e}){var t;const i=this.breadcrumbItems.map(a=>a.label).join(">>"),n=Object.assign(Object.assign({},e),{type:g.FIELD,entityPath:this.breadcrumbItems.map(a=>this.getEntityFromBreadCrumbItem(a)).filter(a=>a!=null),path:`${i} >> ${e.description}`});this.ezSelectFilterItem.emit(n),(t=this._ezPopover)===null||t===void 0||t.hide()}getElementID(e){return{[m.DATA_ELEMENT_ID_ATTRIBUTE_NAME]:m.getInternalIDInfo(e)}}getMessage(e,t){var i,n,a;return this._application||(this._application=f.getContextValue(v)),(a=(n=(i=this._application)===null||i===void 0?void 0:i.messagesBuilder)===null||n===void 0?void 0:n.getMessage)===null||a===void 0?void 0:a.call(n,e,t)}componentWillLoad(){this._application=f.getContextValue(v)}componentDidLoad(){m.addIDInfoIfNotExists(this._ezPopover,"popover")}disconnectedCallback(){var e;(e=this._ezPopover)===null||e===void 0||e.hide()}render(){var e;const t=this.getMessage("snkFilterFieldSearch.searchLabel");return s("ez-popover",Object.assign({ref:i=>this._ezPopover=i,role:"dialog",overlayType:"none","aria-hidden":!(!((e=this._ezPopover)===null||e===void 0)&&e.opened)},this.getElementID("EzPopover")),s("div",{class:"snk-filter-field-search__container"},s("header",{class:"snk-filter-field-search__header"},this.searchable&&!!t&&s("ez-filter-input",Object.assign({class:"snk-filter-field-search__input",label:t,asyncSearch:!0,canShowError:!1,onEzSearching:i=>this.handleFilterChange.bind(this)(i.detail),"aria-label":t,"aria-required":"false","aria-invalid":"false"},this.getElementID("EzFilterInput"))),this.breadcrumbItems.length>0&&s("ez-breadcrumb",Object.assign({items:this.breadcrumbItems,onSelectedItem:this.handleSelectLink.bind(this),role:"navigation","aria-current":"step"},this.getElementID("EzBreadcrumb"))),s("hr",{class:"ez-divider-horizontal ez-margin-vertical--medium"})),s("section",{class:`snk-filter-field-search__section ${this.groupEmpty&&this.searchEmpty&&" ez-margin--auto"}`},this.groupEmpty?s("div",{class:"ez-margin--auto"},s("span",{class:"ez-text ez-text--secondary ez-text--medium"},this.getMessage("snkFilterFieldSearch.groupEmpty"))):s("ez-list",Object.assign({ref:i=>this._ezLinkList=i,class:"snk-filter-field-search__list",id:"filterLinkList",useGroups:!0,dataSource:this.linkItems,onEzSelectItem:this.handleSelectLink.bind(this),hoverFeedback:!0,ezSelectable:!0,itemSlotBuilder:i=>s("ez-badge",{label:i.fieldCount}),"aria-describedby":"filterLinkLabel"},this.getElementID("EzListLinks"))),this.searchEmpty?s("div",{class:"ez-margin--auto"},s("span",{class:"ez-text ez-text--secondary ez-text--medium"},this.getMessage("snkFilterFieldSearch.searchEmpty"))):s("ez-list",Object.assign({ref:i=>this._ezFieldList=i,class:"snk-filter-field-search__list",id:"filterFieldList",useGroups:!0,dataSource:this.fieldItems,onEzSelectItem:this.handleSelectField.bind(this),hoverFeedback:!0,ezSelectable:!0,itemSlotBuilder:O,"aria-describedby":"filterFieldLabel"},this.getElementID("EzListFields"))))))}};N.style=x;const M=":host{--snk-filter-param-config__expression--color:var(--title--primary, #2b3a54);display:flex;position:relative}.snk-filter-param-config__expression{--text-area__input--disabled--color:var(--snk-filter-param-config__expression--color)}",D=class{constructor(e){b(this,e),this._opened=!1,this._configType=r.SYSTEM_CONFIG,this._expressionItem=void 0,this._informedInstance=!1,this._canSave=!1,this.messagesBuilder=void 0}open(e){return this._opened=!0,this._expressionItem=e,this.loadValues(),new Promise(t=>{this._promiseResolver=t})}close(){return this._opened=!1,new Promise(e=>{this._promiseResolver=e})}getMessage(e,t){var i;return(i=this.messagesBuilder)===null||i===void 0?void 0:i.getMessage(e,t)}getConfigValue(e,t,i=""){var n,a,o;return((a=(n=this._expressionItem)===null||n===void 0?void 0:n[e])===null||a===void 0?void 0:a[t])||((o=this._expressionItem)===null||o===void 0?void 0:o[i||t])}loadValues(){var e;const t=this.getConfigValue("systemConfig","entity","entityName"),i=this.getConfigValue("systemConfig","fieldName"),n=this.getConfigValue("userConfig","description"),a=this.getConfigValue("userConfig","type");((e=this._expressionItem)===null||e===void 0?void 0:e.userConfig)!=null?this._configType=r.USER_CONFIG:this._configType=r.SYSTEM_CONFIG,!d.isEmpty(t)&&!d.isEmpty(i)&&(this._instanceElement.value={value:t,label:""},this._fieldElement.value={value:i,label:""}),!d.isEmpty(n)&&!d.isEmpty(a)&&(this._descriptionElement.value=n,this._typeElement.value=a),this.buildFilterExpression()}changeDefinitionUsed(e){if(this._configType=e??r.SYSTEM_CONFIG,this._configType===r.SYSTEM_CONFIG){const t=this.getConfigValue("systemConfig","entity","entityName"),i=this.getConfigValue("systemConfig","fieldName");this._instanceElement.value=this._instanceElement.value||{value:t,label:""},this._fieldElement.value=this._fieldElement.value||{value:i,label:""}}else if(this._configType===r.USER_CONFIG){const t=this.getConfigValue("userConfig","description"),i=this.getConfigValue("userConfig","type");this._descriptionElement.value=this._descriptionElement.value||t,this._typeElement.value=this._typeElement.value||i}this.buildFilterExpression()}getTypeValue(){var e;const t=(e=this._typeElement)===null||e===void 0?void 0:e.value;return(t==null?void 0:t.value)||t}getExpressionValues(){var e,t,i,n,a;let o,c;if(this._configType===r.SYSTEM_CONFIG){const h=(t=(e=this._instanceElement)===null||e===void 0?void 0:e.value)===null||t===void 0?void 0:t.value,u=(n=(i=this._fieldElement)===null||i===void 0?void 0:i.value)===null||n===void 0?void 0:n.value;o={entity:h,fieldName:u}}else if(this._configType===r.USER_CONFIG){const h=(a=this._descriptionElement)===null||a===void 0?void 0:a.value,u=this.getTypeValue();c={description:h,type:u}}return Object.assign(Object.assign(Object.assign({},this._expressionItem),{systemConfig:o}),{userConfig:c})}isEnabled(e){return this._configType===e}isInformedInstance(){var e,t;return!d.isEmpty((t=(e=this._instanceElement)===null||e===void 0?void 0:e.value)===null||t===void 0?void 0:t.value)}save(){var e;this._expressionItem=Object.assign(Object.assign({},this.getExpressionValues()),{expression:(e=this._expressionElement)===null||e===void 0?void 0:e.value}),this._promiseResolver(this._expressionItem),this._opened=!1}buildFilterExpression(){var e;this._informedInstance=this.isInformedInstance();const t=k.buildFilterExpression(this.getExpressionValues());this._expressionElement.value=t||((e=this._expressionItem)===null||e===void 0?void 0:e.expression),this._canSave=this.getCanSave()}handleChangeInstance(){this._informedInstance=this.isInformedInstance(),this._fieldElement!=null&&!d.isEmpty(this._fieldElement.value)&&(this._fieldElement.value=null),this.buildFilterExpression()}getInstanceCriteria(){var e,t;const i=(t=(e=this._instanceElement)===null||e===void 0?void 0:e.value)===null||t===void 0?void 0:t.value;return{expression:"this.NOMETAB = (SELECT NOMETAB FROM TDDINS WHERE NOMEINSTANCIA = ?)",params:[{name:"NOMEINSTANCIA",dataType:F.TEXT,value:i}]}}onSearch({mode:e,argument:t},i){if(this._application==null||!this._opened)return;const n=i===p.FIELD,a=n?this.getInstanceCriteria():void 0,o=`snkFilterParamConfig.label${n?"Field":"Instance"}`,c=this.getMessage(o),u={entity:i,entityDescription:c,criteria:a,searchOptions:{descriptionFieldName:n?"DESCRCAMPO":"DESCRINSTANCIA",codeFieldName:n?"NOMECAMPO":"NOMEINSTANCIA",showInactives:!1}};return new Promise(I=>{this._application.executePreparedSearch(e,t,u).then(C=>I(C))})}getElementID(e){return{[m.DATA_ELEMENT_ID_ATTRIBUTE_NAME]:m.getInternalIDInfo(e)}}getCanSave(){var e;if(this._configType===r.USER_CONFIG){const t=(e=this._descriptionElement)===null||e===void 0?void 0:e.value,i=this.getTypeValue();return!d.isEmpty(t)&&!d.isEmpty(i)}return!0}componentWillLoad(){this._application=f.getContextValue("__SNK__APPLICATION__")}render(){return m.addIDInfoIfNotExists(this._element,"snkFilterParamConfig"),s("ez-popup",Object.assign({useHeader:!1,size:"small",heightMode:"auto",opened:this._opened},this.getElementID("popup")),s("ez-modal-container",Object.assign({onEzModalAction:e=>{e.detail===T.CLOSE&&this.close()},modalTitle:this.getMessage("snkFilterParamConfig.modalTitle")},this.getElementID("modalContainer")),s("div",{class:"ez-flex"},s("div",{class:"ez-col ez-col--sd-6 ez-flex--column"},s("ez-radio-button",Object.assign({value:this._configType,onEzChange:e=>this.changeDefinitionUsed(e.detail)},this.getElementID("systemConfigOption")),s("ez-radio-button-option",{label:this.getMessage("snkFilterParamConfig.labelSystemConfig"),value:r.SYSTEM_CONFIG})),s("ez-search",Object.assign({ref:e=>this._instanceElement=e,label:this.getMessage("snkFilterParamConfig.labelInstance"),enabled:this.isEnabled(r.SYSTEM_CONFIG),suppressEmptyOption:!0,showOptionValue:!1,showSelectedValue:!1,onEzChange:()=>this.handleChangeInstance(),optionLoader:e=>this.onSearch(e,p.INSTANCE)},this.getElementID("configFindEntity"))),s("ez-search",Object.assign({ref:e=>this._fieldElement=e,label:this.getMessage("snkFilterParamConfig.labelField"),enabled:this.isEnabled(r.SYSTEM_CONFIG)&&this._informedInstance,suppressEmptyOption:!0,showOptionValue:!1,showSelectedValue:!1,onEzChange:()=>this.buildFilterExpression(),optionLoader:e=>this.onSearch(e,p.FIELD)},this.getElementID("configFindField")))),s("div",{class:"ez-flex ez-padding--medium"},s("hr",{class:"ez-divider-vertical"})),s("div",{class:"ez-col ez-col--sd-6 ez-flex--column"},s("ez-radio-button",Object.assign({value:this._configType,onEzChange:e=>this.changeDefinitionUsed(e.detail)},this.getElementID("userConfigOption")),s("ez-radio-button-option",{label:this.getMessage("snkFilterParamConfig.labelUserConfig"),value:r.USER_CONFIG})),s("ez-text-input",Object.assign({ref:e=>this._descriptionElement=e,label:this.getMessage("snkFilterParamConfig.labelDescription"),enabled:this.isEnabled(r.USER_CONFIG),onEzChange:()=>this.buildFilterExpression()},this.getElementID("configParamLabel"))),s("ez-combo-box",Object.assign({ref:e=>this._typeElement=e,label:this.getMessage("snkFilterParamConfig.labelType"),enabled:this.isEnabled(r.USER_CONFIG),suppressEmptyOption:!0,onEzChange:()=>this.buildFilterExpression()},this.getElementID("configParamType")),Object.keys(E).map(e=>s("option",{value:E[e]},this.getMessage(`snkFilterParamConfig.labelTypeValues.${e.toLowerCase()}`)))))),s("ez-text-area",Object.assign({ref:e=>this._expressionElement=e,class:"snk-filter-param-config__expression",label:this.getMessage("snkFilterParamConfig.labelExpression"),enabled:!1},this.getElementID("presentationExpression"))),s("div",{class:"ez-col ez-col--sd-12 ez-flex--justify-end ez-margin-vertical--small"},s("ez-button",Object.assign({class:"ez-padding-right--medium",label:this.getMessage("snkFilterParamConfig.labelCancel"),onClick:()=>this.close()},this.getElementID("cancelEditParam"))),s("ez-button",Object.assign({class:"ez-button--primary",label:this.getMessage("snkFilterParamConfig.labelSave"),onClick:()=>this.save(),enabled:this._canSave},this.getElementID("saveEditParam"))))))}get _element(){return S(this)}};D.style=M;export{N as snk_filter_field_search,D as snk_filter_param_config};
//# sourceMappingURL=snk-filter-field-search_2.entry-DdhbID9U.js.map

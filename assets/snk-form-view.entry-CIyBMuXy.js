import{r as p,c as u,h as l,H as v}from"./index-CcALeDO2.js";import{A as d,S as E,O as C,W as D,m as f,E as m}from"./dataUnitInMemoryLoader-CwDmnNwL.js";import{A as h}from"./ApplicationContext-B_qAnYBt.js";import{A as g}from"./FormLayout-CTCTPPNq.js";import{f as F,c as U}from"./search-column-Da0RZOkA.js";import"./index-BdigElPL.js";class I{constructor(e,t,i){this._dataUnit=e,this._validationSource=t,this._validator=i}validate(e=!0){return new Promise((t,i)=>{const s=this._dataUnit.getModifiedRecords();for(let r=0;r<s.length;r++){const n=s[r],o=[];let c=this.validateRequired(n);if(c&&!c.isValid&&o.push(c),this._validator&&(c=this._validator.validateRecord(n),c&&!c.isValid&&o.push(c)),o.length>0){if(!e&&o[0].invalidFields.length>0){this._validationSource.markAsInvalid(o[0].invalidFields[0],n.__record__id__),i();break}this.processValidationResult(o,n.__record__id__),i();break}}return t()})}validateRequired(e){const t=this._validationSource.getRequiredFields(),i=[];if(new Set(t).forEach(s=>{const r=e[s];if(r==null||r===""){const n=this._validationSource.getMessageForField(s,e.__record__id__);n?i.push({name:s,message:n}):i.push({name:s,message:"Essa informação é obrigatória"})}}),i.length>0)return{isValid:!1,invalidFields:i,infoMessage:"Há pelo menos um campo obrigatório não preenchido."}}processValidationResult(e,t){e.forEach(i=>{const s=i.invalidFields;if(this._dataUnit.savingCanceled(s,t),s&&s.forEach(r=>{this.markAsInvalid(r,t)}),i.infoMessage&&g.info(i.infoMessage),i.errorMessage){const{errorTitle:r,errorMessage:n}=i;g.error(r,n)}})}markAsInvalid(e,t){this._dataUnit.setInvalidField(e.name,e.message,t),this._validationSource.markAsInvalid(e,t)}}class R{constructor(e){this.onDataUnitEvent=t=>{var i;switch(t.type){case d.MULTIPLE_EDITION_CHANGED:this.clearInvalid(),this.updateAllFieldsValues();break;case d.DATA_LOADED:case d.DATA_SAVED:case d.RECORDS_REMOVED:case d.RECORDS_ADDED:case d.RECORDS_COPIED:case d.EDITION_CANCELED:case d.SELECTION_CHANGED:case d.NEXT_SELECTED:case d.PREVIOUS_SELECTED:this.clearInvalid();case d.DATA_CHANGED:case d.CHANGE_UNDONE:case d.CHANGE_REDONE:case d.RECORD_LOADED:this.updateAllFieldsValues(),this.clearFieldError(Object.keys(t.payload)[0]);break;case d.FIELD_INVALIDATED:(i=this._fields)===null||i===void 0||i.forEach(s=>{this.updateErrorMessage(s.fieldName,s.field)});break}},this._uuid=E.generateUUID(),this._fields=new Map,this._dataUnit=e,this.applyDefaultValues(),this._dataUnit.subscribe(this.onDataUnitEvent),this._dataUnit.addInterceptor(this),this.setContextDataBinder(e)}get dataBinderId(){return this._uuid}setContextDataBinder(e){const t=h.getContextValue("__DATABINDER_BY_DATAUNIT__")||new Map,i=[...t.get(e.dataUnitId)||[],this];t.set(e.dataUnitId,i),h.setContextValue("__DATABINDER_BY_DATAUNIT__",t)}applyDefaultValues(){const e=(this._dataUnit.getAddedRecords()||[]).map(t=>t.__record__id__);if(e.length>0){const t=this.getDefaultValues();t&&Object.keys(t).forEach(i=>{this._dataUnit.setFieldValue(i,t[i],e)})}}bind(e,t,i,s){e.forEach(r=>{const{fieldName:n,contextName:o}=r.dataset;(o==null||o===t)&&this.updateBind(n,r)}),this._formMetadata=i,this._recordValidatorProcessor=new I(this._dataUnit,{getRequiredFields:()=>this.getFormRequiredFields(),markAsInvalid:r=>this.markInvalid(r),getMessageForField:r=>this.getErrorMessage(r)},s)}getFormRequiredFields(){return this._formMetadata.getRequiredFields()}disconnectDataUnit(){const e=h.getContextValue("__DATABINDER_BY_DATAUNIT__")||new Map,i=e.get(this._dataUnit.dataUnitId).filter(s=>s.dataBinderId!==this.dataBinderId);e.set(this._dataUnit.dataUnitId,i),h.setContextValue("__DATABINDER_BY_DATAUNIT__",e)}onDisconnectedCallback(){this._dataUnit.unsubscribe(this.onDataUnitEvent),this._dataUnit.removeInterceptor(this),this.disconnectDataUnit()}getCurrentRecordId(){const e=this._dataUnit.getSelectedRecord();return e==null?void 0:e.__record__id__}markInvalid(e){if(this._fields.has(e.name)){const t=this._fields.get(e.name).field;this.updateErrorMessage(e.name,t,e.message)}}setFocus(e){if(!this._fields.has(e))return;const t=this._fields.get(e).field;typeof t.setFocus=="function"&&t.setFocus()}clearInvalid(e){this._dataUnit.clearInvalid(e),this._fields.forEach(t=>{const i=t.field;i.errorMessage=""})}clearFieldError(e){var t;const i=(t=this._fields.get(e))===null||t===void 0?void 0:t.field;i.errorMessage&&(i.errorMessage="",this._dataUnit.clearInvalid(this.getCurrentRecordId(),e))}updateFieldValue(e,t){const i=this._fields.get(e);try{i&&(i.listen=!1),this._dataUnit.isMultipleEdition&&this.hasMultipleValuesBetweenRecords(e)?(t.value=void 0,t.alternativePlaceholder="Múltiplos Valores"):(t.value=this._dataUnit.getFieldValue(e),t.alternativePlaceholder=void 0),this.updateErrorMessage(e,t)}finally{i&&(i.listen=!0)}}hasMultipleValuesBetweenRecords(e){var t,i;const s=(i=(t=this._dataUnit.getSelectionInfo())===null||t===void 0?void 0:t.records)!==null&&i!==void 0?i:[];if(s.length<=1)return!1;const r=s[0][e];return!s.every(n=>C.equals(n[e],r))}validate(){return this._recordValidatorProcessor.validate()}static async validateByDataunit(e){try{const t=this.getDataBindersByDataUnit(e);return await Promise.all(t.map(i=>i.validate())),!0}catch{return!1}}static getDataBindersByDataUnit(e){const t=h.getContextValue("__DATABINDER_BY_DATAUNIT__");return(t==null?void 0:t.get(e.dataUnitId))||[]}updateErrorMessage(e,t,i){i==null&&(i=this._dataUnit.getInvalidMessage(this.getCurrentRecordId(),e)),t.errorMessage||(t.errorMessage=i)}getErrorMessage(e){if(this._fields.has(e))return this._fields.get(e).field.errorMessage}updateBind(e,t){const i=this._fields.get(e);i&&i.destroy(),this.bindSearchOptionsLoader(e,t),this.updateFieldValue(e,t),this.updateErrorMessage(e,t),this._fields.set(e,_.create(e,t,(s,r)=>this.changeStarted(s,r),s=>this.cancelWaitingChange(s),(s,r)=>this.setFieldValue(s,r))),this.applyEzUploadContext(e,t)}changeStarted(e,t){if(this._dataUnit.records.length===0&&this._dataUnit.addRecord(),!t.blocking&&t.promise==null){const i=this._fields.get(e);i&&(t.promise=new Promise((s,r)=>{i.waitingChangePromiseResolve=s,i.waitingChangePromiseReject=r}))}this._dataUnit.startChange(e,t)}cancelWaitingChange(e){if(this._dataUnit.waitingForChange(e)){this._dataUnit.cancelWaitingChange(e);const t=this._fields.get(e);t&&t.rejectWaitingChange(new D("Change canceled",e))}}setFieldValue(e,t){if(this._dataUnit.records.length===0&&this._dataUnit.addRecord(),this._dataUnit.clearInvalid(this.getCurrentRecordId(),e),this._dataUnit.isMultipleEdition){const i=this._dataUnit.getSelectionInfo();this._dataUnit.setFieldValue(e,t,i.recordIds)}else{const i=this._dataUnit.getSelectedRecord();this._dataUnit.setFieldValue(e,t,i?[i.__record__id__]:void 0)}if(this._dataUnit.waitingForChange(e)){const i=this._fields.get(e);i&&i.acceptWaitingChange()}}bindSearchOptionsLoader(e,t){if((t.nodeName==="EZ-SEARCH"||t.nodeName==="EZ-SEARCH-PLUS")&&t.optionLoader==null){const s=t.nodeName==="EZ-SEARCH-PLUS"?h.getContextValue("__EZUI__SEARCH__PLUS__OPTION__LOADER__"):h.getContextValue("__EZUI__SEARCH__OPTION__LOADER__");s&&(t.optionLoader=(r,n)=>s(r,e,this._dataUnit,n))}}applyEzUploadContext(e,t){var i,s;if(t.nodeName==="EZ-UPLOAD"){t.urlUpload=h.getContextValue("__EZUI__UPLOAD__ADD__URL__"),t.urlDelete=h.getContextValue("__EZUI__UPLOAD__DEL__URL__");const r=this._dataUnit.getField(e),n=(i=r.properties)===null||i===void 0?void 0:i.DESTINATION;n&&(t.requestHeaders={XTRAINF:`{"destination": "${n}"}`}),t.maxFiles=((s=r.properties)===null||s===void 0?void 0:s.MAX_FILES)||0}}updateAllFieldsValues(){var e;(e=this._fields)===null||e===void 0||e.forEach(t=>{this.updateFieldValue(t.fieldName,t.field)})}interceptAction(e){if(e.type===d.RECORDS_COPIED){const t=this._formMetadata.getCleanOnCopyFields();if(t){const i=e.payload;return new f(d.RECORDS_COPIED,i.map(s=>{const r=Object.assign({},s);return t.forEach(n=>delete r[n]),r}))}}if(e.type===d.SAVING_DATA)return new Promise(t=>{this.validate().then(()=>t(e)).catch(()=>{})});if(e.type===d.RECORDS_ADDED){const t=this.getDefaultValues();if(t){const i=e.payload;return new f(d.RECORDS_ADDED,i.map(s=>Object.assign(Object.assign({},s),t)))}}return e}getDefaultValues(){var e;const t=(e=this._formMetadata)===null||e===void 0?void 0:e.getDefaultValues();if(t){const i={};for(const s in t)i[s]=this._dataUnit.valueFromString(s,t[s]);return i}}}class _{constructor(){this.listen=!0,this.startChangeEventName="ezStartChange",this.cancelWaitingChangeEventName="ezCancelWaitingChange",this.changeEventName="ezChange"}destroy(){this.field.removeEventListener(this.startChangeEventName,this.startChangeListener),this.field.removeEventListener(this.cancelWaitingChangeEventName,this.cancelWaitingChangeListener),this.field.removeEventListener(this.changeEventName,this.changeListener)}acceptWaitingChange(){this.waitingChangePromiseResolve&&(this.waitingChangePromiseResolve(),this.waitingChangePromiseReject=void 0,this.waitingChangePromiseResolve=void 0)}rejectWaitingChange(e){this.waitingChangePromiseReject&&(this.waitingChangePromiseReject(e),this.waitingChangePromiseReject=void 0,this.waitingChangePromiseResolve=void 0)}static create(e,t,i,s,r){const n=new _;return n.field=t,n.fieldName=e,n.startChangeListener=o=>{n.listen&&i(e,o.detail)},n.field.addEventListener(n.startChangeEventName,n.startChangeListener),n.cancelWaitingChangeListener=()=>{n.listen&&s(e)},n.field.addEventListener(n.cancelWaitingChangeEventName,n.cancelWaitingChangeListener),n.changeListener=o=>{n.listen&&r(e,o.detail)},n.field.addEventListener(n.changeEventName,n.changeListener),n}}const w=".sc-snk-form-view-h{display:flex;width:100%;--ez-form-card-summary-field-content-weight:700}.level-path.sc-snk-form-view{color:var(--color--title-primary, #2B3A54);font-weight:var(--text-weight--medium, 400);padding-right:3px}.summary-wrapper.sc-snk-form-view{display:flex;overflow:hidden}.summary-header.sc-snk-form-view{border-bottom:1px solid var(--color--strokes);margin-bottom:var(--space--medium);padding-bottom:var(--space--medium)}.summary-container.sc-snk-form-view{display:flex;flex-direction:column}.summary-container.sc-snk-form-view{padding-right:calc(var(--space--extra-large) / 1.5)}.summary-field.sc-snk-form-view{min-width:30px;max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.summary-field__title.sc-snk-form-view{color:var(--text--primary, #626e82);font-size:var(--title--small);white-space:nowrap;font-weight:var(--text-weight--medium)}.summary-field__content.sc-snk-form-view{color:var(--title--primary, #2b3a54);font-size:var(--text--large);font-weight:var(--ez-form-card-summary-field-content-weight)}",A=class{constructor(a){p(this,a),this.snkContentCardChanged=u(this,"snkContentCardChanged",7),this.snkRequestClearFieldToFocus=u(this,"snkRequestClearFieldToFocus",7),this.formItemsReady=u(this,"formItemsReady",7),this._customEditors=new Map,this._fieldProps=new Map,this.levelPath=void 0,this.fieldSearch=void 0,this.label=void 0,this.name=void 0,this.fields=void 0,this.formMetadata=void 0,this.dataUnit=void 0,this.contracted=void 0,this.fixed=!1,this.summaryFields=void 0,this.canExpand=!0,this.canFix=!0,this.recordsValidator=void 0,this.fieldToFocus=void 0,this.customEditors=void 0,this.fieldsProps=void 0}async showUp(){this._formView&&this._formView.showUp()}async addCustomEditor(a,e,t){if(this._formView){this._formView.addCustomEditor(a,e,t);return}const i=new Map(this._customEditors);i.set(a,{customEditor:e,detailContext:t}),this._customEditors=i}async setFieldProp(a,e,t){const i=this._fieldProps.get(a)||[];this._fieldProps.set(a,[...i,{propName:e,value:t}])}async showSearchField(){if(!this._headerContainer||!this._ezPopoverFieldColumn)return;const a=this._headerContainer.getBoundingClientRect();await F(this.fieldSearch),this._ezPopoverFieldColumn.showUnder(this._headerContainer,{horizontalGap:a.width-U,verticalGap:a.height*-1})}observePropsCustomEditor(a){for(const e in a)this.addCustomEditor(e,a[e])}async observeFieldsProps(a){for(const e in a){const t=a[e],i=Object.keys(t);for(const s of i)await this.setFieldProp(e,s,t[s])}}changeFix(){this.fixed=!this.fixed,this.emitEvent("fixed")}changeContracted(){this.contracted=!this.contracted,this.emitEvent("presentation")}emitEvent(a){this.snkContentCardChanged.emit({formName:this.name,cardConfig:{fixed:this.fixed,presentation:this.contracted?"CONTRACTED":"EXPANDED"},propertyChanged:a})}getCardSummary(){const a={};return this.getSummaryFields().forEach(({field:e,label:t})=>{var i;const s=this.dataUnit.getFormattedValue(e);s!==""&&(t==null&&(t=(i=this.dataUnit.getField(e))===null||i===void 0?void 0:i.label),a[t]=s)}),a}getSummaryFields(){return this.summaryFields==null?this.fields.map(a=>{const e=this.dataUnit.getField(a.name);return{field:a.name,label:a.label||(e==null?void 0:e.label)}}):this.summaryFields}bindFields(a){this._dataBinder==null&&this.dataUnit!=null&&(this._dataBinder=new R(this.dataUnit)),this._dataBinder&&this._dataBinder.bind(a,this.dataUnit.dataUnitId,this.formMetadata,this.recordsValidator)}handleFormItemsReady(a){a.stopPropagation(),this.formItemsReady.emit(Object.assign(Object.assign({},a.detail),{formId:this.name}))}disconnectedCallback(){this._dataBinder!=null&&this._dataBinder.onDisconnectedCallback()}componentDidLoad(){this.observePropsCustomEditor(this.customEditors),this.observeFieldsProps(this.fieldsProps)}componentDidRender(){this.setCustomEditors(),this.setFieldProps(),this.fieldToFocus!=null&&this.fields.some(a=>a.name===this.fieldToFocus)&&requestAnimationFrame(()=>{this._dataBinder.setFocus(this.fieldToFocus),this.snkRequestClearFieldToFocus.emit()})}setCustomEditors(){if(this._formView)for(const[a,e]of this._customEditors)this._formView.addCustomEditor(a,e.customEditor,e.detailContext),this._customEditors.delete(a)}setFieldProps(){if(this._formView)for(const[a,e]of this._fieldProps)e.forEach(t=>{this._formView.setFieldProp(a,t.propName,t.value),this._fieldProps.delete(a)})}render(){return l(v,{class:"ez-box__container"},l("div",{class:"summary-header ez-flex ez-size-width--full",ref:a=>this._headerContainer=a},l("div",{class:"ez-flex ez-text ez-title--primary ez-text--bold ez-flex--justify-start ez-flex--align-items-center ez-col--sd-9"},this.levelPath?l("span",{class:"level-path"},this.levelPath+" /"):void 0,this.label),l("div",{class:"ez-flex ez-flex--justify-end ez-col--sd-3"},this.canFix&&l("ez-button",{class:"ez-padding-left--medium",mode:"icon",size:"small",iconName:this.fixed?"un-pin":"push-pin","data-element-id":m.getInternalIDInfo("toggleFixed_ezFormCard"),onClick:()=>this.changeFix(),title:this.fixed?"Desafixar":"Fixar"}),this.canExpand&&l("ez-button",{class:"ez-padding-left--medium",mode:"icon",size:"small",iconName:this.contracted?"chevron-down":"chevron-up","data-element-id":m.getInternalIDInfo("toggleExpand_ezFormCard"),onClick:()=>this.changeContracted(),title:this.contracted?"Expandir":"Resumir"}))),l("slot",null),this.contracted?l("snk-form-summary",{summary:this.getCardSummary()}):l("ez-form-view",{ref:a=>this._formView=a,fields:this.fields,onEzContentReady:a=>this.bindFields(a.detail),onFormItemsReady:a=>this.handleFormItemsReady(a)}),this.fieldSearch&&l("ez-popover",{ref:a=>this._ezPopoverFieldColumn=a,overlayType:"none"},this.fieldSearch))}static get watchers(){return{customEditors:["observePropsCustomEditor"],fieldsProps:["observeFieldsProps"]}}};A.style=w;export{A as snk_form_view};
//# sourceMappingURL=snk-form-view.entry-CIyBMuXy.js.map

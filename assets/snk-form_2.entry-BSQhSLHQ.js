import{r as u,c as h,E as m,h as n,g as C,O as r,A as p,H as v}from"./index-CxFxc26b.js";import{S as _}from"./SnkFormConfigManager-c1cd9dcd-DUTr462R.js";import{R as F}from"./ResourceIDUtils-a114189a-DvfZuq5X.js";import{a as b}from"./FormMetadata-CLeXwuYR.js";import{A as g}from"./FormLayout-DWDL0qnG.js";import{b as G,a as S,g as L,u as y,c as U}from"./FormConfigHelper-49fe72ca-CPtPnjbf.js";import{T as f,G as M}from"./constants-7b422de0-BRz2gykn.js";import{U as d}from"./form-config-fetcher-e623539b-VBVHUPpx.js";import"./ConfigStorage-cf578768-CIb4C9-y.js";import"./DataFetcher-db08cad0-DvO7h7yr.js";import"./PrintUtils-3e4ff0f5-BzI1KebB.js";import"./filter-item-type.enum-d45e026f-B41QHsvD.js";const w=".sc-snk-form-h{--snk-form__header--min-height:94px;display:block}.snk-form__form--hidden.sc-snk-form{display:none}",D=class{constructor(e){u(this,e),this.exit=h(this,"exit",7),this.actionClick=h(this,"actionClick",7),this.formItemsReady=h(this,"formItemsReady",7),this._customEditors=new Map,this._dataUnit=void 0,this._dataState=void 0,this._showFormConfig=!1,this._configManager=void 0,this.configName=void 0,this.recordsValidator=void 0,this.messagesBuilder=void 0,this.formLegacyConfigName=void 0,this.resourceID=void 0}async showConfig(){this._showFormConfig=!0}async hideConfig(){this._showFormConfig=!1}async addCustomEditor(e,i){if(this._form){this._form.addCustomEditor(e,i);return}const t=new Map(this._customEditors);t.set(e,i),this._customEditors=t}async setFieldProp(e,i,t){await this._form.setFieldProp(e,i,t)}closeConfig(){this.hideConfig()}dataunitReady(){const e={dataUnit:this._dataUnit};m.addIDInfo(this._element,null,e)}setCustomEditors(){if(this._form)for(const[e,i]of this._customEditors)this._form.addCustomEditor(e,i),this._customEditors.delete(e)}async componentDidRender(){this.setCustomEditors()}async componentWillLoad(){let e=this._element.parentElement;for(;e;){if(e.tagName.toUpperCase()==="SNK-DATA-UNIT"){this._snkDataUnit=e,this._dataUnit=this._snkDataUnit.dataUnit,this._dataState=this._snkDataUnit.dataState,this._dataUnit?this.dataunitReady():this._snkDataUnit.addEventListener("dataUnitReady",i=>{this._dataUnit=i.detail}),this._snkDataUnit.addEventListener("dataStateChange",this.handleDataStateChange.bind(this));break}e=e.parentElement}this.resourceID==null&&(this.resourceID=await F.getResourceID()),this._configManager=new _(this.configName,this.resourceID,void 0,this._dataUnit),this.addFormLegacyConfig(),await this._configManager.loadConfig()}async handleDataStateChange(e){var i;this._dataState=e.detail;const t=await this._snkDataUnit.getFieldsWithRmPrecision();for(const s of t||[]){if(!s)continue;const a=(i=this._dataState.rowMetadata)===null||i===void 0?void 0:i.getProp("rm_precision",s);!a&&a!==0||(await this.setFieldProp(s,"precision",a),await this.setFieldProp(s,"prettyPrecision",a))}}addFormLegacyConfig(){this.formLegacyConfigName&&this._configManager.addFormLegacyConfig(this.formLegacyConfigName)}render(){if(!(!this._dataUnit||!this._dataState))return n("section",null,n("div",{class:"ez-row"},n("div",{class:"ez-col ez-col--sd-12"},n("ez-form",{ref:e=>this._form=e,key:"ezForm"+this._snkDataUnit.entityName,"data-element-id":"embedded",dataUnit:this._dataUnit,config:this._configManager.getConfig(this._dataUnit),recordsValidator:this.recordsValidator,class:this._showFormConfig?"snk-form__form--hidden":""}),this._showFormConfig&&n("snk-form-config",{messagesBuilder:this.messagesBuilder,dataUnit:this._dataUnit,configManager:this._configManager,onConfigClose:()=>this.closeConfig()}))))}get _element(){return C(this)}};D.style=w;const k='.sc-snk-form-config-h{display:flex;flex-direction:column;height:100vh;width:100vw;font-family:var(--font-pattern, "Roboto");background:white;color:#2b3a54;--snk-form-config-container-height:calc(100vh - 95px);outline:none}.sidebarNavigator__container.sc-snk-form-config{height:var(--snk-form-config-container-height);gap:20px;align-items:flex-start}.guide-header.sc-snk-form-config{display:flex;width:100%;padding-bottom:12px;border-bottom:1px solid #dce0e8;height:30px;font-weight:500;font-size:16px}',A=class{constructor(e){u(this,e),this.configClose=h(this,"configClose",7),this.configChange=h(this,"configChange",7),this.guidesMap=new Map,this.availableFields=[],this.guidesList=[],this.groupsList=[],this.selectedGuide=void 0,this._formConfig={},this.configOptions=[],this.originalConfigSelected=void 0,this.configSelected=void 0,this.hasChanges=!1,this.optionConfigChanged=!1,this.dataUnit=void 0,this.configManager=void 0,this.ignoreReadOnlyFormFields=void 0,this.messagesBuilder=void 0}handleFieldConfigChanged(){this.hasChanges=!0}async handleFormConfigOptionSelected({detail:e}){this.configSelected=e,await this.loadConfigByUser(),this.selectedGuide=void 0,this.optionConfigChanged=!r.equals(this.configSelected,this.originalConfigSelected),this.configSelected.origin===d.DEFAULT&&(this.hasChanges=!1)}async handleAddFieldToGuide({detail:e}){var i;if(!this.selectedGuide){this.showNoGuideSelectedDialog();return}this.availableFields=[...this.availableFields.filter(t=>t.name!==e.name)],await((i=this.refFieldsLayout)===null||i===void 0?void 0:i.addFieldToLayout(e))}async handleSetFieldAsAvailable({detail:e}){this.availableFields.some(t=>t.name===e.name)||(this.availableFields=[...this.availableFields,e])}async handleRemoveFieldFromAvailable({detail:e}){this.availableFields=this.availableFields.filter(i=>i.name!==e.name)}observeSelectedGuide(e){var i;const t=(i=this.guidesMap.get(e==null?void 0:e.name))!==null&&i!==void 0?i:[];this.groupsList=[...t]}observeConfigManager(){this.loadFormConfig()}showNoGuideSelectedDialog(){const e=this.getMessage("snkFormConfig.noGuideSelected.title"),i=this.getMessage("snkFormConfig.noGuideSelected.message");g.alert(e,i)}getMessage(e,i){return this.messagesBuilder.getMessage(e,i)}async initializeUserConfig(){if(this.configManager!=null)try{const e=await this.configManager.fetchUserAvailableConfigs();this.configOptions=e;const t=(this._formConfig!=null?this._formConfig.defaultConfiguration:!0)?d.DEFAULT:d.USER;this.configSelected=e.find(s=>s.origin===t),this.originalConfigSelected=e.find(s=>s.origin===t)}catch(e){console.error("Falha ao buscar configurações de formulário definida pelo usuário."),console.error(e)}}async loadConfigByUser(){!this.configManager||!this.configSelected||(this.isConfigDefaultSelected()?await this.handleLoadDefaultConfig():this.loadFormConfig())}async handleLoadDefaultConfig(){const e=await this.configManager.fetchDefaultConfig();if(e){this.loadFormConfig(e);return}const i=this.configManager.getEmptyConfig();i&&this.loadFormConfig(i)}isConfigDefaultSelected(){return this.configSelected.origin===d.DEFAULT}loadFormConfig(e){this._formConfig=e||this.getConfig(),this.loadGuides(),this.initializeAvailableFields()}initializeAvailableFields(){var e;if(((e=this._formConfig)===null||e===void 0?void 0:e.fields)==null)return;const i=[...this._formConfig.fields],t=this.dataUnit.metadata.fields;this.availableFields=t.filter(({name:s,visible:a,properties:o})=>{const l=i.some(({name:c})=>c===s);return!l&&o.visibleOnConfig===!0&&!a?o.visibleOnConfig:a===!0&&l===!1})}loadGuides(){var e;this.guidesList=[...G(this._formConfig,this.getMessage("snkFormConfig.form.mainArea"))],this.guidesMap=S((e=this._formConfig)===null||e===void 0?void 0:e.fields,this.guidesList,this.dataUnit,this.getMessage("snkFormConfig.form.tabGeneral"))}getConfig(){let e=this.configManager.getConfig(this.dataUnit,!1);return e.fields&&e.fields.length===0&&(e=void 0),e==null&&(e=b(this.dataUnit)),r.copy(e)}handleSelectGuide({detail:e}){this.selectedGuide=e}handleLayoutChanged({detail:e}){this.hasChanges=!0,this.groupsList=[...e],this.guidesMap.set(this.selectedGuide.name,[...e])}getIsDefaultConfig(){var e;return((e=this.configSelected)===null||e===void 0?void 0:e.origin)===d.DEFAULT&&this.optionConfigChanged===!0&&this.hasChanges===!1}getTabsToSave(){return this.guidesList.map(e=>({name:e.name,label:e.name===f.main?e.name:e.label,order:e.name===f.main?0:e.order,visible:e.visible}))}async handleSaveConfig(){var e;const i=await this.configManager.saveConfig(this.buildConfigToSave());this.configSelected=(e=this.configOptions)===null||e===void 0?void 0:e.find(t=>t.origin===(this.hasChanges?d.USER:d.DEFAULT)),this.originalConfigSelected=this.configSelected,this.hasChanges=!1,this.optionConfigChanged=!1,g.info(this.getMessage("snkFormConfig.info.successfullyConfigSaved"),{iconName:"check"}),this.configChange.emit(i)}buildConfigToSave(){if(this.getIsDefaultConfig()){const i=this._formConfig;return i.defaultConfiguration=!0,i}const e=r.copy(this._formConfig);return e.tabs=this.getTabsToSave(),e.fields=L(this.guidesMap),e.defaultConfiguration=!1,e}handleAvailableFieldListChanged({detail:e}){this.availableFields=[...e]}handleSetFieldListAsAvailable({detail:e}){this.availableFields=[...this.availableFields,...e]}handleGuideDeleted({detail:e}){var i,t;const s=e.name,a=(i=this.guidesMap.get(s))!==null&&i!==void 0?i:[],o=[];a.forEach(l=>o.push(...l.fields)),this.availableFields=[...this.availableFields,...o],this.guidesList=[...this.guidesList.filter(l=>l.name!==s)],this.guidesMap.delete(s),((t=this.selectedGuide)===null||t===void 0?void 0:t.name)===s&&(this.selectedGuide=void 0),this.hasChanges=!0}handleGuideListChanged({detail:e}){this.hasChanges=!0,this.guidesList=[...e]}handleGuideRenamed({detail:e}){var i;const t=(i=this.guidesMap.get(this.selectedGuide.name))!==null&&i!==void 0?i:[],s=y(t,e);this.guidesMap.delete(this.selectedGuide.name),this.guidesMap.set(e,s);const a={name:e,label:e,visible:this.selectedGuide.visible,order:this.selectedGuide.order};this.guidesList=[...this.guidesList.map(o=>o.name===this.selectedGuide.name?a:o)],this.groupsList=[...s],this.selectedGuide=a,this.hasChanges=!0}handleCreateNewGuide(){const e=U(this.guidesList),i={name:e,label:e,visible:!0,order:this.guidesList.length+1},t={name:M.noGroup,fields:[]};this.guidesList=[...this.guidesList,i],this.guidesMap.set(e,[t]),this.selectedGuide=i,this.hasChanges=!0}getGuideNames(){return[...this.guidesList.map(e=>e.name.toLowerCase()),this.getMessage("snkFormConfig.form.mainArea").toLowerCase()]}async componentWillRender(){if(this.messagesBuilder==null){const e=p.getContextValue("__SNK__APPLICATION__");this.messagesBuilder=e.messagesBuilder}}async componentWillLoad(){this.loadFormConfig(),await this.initializeUserConfig()}render(){return n(v,null,n("config-header",{configOptions:this.configOptions,selectedConfig:this.configSelected,messagesBuilder:this.messagesBuilder,hasChanges:this.hasChanges,optionConfigChanged:this.optionConfigChanged,onConfigClose:()=>this.configClose.emit(),onSaveConfig:async()=>await this.handleSaveConfig()}),n("div",{class:"ez-padding--medium"},n("div",{class:"ez-flex sidebarNavigator__container"},n("guides-configurator",{messagesBuilder:this.messagesBuilder,guidesList:this.guidesList,selectedGuide:this.selectedGuide,onGuideSelected:this.handleSelectGuide.bind(this),onGuideListChanged:this.handleGuideListChanged.bind(this),onCreateNewGuide:this.handleCreateNewGuide.bind(this),onGuideDeleted:this.handleGuideDeleted.bind(this)}),n("fields-layout",{ref:e=>this.refFieldsLayout=e,selectedGuide:this.selectedGuide,guideNames:this.getGuideNames(),groupsList:this.groupsList,messagesBuilder:this.messagesBuilder,dataUnit:this.dataUnit,onGuideRenamed:this.handleGuideRenamed.bind(this),onLayoutChanged:this.handleLayoutChanged.bind(this),onSetFieldListAsAvailable:this.handleSetFieldListAsAvailable.bind(this)}),n("fields-selector",{dataUnit:this.dataUnit,availableFields:this.availableFields,onFieldListChanged:this.handleAvailableFieldListChanged.bind(this)}))))}static get watchers(){return{selectedGuide:["observeSelectedGuide"],configManager:["observeConfigManager"]}}};A.style=k;export{D as snk_form,A as snk_form_config};
//# sourceMappingURL=snk-form_2.entry-BSQhSLHQ.js.map

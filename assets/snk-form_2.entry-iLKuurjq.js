import{r as u,c as h,h as n,g as m,H as C}from"./index-ChOtpOHD.js";import{E as p,O as r}from"./dataUnitInMemoryLoader-BjgoPaoq.js";import{A as v}from"./ApplicationContext-B_qAnYBt.js";import{S as _}from"./SnkFormConfigManager-d64d62d6-CQQ8yzXS.js";import{R as F}from"./ResourceIDUtils-a114189a-BM9f4Nxo.js";import{a as b}from"./FormMetadata-CURdpt0q.js";import{A as g}from"./FormLayout-pPi2ZB-q.js";import{b as G,a as S,g as L,u as y,c as U}from"./FormConfigHelper-49fe72ca-BjOYQIZX.js";import{T as f,G as M}from"./constants-7b422de0-BRz2gykn.js";import{U as d}from"./form-config-fetcher-e623539b-By6wLJV7.js";import"./ConfigStorage-89154c4e-iTHVKliQ.js";import"./filter-item-type.enum-d45e026f-B41QHsvD.js";import"./DataFetcher-db08cad0-B7lG84WQ.js";import"./PrintUtils-3e4ff0f5-DDjQRNo9.js";const w=".sc-snk-form-h{--snk-form__header--min-height:94px;display:block}.snk-form__form--hidden.sc-snk-form{display:none}",D=class{constructor(i){u(this,i),this.exit=h(this,"exit",7),this.actionClick=h(this,"actionClick",7),this.formItemsReady=h(this,"formItemsReady",7),this._customEditors=new Map,this._dataUnit=void 0,this._dataState=void 0,this._showFormConfig=!1,this._configManager=void 0,this.configName=void 0,this.recordsValidator=void 0,this.messagesBuilder=void 0,this.formLegacyConfigName=void 0,this.resourceID=void 0}async showConfig(){this._showFormConfig=!0}async hideConfig(){this._showFormConfig=!1}async addCustomEditor(i,e){if(this._form){this._form.addCustomEditor(i,e);return}const t=new Map(this._customEditors);t.set(i,e),this._customEditors=t}async setFieldProp(i,e,t){await this._form.setFieldProp(i,e,t)}closeConfig(){this.hideConfig()}dataunitReady(){const i={dataUnit:this._dataUnit};p.addIDInfo(this._element,null,i)}setCustomEditors(){if(this._form)for(const[i,e]of this._customEditors)this._form.addCustomEditor(i,e),this._customEditors.delete(i)}async componentDidRender(){this.setCustomEditors()}async componentWillLoad(){let i=this._element.parentElement;for(;i;){if(i.tagName.toUpperCase()==="SNK-DATA-UNIT"){this._snkDataUnit=i,this._dataUnit=this._snkDataUnit.dataUnit,this._dataState=this._snkDataUnit.dataState,this._dataUnit?this.dataunitReady():this._snkDataUnit.addEventListener("dataUnitReady",e=>{this._dataUnit=e.detail}),this._snkDataUnit.addEventListener("dataStateChange",this.handleDataStateChange.bind(this));break}i=i.parentElement}this.resourceID==null&&(this.resourceID=await F.getResourceID()),this._configManager=new _(this.configName,this.resourceID,void 0,this._dataUnit),this.addFormLegacyConfig(),await this._configManager.loadConfig()}async handleDataStateChange(i){var e;this._dataState=i.detail;const t=await this._snkDataUnit.getFieldsWithRmPrecision();for(const s of t||[]){if(!s)continue;const a=(e=this._dataState.rowMetadata)===null||e===void 0?void 0:e.getProp("rm_precision",s);!a&&a!==0||(await this.setFieldProp(s,"precision",a),await this.setFieldProp(s,"prettyPrecision",a))}}addFormLegacyConfig(){this.formLegacyConfigName&&this._configManager.addFormLegacyConfig(this.formLegacyConfigName)}render(){if(!(!this._dataUnit||!this._dataState))return n("section",null,n("div",{class:"ez-row"},n("div",{class:"ez-col ez-col--sd-12"},n("ez-form",{ref:i=>this._form=i,key:"ezForm"+this._snkDataUnit.entityName,"data-element-id":"embedded",dataUnit:this._dataUnit,config:this._configManager.getConfig(this._dataUnit),recordsValidator:this.recordsValidator,class:this._showFormConfig?"snk-form__form--hidden":""}),this._showFormConfig&&n("snk-form-config",{messagesBuilder:this.messagesBuilder,dataUnit:this._dataUnit,configManager:this._configManager,onConfigClose:()=>this.closeConfig()}))))}get _element(){return m(this)}};D.style=w;const k='.sc-snk-form-config-h{display:flex;flex-direction:column;height:100vh;width:100vw;font-family:var(--font-pattern, "Roboto");background:white;color:#2b3a54;--snk-form-config-container-height:calc(100vh - 95px);outline:none}.sidebarNavigator__container.sc-snk-form-config{height:var(--snk-form-config-container-height);gap:20px;align-items:flex-start}.guide-header.sc-snk-form-config{display:flex;width:100%;padding-bottom:12px;border-bottom:1px solid #dce0e8;height:30px;font-weight:500;font-size:16px}',A=class{constructor(i){u(this,i),this.configClose=h(this,"configClose",7),this.configChange=h(this,"configChange",7),this.guidesMap=new Map,this.availableFields=[],this.guidesList=[],this.groupsList=[],this.selectedGuide=void 0,this._formConfig={},this.configOptions=[],this.originalConfigSelected=void 0,this.configSelected=void 0,this.hasChanges=!1,this.optionConfigChanged=!1,this.dataUnit=void 0,this.configManager=void 0,this.ignoreReadOnlyFormFields=void 0,this.messagesBuilder=void 0}handleFieldConfigChanged(){this.hasChanges=!0}async handleFormConfigOptionSelected({detail:i}){this.configSelected=i,await this.loadConfigByUser(),this.selectedGuide=void 0,this.optionConfigChanged=!r.equals(this.configSelected,this.originalConfigSelected),this.configSelected.origin===d.DEFAULT&&(this.hasChanges=!1)}async handleAddFieldToGuide({detail:i}){var e;if(!this.selectedGuide){this.showNoGuideSelectedDialog();return}this.availableFields=[...this.availableFields.filter(t=>t.name!==i.name)],await((e=this.refFieldsLayout)===null||e===void 0?void 0:e.addFieldToLayout(i))}async handleSetFieldAsAvailable({detail:i}){this.availableFields.some(t=>t.name===i.name)||(this.availableFields=[...this.availableFields,i])}async handleRemoveFieldFromAvailable({detail:i}){this.availableFields=this.availableFields.filter(e=>e.name!==i.name)}observeSelectedGuide(i){var e;const t=(e=this.guidesMap.get(i==null?void 0:i.name))!==null&&e!==void 0?e:[];this.groupsList=[...t]}observeConfigManager(){this.loadFormConfig()}showNoGuideSelectedDialog(){const i=this.getMessage("snkFormConfig.noGuideSelected.title"),e=this.getMessage("snkFormConfig.noGuideSelected.message");g.alert(i,e)}getMessage(i,e){return this.messagesBuilder.getMessage(i,e)}async initializeUserConfig(){if(this.configManager!=null)try{const i=await this.configManager.fetchUserAvailableConfigs();this.configOptions=i;const t=(this._formConfig!=null?this._formConfig.defaultConfiguration:!0)?d.DEFAULT:d.USER;this.configSelected=i.find(s=>s.origin===t),this.originalConfigSelected=i.find(s=>s.origin===t)}catch(i){console.error("Falha ao buscar configurações de formulário definida pelo usuário."),console.error(i)}}async loadConfigByUser(){!this.configManager||!this.configSelected||(this.isConfigDefaultSelected()?await this.handleLoadDefaultConfig():this.loadFormConfig())}async handleLoadDefaultConfig(){const i=await this.configManager.fetchDefaultConfig();if(i){this.loadFormConfig(i);return}const e=this.configManager.getEmptyConfig();e&&this.loadFormConfig(e)}isConfigDefaultSelected(){return this.configSelected.origin===d.DEFAULT}loadFormConfig(i){this._formConfig=i||this.getConfig(),this.loadGuides(),this.initializeAvailableFields()}initializeAvailableFields(){var i;if(((i=this._formConfig)===null||i===void 0?void 0:i.fields)==null)return;const e=[...this._formConfig.fields],t=this.dataUnit.metadata.fields;this.availableFields=t.filter(({name:s,visible:a,properties:o})=>{const l=e.some(({name:c})=>c===s);return!l&&o.visibleOnConfig===!0&&!a?o.visibleOnConfig:a===!0&&l===!1})}loadGuides(){var i;this.guidesList=[...G(this._formConfig,this.getMessage("snkFormConfig.form.mainArea"))],this.guidesMap=S((i=this._formConfig)===null||i===void 0?void 0:i.fields,this.guidesList,this.dataUnit,this.getMessage("snkFormConfig.form.tabGeneral"))}getConfig(){let i=this.configManager.getConfig(this.dataUnit,!1);return i.fields&&i.fields.length===0&&(i=void 0),i==null&&(i=b(this.dataUnit)),r.copy(i)}handleSelectGuide({detail:i}){this.selectedGuide=i}handleLayoutChanged({detail:i}){this.hasChanges=!0,this.groupsList=[...i],this.guidesMap.set(this.selectedGuide.name,[...i])}getIsDefaultConfig(){var i;return((i=this.configSelected)===null||i===void 0?void 0:i.origin)===d.DEFAULT&&this.optionConfigChanged===!0&&this.hasChanges===!1}getTabsToSave(){return this.guidesList.map(i=>({name:i.name,label:i.name===f.main?i.name:i.label,order:i.name===f.main?0:i.order,visible:i.visible}))}async handleSaveConfig(){var i;const e=await this.configManager.saveConfig(this.buildConfigToSave());this.configSelected=(i=this.configOptions)===null||i===void 0?void 0:i.find(t=>t.origin===(this.hasChanges?d.USER:d.DEFAULT)),this.originalConfigSelected=this.configSelected,this.hasChanges=!1,this.optionConfigChanged=!1,g.info(this.getMessage("snkFormConfig.info.successfullyConfigSaved"),{iconName:"check"}),this.configChange.emit(e)}buildConfigToSave(){if(this.getIsDefaultConfig()){const e=this._formConfig;return e.defaultConfiguration=!0,e}const i=r.copy(this._formConfig);return i.tabs=this.getTabsToSave(),i.fields=L(this.guidesMap),i.defaultConfiguration=!1,i}handleAvailableFieldListChanged({detail:i}){this.availableFields=[...i]}handleSetFieldListAsAvailable({detail:i}){this.availableFields=[...this.availableFields,...i]}handleGuideDeleted({detail:i}){var e,t;const s=i.name,a=(e=this.guidesMap.get(s))!==null&&e!==void 0?e:[],o=[];a.forEach(l=>o.push(...l.fields)),this.availableFields=[...this.availableFields,...o],this.guidesList=[...this.guidesList.filter(l=>l.name!==s)],this.guidesMap.delete(s),((t=this.selectedGuide)===null||t===void 0?void 0:t.name)===s&&(this.selectedGuide=void 0),this.hasChanges=!0}handleGuideListChanged({detail:i}){this.hasChanges=!0,this.guidesList=[...i]}handleGuideRenamed({detail:i}){var e;const t=(e=this.guidesMap.get(this.selectedGuide.name))!==null&&e!==void 0?e:[],s=y(t,i);this.guidesMap.delete(this.selectedGuide.name),this.guidesMap.set(i,s);const a={name:i,label:i,visible:this.selectedGuide.visible,order:this.selectedGuide.order};this.guidesList=[...this.guidesList.map(o=>o.name===this.selectedGuide.name?a:o)],this.groupsList=[...s],this.selectedGuide=a,this.hasChanges=!0}handleCreateNewGuide(){const i=U(this.guidesList),e={name:i,label:i,visible:!0,order:this.guidesList.length+1},t={name:M.noGroup,fields:[]};this.guidesList=[...this.guidesList,e],this.guidesMap.set(i,[t]),this.selectedGuide=e,this.hasChanges=!0}getGuideNames(){return[...this.guidesList.map(i=>i.name.toLowerCase()),this.getMessage("snkFormConfig.form.mainArea").toLowerCase()]}async componentWillRender(){if(this.messagesBuilder==null){const i=v.getContextValue("__SNK__APPLICATION__");this.messagesBuilder=i.messagesBuilder}}async componentWillLoad(){this.loadFormConfig(),await this.initializeUserConfig()}render(){return n(C,null,n("config-header",{configOptions:this.configOptions,selectedConfig:this.configSelected,messagesBuilder:this.messagesBuilder,hasChanges:this.hasChanges,optionConfigChanged:this.optionConfigChanged,onConfigClose:()=>this.configClose.emit(),onSaveConfig:async()=>await this.handleSaveConfig()}),n("div",{class:"ez-padding--medium"},n("div",{class:"ez-flex sidebarNavigator__container"},n("guides-configurator",{messagesBuilder:this.messagesBuilder,guidesList:this.guidesList,selectedGuide:this.selectedGuide,onGuideSelected:this.handleSelectGuide.bind(this),onGuideListChanged:this.handleGuideListChanged.bind(this),onCreateNewGuide:this.handleCreateNewGuide.bind(this),onGuideDeleted:this.handleGuideDeleted.bind(this)}),n("fields-layout",{ref:i=>this.refFieldsLayout=i,selectedGuide:this.selectedGuide,guideNames:this.getGuideNames(),groupsList:this.groupsList,messagesBuilder:this.messagesBuilder,dataUnit:this.dataUnit,onGuideRenamed:this.handleGuideRenamed.bind(this),onLayoutChanged:this.handleLayoutChanged.bind(this),onSetFieldListAsAvailable:this.handleSetFieldListAsAvailable.bind(this)}),n("fields-selector",{dataUnit:this.dataUnit,availableFields:this.availableFields,onFieldListChanged:this.handleAvailableFieldListChanged.bind(this)}))))}static get watchers(){return{selectedGuide:["observeSelectedGuide"],configManager:["observeConfigManager"]}}};A.style=k;export{D as snk_form,A as snk_form_config};
//# sourceMappingURL=snk-form_2.entry-iLKuurjq.js.map

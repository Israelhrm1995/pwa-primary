import{r as _,c as h,S as f,O as a,A,E as u,h as i,F as m,H as v}from"./index-C7RI_ets.js";import{P as l}from"./PersonalizedFilterUtils-2db38ff2-LzsptIzZ.js";import{P as z,C as o}from"./ConfigStorage-cf578768-CublIU3H.js";import{A as d}from"./FormLayout-DBl2yXij.js";import{a as p,D as c}from"./index-8acbae97-DxLtPl40.js";import{s as g}from"./index-b72af127-CE4mFloS.js";import"./filter-item-type.enum-d45e026f-B41QHsvD.js";import"./form-config-fetcher-e623539b-pWgD_k-d.js";import"./DataFetcher-db08cad0-CbtmavCl.js";import"./PrintUtils-3e4ff0f5-Cz0_nEKM.js";const F=".sc-snk-personalized-filter-h{display:flex;height:100%;padding:var(--space--large, 24px);--snk-personalized-filter--width:100%;--snk-personalized-filter--height:100%;--snk-personalized-filter--background-color-line:var(--color--disable-secondary);--snk-personalized-filter--margin-line:var(--border--radius-medium, 12px)}.snk-personalized-filter.sc-snk-personalized-filter{height:var(--snk-personalized-filter--width);width:var(--snk-personalized-filter--height)}.snk-personalized-filter__header-actions.sc-snk-personalized-filter{display:flex;gap:var(--space--medium)}.snk-personalized-filter__group.sc-snk-personalized-filter{flex:1}.snk-personalized-filter__expression-input--line.sc-snk-personalized-filter{width:100%;height:2px;background-color:var(--snk-personalized-filter--background-color-line);margin-top:var(--snk-personalized-filter--margin-line);margin-bottom:var(--snk-personalized-filter--margin-line)}.ez-box__main.sc-snk-personalized-filter{height:90%}.snk-personalized-filter__button-mode.sc-snk-personalized-filter{height:35px}",M=class{constructor(e){_(this,e),this.ezCancel=h(this,"ezCancel",7),this.ezSave=h(this,"ezSave",7),this.ezAfterSave=h(this,"ezAfterSave",7),this._personalizedFilterFetcher=new z,this._filterMetadataStorage=new Map,this._dataSourceFetcher={fetchData:async t=>{let s=t==null?void 0:t.uri;if(f.isEmpty(s)&&(s=this.entityUri),!this._filterMetadataStorage.has(s)){const n=await this._personalizedFilterFetcher.loadFields(s);this._filterMetadataStorage.set(s,n)}return this._filterMetadataStorage.get(s)}},this._filterAssistentMode=!0,this._filterAssistent=void 0,this.messagesBuilder=void 0,this.entityUri=void 0,this.filterId=void 0,this.configName=void 0,this.resourceID=void 0,this.isDefaultFilter=!1}async createPersonalizedFilter(){const e={name:"",active:!0,expression:"",parameters:[],assistent:{id:f.generateUUID(),items:[{id:f.generateUUID(),entityName:"",fieldName:"",description:"",fieldLabel:"Valor",type:void 0,expression:void 0,operand:void 0,paramVariable:!1,value:void 0,systemConfig:null,userConfig:null}],childrenGroups:[],operand:p.AND}};this.isDefaultFilter&&this.buildDataDefaultFilter(e),this._originalFilterAssistent=a.copy(e),this._filterAssistent=a.copy(e)}loadFilter(e,t){if(!(e==null||t==e||this.resourceID==null)){if(e===c.id){o.loadDefaultFilter(e,this.resourceID,this.configName).then(s=>{const n=this.applyDefaultValues(s);this._filterAssistent=n,this._originalFilterAssistent=a.copy(n),this._filterAssistentMode=this._filterAssistent.hasOwnProperty("assistent")&&this._filterAssistent.assistent!=null});return}o.loadPersonalizedFilter(e,this.resourceID,this.configName).then(s=>{const n=this.applyDefaultValues(s);this._filterAssistent=n,this._originalFilterAssistent=a.copy(n),this._filterAssistentMode=this._filterAssistent.hasOwnProperty("assistent")&&this._filterAssistent.assistent!=null})}}componentWillLoad(){var e;g.get(`filterFieldsDataSource.${this.entityUri}`)==null&&g.set(`filterFieldsDataSource.${this.entityUri}`,this._dataSourceFetcher),this.messagesBuilder||(this._application=A.getContextValue("__SNK__APPLICATION__"),this.messagesBuilder=(e=this._application)===null||e===void 0?void 0:e.messagesBuilder),this.loadFilter(this.filterId,void 0)}componentDidRender(){var e;(e=this._viewStackRef)===null||e===void 0||e.show(this._filterAssistentMode?0:1),this._elButtonMode&&this._elButtonMode.setAttribute(u.DATA_ELEMENT_ID_ATTRIBUTE_NAME,u.getInternalIDInfo(`${this._filterAssistentMode?"advancedMode_ezButton":"assistentMode_ezButton"}`))}buildDataDefaultFilter(e){e.name=c.name,e.id=c.id}getMessage(e,t){return this._application.messagesBuilder.getMessage(e,t)}async saveFilter(){let e;this.isDefaultFilter?e=await o.saveDefaultFilter(this._filterAssistent,this.resourceID,this.configName):e=await o.savePersonalizedFilter(this._filterAssistent,this.resourceID,this.configName),this._elButtonSave.enabled=!1;const t=this._filterAssistent.id?"confirmEdit":"confirmSave";d.info(this.getMessage(`snkPersonalizedFilter.${t}.title`),{iconName:"check"});const s=Object.assign(Object.assign({},e),this._filterAssistent);s.parameters=l.buildVariableParameters(this._filterAssistent.assistent),this._originalFilterAssistent=a.copy(s),this._filterAssistent=a.copy(s),this.ezAfterSave.emit()}removeFilter(){o.removePersonalizedFilter(this._filterAssistent,this.resourceID,this.configName)}hasChangesToSave(){return JSON.stringify(this._filterAssistent)===JSON.stringify(this._originalFilterAssistent)}async handleSave(){if(this._filterAssistentMode){if(!l.validateFields(this._filterAssistent.assistent)||!this._filterAssistent.name)return this._application.error(this.getMessage("snkPersonalizedFilter.error.title"),this.getMessage("snkPersonalizedFilter.error.description"));this.saveAssistentMode()}else{if(!this._filterAssistent.expression||!this._filterAssistent.name)return this._application.error(this.getMessage("snkPersonalizedFilter.error.title"),this.getMessage("snkPersonalizedFilter.error.description"));if(!await this.validateExpressionBeforeSaving())return;this.saveAdvancedMode()}}saveAssistentMode(){const{assistent:e,expression:t}=this._filterAssistent,s=e?l.buildGroupExpression(e):t;this._filterAssistent.expression=s,this.ezSave.emit(s),this.saveFilter()}saveAdvancedMode(){this._originalFilterAssistent.expression!==this._filterAssistent.expression&&this._filterAssistent.assistent?d.confirm(this.getMessage("snkPersonalizedFilter.confirmSaveModeAdvanced.title"),this.getMessage("snkPersonalizedFilter.confirmSaveModeAdvanced.description")).then(e=>{e&&this.saveAndTransformToAdvancedMode()}):this._filterAssistent.assistent?this.saveAssistentMode():this.saveAndTransformToAdvancedMode()}saveAndTransformToAdvancedMode(){this._filterAssistent.assistent=void 0,this.ezSave.emit(this._filterAssistent.expression),this.saveFilter()}async validateExpressionBeforeSaving(){const{valid:e,message:t=""}=await this._personalizedFilterFetcher.validatePersonalizedFilter(this.entityUri,this._filterAssistent.expression);return e||this._application.error(this.getMessage("snkPersonalizedFilter.errorValidation.title"),t.replace(/.*Exception: /,"")),e}handleCancel(){if(this.hasChangesToSave())return this.ezCancel.emit();d.confirm(this.getMessage("snkPersonalizedFilter.confirmCancel.title"),this.getMessage("snkPersonalizedFilter.confirmCancel.description")).then(e=>{var t;e&&(this._filterAssistent=a.copy((t=this._originalFilterAssistent)!==null&&t!==void 0?t:{}),this.ezCancel.emit(),this._elButtonSave.enabled=!1)})}handleTitleChange(e){this._filterAssistent=Object.assign(Object.assign({},this._filterAssistent),{name:e}),this._elButtonSave.enabled=!this.hasChangesToSave()}applyDefaultValues(e){return this.addLabelToItems(e),this.addFilterGroupCondition(e),e}addFilterGroupCondition(e){e.assistent&&!e.assistent.operand&&(e.assistent.operand=p.AND)}addLabelToItems(e){e.assistent&&e.assistent.items&&e.assistent.items.length>0&&e.assistent.items.forEach(t=>{if(t.fieldLabel==null){const s=(e.parameters||[]).find(n=>n.fieldName===t.fieldName);s&&(t.fieldLabel=s.label)}})}handleExpressionChangeAdvancedMode(e){this._filterAssistent=Object.assign(Object.assign({},this._filterAssistent),{expression:e}),this._elButtonSave.enabled=!this.hasChangesToSave()}handleChangeFilterAssistentMode(e){this._elButtonSave.enabled=!this.hasChangesToSave(),this._filterAssistent=Object.assign({},e)}selectField(e){if(!("name"in e))return;const t=this.buildExpression(e.entityName,e.name,e.entityPath);this._elAdvancedMode.querySelector("ez-text-area").appendTextToSelection(t)}buildExpression(e,t,s){return s.length>0&&s.shift(),s.length>0?`${s.join("->")}->${t}`:`${e}.${t}`}onAddField(e){const t=this._elAdvancedMode.querySelector("ez-text-area"),s={horizontalGap:0,verticalGap:12,fromRight:!0};t.setFocus(),e.setBlur(),this._elFilterFieldSearch&&this._elFilterFieldSearch.show(e,s)}renderButtonAddField(){if(!this._filterAssistentMode)return i(m,null,i("ez-button",{class:"snk-personalized-filter__button-mode",label:this.getMessage("snkPersonalizedFilter.info.addField"),enabled:!0,onClick:e=>this.onAddField(e.target)},i("ez-icon",{class:"ez-padding-right--small",slot:"leftIcon",iconName:"plus"})),i("snk-filter-field-search",{class:"ez-padding-left--medium",ref:e=>this._elFilterFieldSearch=e,onEzSelectFilterItem:e=>this.selectField(e.detail),fieldsDataSource:this._dataSourceFetcher}))}buildContainerPersonalizedFilter(){return i("ez-view-stack",{ref:e=>this._viewStackRef=e},i("stack-item",null,this._filterAssistentMode&&i("snk-filter-assistent-mode",{filterAssistent:this._filterAssistent,messagesBuilder:this.messagesBuilder,filterId:this.filterId,entityUri:this.entityUri,application:this._application,onEzChangeFilter:e=>this.handleChangeFilterAssistentMode(e.detail),isDefaultFilter:this.isDefaultFilter})),i("stack-item",null,i("snk-filter-advanced-mode",{ref:e=>this._elAdvancedMode=e,filterAssistent:this._filterAssistent,application:this._application,onEzExpressionChange:e=>this.handleExpressionChangeAdvancedMode(e.detail)})))}handleModeChange(){var e,t;if(this._filterAssistentMode)d.confirm(this.getMessage("snkPersonalizedFilter.confirmChangeModeAssistent.title"),this.getMessage("snkPersonalizedFilter.confirmChangeModeAssistent.description")).then(s=>{if(s&&(this._filterAssistentMode=!this._filterAssistentMode,!this.hasChangesToSave())){const n=l.buildGroupExpression(this._filterAssistent.assistent);this._filterAssistent.expression=n,this._elButtonSave.enabled=!this.hasChangesToSave()}});else if(((e=this._filterAssistent)===null||e===void 0?void 0:e.expression)===((t=this._originalFilterAssistent)===null||t===void 0?void 0:t.expression))this._filterAssistentMode=!this._filterAssistentMode;else{const s=this._filterAssistent.expression,n=l.buildGroupExpression(this._filterAssistent.assistent);s!==n?d.confirm(this.getMessage("snkPersonalizedFilter.confirmChangeModeAdvanced.title"),this.getMessage("snkPersonalizedFilter.confirmChangeModeAdvanced.description")).then(r=>{r&&(this._filterAssistent=Object.assign(Object.assign({},this._filterAssistent),{expression:n}),this._filterAssistentMode=!this._filterAssistentMode)}):this._filterAssistentMode=!this._filterAssistentMode}}buildTitle(){return this.isDefaultFilter&&!this.filterId?this.getMessage("snkPersonalizedFilter.info.titleCreateDefault"):this.isDefaultFilter&&this.filterId?this.getMessage("snkPersonalizedFilter.info.titleEditDefault"):this.filterId?this.getMessage("snkPersonalizedFilter.info.titleEdit"):this.getMessage("snkPersonalizedFilter.info.titleAdd")}render(){var e,t,s,n;if(!(!(!((e=this._filterAssistent)===null||e===void 0)&&e.assistent)&&this._filterAssistentMode))return i(v,null,i("div",{class:"snk-personalized-filter"},i("div",null,i("snk-simple-bar",{label:this.buildTitle(),onExit:()=>this.handleCancel()},i("div",{class:"snk-personalized-filter__header-actions",slot:"rightSlot"},i("ez-button",{size:"small",label:this.getMessage("snkPersonalizedFilter.info.labelCancel"),onClick:()=>this.handleCancel()}),i("ez-button",{size:"small",ref:r=>this._elButtonSave=r,enabled:!1,class:"ez-button--primary",label:this.getMessage("snkPersonalizedFilter.info.labelSave"),onClick:this.handleSave.bind(this)})))),i("div",{class:"ez-box ez-margin-bottom--medium ez-box__main"},i("div",{class:"ez-box__container"},i("div",{class:"ez-flex ez-flex--column ez-size-width--full"},i("div",{class:"ez-flex"},i("ez-tooltip",{message:this.getMessage("snkPersonalizedFilter.info.textInputDisabled"),active:this.isDefaultFilter},i("ez-text-input",{class:"ez-padding-right--medium",label:this.getMessage("snkPersonalizedFilter.info.labelNameFilter"),value:(t=this._filterAssistent)===null||t===void 0?void 0:t.name,onEzChange:r=>this.handleTitleChange(r.detail),enabled:!this.isDefaultFilter})),this.renderButtonAddField(),i("ez-button",{ref:r=>this._elButtonMode=r,class:"snk-personalized-filter__button-mode",label:this._filterAssistentMode?this.getMessage("snkPersonalizedFilter.info.activeModeAdvanced"):this.getMessage("snkPersonalizedFilter.info.activeModeAssistent"),onClick:()=>this.handleModeChange(),"data-tooltip":this._filterAssistentMode||!((s=this._filterAssistent)===null||s===void 0)&&s.assistent?void 0:this.getMessage("snkPersonalizedFilter.info.tooltipDisabledAssistentMode"),"data-flow":"bottom",enabled:!this._filterAssistent.name||!!(this._filterAssistentMode||!((n=this._filterAssistent)===null||n===void 0)&&n.assistent)})),this.buildContainerPersonalizedFilter())))))}static get watchers(){return{filterId:["loadFilter"]}}};M.style=F;export{M as snk_personalized_filter};
//# sourceMappingURL=snk-personalized-filter.entry-BjeYCoGU.js.map
